

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/2.png">
  <link rel="icon" href="/img/2.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="淡黄的cherry">
  <meta name="keywords" content="">
  <meta name="referrer" content="no-referrer">
  
    <meta name="description" content="1、架构图 2、组件Prometheus Server用于收集和存储时间序列数据。Prometheus Server 是 Prometheus 组件中的核心部分，负责实现对监控数据的获取，存储以及查询。 Prometheus Server 可以通过静态配置管理监控目标，也可以配合使用 Service Discovery 的方式动态管理监控目标，并从这些监控目标中获取数据。其次 Prometheus">
<meta property="og:type" content="article">
<meta property="og:title" content="prometheus+Grafana+k8s全方位教学">
<meta property="og:url" content="http://example.com/2025/04/16/prometheus-Grafana-k8s%E5%85%A8%E6%96%B9%E4%BD%8D%E6%95%99%E5%AD%A6/index.html">
<meta property="og:site_name" content="cherry">
<meta property="og:description" content="1、架构图 2、组件Prometheus Server用于收集和存储时间序列数据。Prometheus Server 是 Prometheus 组件中的核心部分，负责实现对监控数据的获取，存储以及查询。 Prometheus Server 可以通过静态配置管理监控目标，也可以配合使用 Service Discovery 的方式动态管理监控目标，并从这些监控目标中获取数据。其次 Prometheus">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/ljh00928/csdn/raw/master/img/39b97ead427144628582592e0c502bcd.png">
<meta property="og:image" content="https://gitee.com/ljh00928/csdn/raw/master/img/781412229a9249699bcf56555933b72f.png">
<meta property="og:image" content="https://gitee.com/ljh00928/csdn/raw/master/img/89dcebbc6a794cdd9ce03c819b5ff35c.png">
<meta property="og:image" content="https://gitee.com/ljh00928/csdn/raw/master/img/45133fff7e4146bf9b3b4a7e6b975270.png">
<meta property="og:image" content="https://gitee.com/ljh00928/csdn/raw/master/img/69aff8fdd139453da62a7f029ce5fdb1.png">
<meta property="og:image" content="https://gitee.com/ljh00928/csdn/raw/master/img/96440f22bc744cf98ef6b9a796e7e8e6.png">
<meta property="og:image" content="https://gitee.com/ljh00928/csdn/raw/master/img/849314b2241045a28049f184cabcafcd.png">
<meta property="og:image" content="https://gitee.com/ljh00928/csdn/raw/master/img/32037fdf1cc2467fa22574fc36677118.png">
<meta property="og:image" content="https://gitee.com/ljh00928/csdn/raw/master/img/2218c681c0de4de39e80bc63a92c4ed0.png">
<meta property="og:image" content="https://gitee.com/ljh00928/csdn/raw/master/img/2aee5db9f02445a4b4bbebe06cad4744.png">
<meta property="og:image" content="https://gitee.com/ljh00928/csdn/raw/master/img/0af2d0c02ef44fbfab2c39a58387bd87.png">
<meta property="og:image" content="https://gitee.com/ljh00928/csdn/raw/master/img/26cbfe2310e248c59a3e22826211db12.png">
<meta property="og:image" content="https://gitee.com/ljh00928/csdn/raw/master/img/85bfa65bb4094b33b86d2302c22c293f.png">
<meta property="og:image" content="https://gitee.com/ljh00928/csdn/raw/master/img/5bbee7effec2429ca77dd12340f75053.png">
<meta property="article:published_time" content="2025-04-16T08:34:12.000Z">
<meta property="article:modified_time" content="2025-04-16T08:34:42.152Z">
<meta property="article:author" content="淡黄的cherry">
<meta property="article:tag" content="监控篇">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://gitee.com/ljh00928/csdn/raw/master/img/39b97ead427144628582592e0c502bcd.png">
  
  
  
  <title>prometheus+Grafana+k8s全方位教学 - cherry</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/macpanel.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong class="navbar-title">cherryの技术文档</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/1.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="prometheus+Grafana+k8s全方位教学"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-04-16 16:34" pubdate>
          2025年4月16日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          11k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          94 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">prometheus+Grafana+k8s全方位教学</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="1、架构图"><a href="#1、架构图" class="headerlink" title="1、架构图"></a>1、架构图</h2><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/39b97ead427144628582592e0c502bcd.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h2 id="2、组件"><a href="#2、组件" class="headerlink" title="2、组件"></a>2、组件</h2><p><strong>Prometheus Server</strong><br>用于收集和存储时间序列数据。Prometheus Server 是 Prometheus 组件中的核心部分，负责实现对监控数据的获取，存储以及查询。 Prometheus Server 可以通过静态配置管理监控目标，也可以配合使用 Service Discovery 的方式动态管理监控目标，并从这些监控目标中获取数据。其次 Prometheus Server 需要对采集到的监控数据进行存储，Prometheus Server 本身就是一个时序数据库，将采集到的监控数据按照时间序列的方式存储在本地磁盘当中。最后Prometheus Server 对外提供了自定义的 PromQL 语言，实现对数据的查询以及分析。</p>
<p><strong>Exporter</strong><br>用于暴露已有的第三方服务的 metrics 给 Prometheus。Exporter 将监控数据采集的端点通过 HTTP 服务的形式暴露给 Prometheus Server，Prometheus Server 通过访问该 Exporter 提供的 Endpoint 端点，即可获取到需要采集的监控数据。</p>
<p><strong>Push Gateway</strong><br>主要用于短期的 jobs。由于这类 jobs 存在时间较短，可能在 Prometheus 来 pull 之前就消失了。为此，这些 jobs 可以直接向 Prometheus server 端推送它们的 metrics。</p>
<p><strong>Grafana</strong><br>第三方展示工具，可以编写 PromQL 查询语句，通过 http 协议与 prometheus 集成。</p>
<p><strong>AlertManager</strong><br>从 Prometheus Server 端接收到 alerts 后，会进行去除重复数据，分组，并路由到对方的接受方式，发出报警。常见的接收方式有：电子邮件，钉钉、企业微信，pagerduty等。</p>
<p><strong>Client Library</strong><br>客户端库，为需要监控的服务生成相应的 metrics 并暴露给 Prometheus Server。当 Prometheus Server 来 pull 时，直接返回实时状态的 metrics。</p>
<pre><code class="hljs">  监控流程：
      1.exporter节点暴露监控指标;
      2.Prometheus server修改配置文件监控暴露节点;
      3.重载配置检查WebUI;
      4.grafana出图展示;
</code></pre>
<h2 id="3、prometheus部署"><a href="#3、prometheus部署" class="headerlink" title="3、prometheus部署"></a>3、prometheus部署</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">下载Prometheus的软件包<br>[root@prometheus-server31 ~]# wget https://github.com/prometheus/prometheus/releases/download/v2.53.2/prometheus-2.53.2.linux-amd64.tar.gz<br><br>上传普罗米修斯部署脚本（需要脚本可后台留言~）<br>[root@prometheus-server31 ~]# tar xf install-prometheus-server.tar.gz <br><br>安装<br>[root@prometheus-server31 ~]# ./install-prometheus-server.sh i<br></code></pre></td></tr></table></figure>

<h2 id="4、node-exporter环境搭建"><a href="#4、node-exporter环境搭建" class="headerlink" title="4、node-exporter环境搭建"></a>4、node-exporter环境搭建</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">下载软件包 <br>[root@prometheus-node41 ~]# wget https://github.com/prometheus/node_exporter/releases/download/v1.8.2/node_exporter-1.8.2.linux-amd64.tar.gz<br><br>脚本一键部署node-exporter（需要脚本后台留言~）<br>[root@prometheus-node41 ~]# tar xf install-node-exporter.tar.gz <br><br>安装服务 <br>[root@prometheus-node41 ~]# ./install-node-exporter.sh i<br></code></pre></td></tr></table></figure>

<h2 id="5、Prometheus-server监控node-exporter实战"><a href="#5、Prometheus-server监控node-exporter实战" class="headerlink" title="5、Prometheus server监控node-exporter实战"></a>5、Prometheus server监控node-exporter实战</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.修改Prometheus server的配置文件监控node-exporter节点 <br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br><span class="hljs-comment"># 修改通用全局配置</span><br>global:<br>  <span class="hljs-comment"># Prometheus server抓取数据的间隔时间，默认值为1分钟</span><br>  scrape_interval: 3s <br>  <br>...<br><span class="hljs-comment"># 定义抓取配置</span><br>scrape_configs:<br>  	...(添加如下信息)<br>	<br>    <span class="hljs-comment"># 自定义任务的名称</span><br>  - job_name: node-exporters<br>    <span class="hljs-comment"># 指定采集指标时访问的路径</span><br>    metrics_path: /metrics<br>    <span class="hljs-comment"># 指定采集指标时使用的协议</span><br>    scheme: http<br>    <span class="hljs-comment"># 指定被监控的node-exporter节点列表</span><br>    static_configs:<br>    - targets:<br>      - 10.0.0.41:9100<br>      - 10.0.0.42:9100<br>      - 10.0.0.43:9100<br><br><br>2.检查配置文件语法是否正确 <br>[root@prometheus-server31 ~]# /softwares/prometheus-2.53.2.linux-amd64/promtool check config  /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br><br>3.Prometheus server加载配置文件<br>[root@prometheus-server31 ~]# curl -X POST 10.0.0.31:9090/-/reload<br><br>4.给检查和加载配置文件起别名<br>[root@prometheus-server31 ~]# vim ~/.bashrc <br>...<br><span class="hljs-built_in">alias</span> rr=<span class="hljs-string">&#x27;curl -X POST 10.0.0.31:9090/-/reload&#x27;</span><br><span class="hljs-built_in">alias</span> check=<span class="hljs-string">&#x27;/softwares/prometheus-2.53.2.linux-amd64/promtool check config  /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml&#x27;</span><br><br>[root@prometheus-server31 ~]# <span class="hljs-built_in">source</span>  ~/.bashrc <br><br>5.查看Prometheus的WebUI验证节点是否加入成功<br>http://10.0.0.31:9090/targets<br><br>6..查看Prometheus的指标数据<br>node_cpu_seconds_total<br></code></pre></td></tr></table></figure>

<h2 id="6、PQL"><a href="#6、PQL" class="headerlink" title="6、PQL"></a>6、PQL</h2><p>prometheus监控中采集过来的数据统一称为Metrics数据，其并不是代表具体的数据格式，而是一种统计度量计算单位。</p>
<p>当我们需要为某个系统或者某个服务做监控时，就需要使用到metrics。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">前提条件: (所有节点时区同步)<br><span class="hljs-built_in">ln</span> -svf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <br></code></pre></td></tr></table></figure>

<h4 id="体验promql"><a href="#体验promql" class="headerlink" title="体验promql"></a><strong>体验promql</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 查看某个特定的key<br>node_cpu_seconds_total<br><br>2 查看某个节点的指标<br>node_cpu_seconds_total&#123;instance=<span class="hljs-string">&quot;10.0.0.41:9100&quot;</span>&#125;<br><br>3 查看某个节点的某刻CPU的某种状态<br>node_cpu_seconds_total&#123;instance=<span class="hljs-string">&quot;10.0.0.41:9100&quot;</span>,cpu=<span class="hljs-string">&quot;0&quot;</span>,mode=<span class="hljs-string">&quot;idle&quot;</span>&#125;<br><br>4 查询最近10s内某个节点CPU的某种状态时间<br>node_cpu_seconds_total&#123;instance=<span class="hljs-string">&quot;10.0.0.41:9100&quot;</span>,cpu=<span class="hljs-string">&quot;0&quot;</span>,mode=<span class="hljs-string">&quot;idle&quot;</span>&#125;[10s]<br><br>5 统计1分钟内，使用标签过滤器查看<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>节点的第0颗CPU，非空闲状态使用的总时间<br>node_cpu_seconds_total&#123;mode!=<span class="hljs-string">&quot;idle&quot;</span>,cpu=<span class="hljs-string">&quot;0&quot;</span>, instance=<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>&#125;[1m]<br><br>6 统计1分钟内，使用标签过滤器查看<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>节点的第0颗CPU，mode名称以字母<span class="hljs-string">&quot;i&quot;</span>开头的所有CPU核心。<br>node_cpu_seconds_total&#123;mode=~<span class="hljs-string">&quot;i.*&quot;</span>,cpu=<span class="hljs-string">&quot;0&quot;</span>, instance=<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>&#125;[1m]<br><br>7 统计1分钟内，使用标签过滤器查看<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>节点的第0颗CPU，mode名称不是以字母<span class="hljs-string">&quot;i&quot;</span>开头的所有CPU核心。<br>node_cpu_seconds_total&#123;mode!~<span class="hljs-string">&quot;i.*&quot;</span>,cpu=<span class="hljs-string">&quot;0&quot;</span>, instance=<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>&#125;[1m]<br><br></code></pre></td></tr></table></figure>

<h4 id="Prometheus常用的函数"><a href="#Prometheus常用的函数" class="headerlink" title="Prometheus常用的函数"></a><strong>Prometheus常用的函数</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 increase函数: 用来针对counter数据类型，截取其中一段时间总的增量。		<br>举个例子:<br>   increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&quot;idle&quot;</span>,cpu=<span class="hljs-string">&quot;0&quot;</span>, instance=<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>&#125;[1m])<br>		统计1分钟内，使用标签过滤器查看<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>节点的第0颗CPU，空闲状态使用的总时间增量。<br><br>2 <span class="hljs-built_in">sum</span>函数: 加和的作用。<br>举个例子:<br> <span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&quot;idle&quot;</span>,cpu=<span class="hljs-string">&quot;0&quot;</span>&#125;[1m]))<br>		统计1分钟内，使用标签过滤器查看所有节点的第0颗CPU，空闲状态使用的总时间增量，并将返回结果累加。<br><br>3 by函数: 将数据进行分组，类似于MySQL的<span class="hljs-string">&quot;GROUP BY&quot;</span>。<br>举个例子:<br>	<span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&quot;idle&quot;</span>&#125;[1m])) by (instance)<br>		统计1分钟内，使用标签过滤器查看CPU空闲状态，并将结果进行累加，基于instance进行分组。<br><br>4 rate函数: 它的功能是按照设置的时间段，取counter在这个时间段中平均每秒的增量。<br>举个例子:<br>	rate(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&quot;idle&quot;</span>,cpu=<span class="hljs-string">&quot;0&quot;</span>, instance=<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>&#125;[1m])<br>		统计1分钟内，使用标签过滤器查看<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>节点的第0颗CPU，空闲状态使用的每秒的增量。<br>		<br>increase和rate如何选择:<br>	(1)对于采集数据频率较低的场景建议使用increase函数，因为使用rate函数可能会出现断点,比如针对硬盘容量监控。<br>	(2)对于采集数据频率较高的场景建议使用rate函数，比如针对CPU，内存，网络流量等都是可以基于rate函数来采集等。<br>	<br>5 topk函数: 取前几位的最高值，实际使用的时候一般会用该函数进行瞬时报警，而不是为了观察曲线图。<br>举个例子:<br>	topk(3, rate(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&quot;idle&quot;</span>&#125;[1m]))<br>		统计1分钟内，使用标签过滤器查看CPU，所有状态使用的每秒的增量，只查看前3个节点。<br><br>6 count函数:<br>	把数值符合条件的，输出数目进行累加加和。<br>	比如说企业中有100台服务器，如果只有10台服务器CPU使用率高于80%时候是不需要报警的，但是数量操作70台时就需要报警了。<br>	<br>举个例子:<br>	count(tcp_wait_conn &gt; 500):<br>		假设(tcp_wait_conn是咱们自定义的KEY。<br>		若TCP等待数量大于500的机器数量就判断条件为真。<br><br>	count(rate(node_cpu_seconds_total&#123;cpu=<span class="hljs-string">&quot;0&quot;</span>,mode=<span class="hljs-string">&quot;idle&quot;</span>&#125;[1m]))<br>		对统计的结果进行计数。<br><br>7 其他函数  https://prometheus.io/docs/prometheus/latest/querying/functions/	<br></code></pre></td></tr></table></figure>

<h4 id="监控CPU的使用情况案例"><a href="#监控CPU的使用情况案例" class="headerlink" title="监控CPU的使用情况案例"></a>监控CPU的使用情况案例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 统计各个节点CPU的使用率<br>		1.1 我们需要先找到CPU相关的KEY<br>node_cpu_seconds_total<br><br>		1.2 过滤出CPU的空闲时间(&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;)和全部CPU的时间(<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>)<br>node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;<br>	过滤CPU的空闲时间。<br>	<br>node_cpu_seconds_total&#123;&#125;<br>	此处的<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>可以不写，因为里面没有任何参数，代表获取CPU的所有状态时间。<br>	<br>		1.3 统计1分钟内CPU的增量时间<br>increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;[1m])<br>	统计1分钟内CPU空闲状态的增量。<br>	<br>increase(node_cpu_seconds_total[1m])<br>	统计1分钟内CPU所有状态的增量。<br>	<br>		1.4 将结果进行加和统计<br><span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;[1m]))<br>	将1分钟内所有CPU空闲时间的增量进行加和计算。<br>	<br><span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total[1m]))<br>	将1分钟内所有CPU空闲时间的增量进行加和计算。<br>	<br>		1.5 按照不同节点进行分组<br><span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;[1m])) by (instance)<br>	将1分钟内所有CPU空闲时间的增量进行加和计算，并按照机器实例进行分组。<br>	<br><span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total[1m])) by (instance)<br>	将1分钟内所有CPU空闲时间的增量进行加和计算，并按照机器实例进行分组。<br>	<br>		1.6 计算1分钟内CPU空闲时间的百分比<br><span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;[1m])) by (instance) / <span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total[1m])) by (instance)<br><br>		1.7 统计1分钟内CPU的使用率，计算公式: (1 - CPU空闲时间的百分比) * 100%。<br>(1 - <span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;[1m])) by (instance) / <span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total[1m])) by (instance)) * 100<br><br>		1.7 统计1小时内CPU的使用率，计算公式: (1 - CPU空闲时间的百分比) * 100%。<br>(1 - <span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;idle&#x27;</span>&#125;[1h])) by (instance) / <span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total[1h])) by (instance)) * 100<br><br><br>2 计算CPU用户态的1分钟内百分比<br><span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;user&#x27;</span>&#125;[1m])) by (instance) / <span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total[1m])) by (instance) * 100<br><br>3 计算CPU内核态的1分钟内百分比<br>(<span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;system&#x27;</span>&#125;[1m])) by (instance) / <span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total[1m])) by (instance)) * 100<br><br>4 计算CPU IO等待时间的1分钟内百分比<br>(<span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;iowait&#x27;</span>&#125;[1m])) by (instance) / <span class="hljs-built_in">sum</span>(increase(node_cpu_seconds_total[1m])) by (instance)) * 100<br></code></pre></td></tr></table></figure>

<h2 id="7、grafana"><a href="#7、grafana" class="headerlink" title="7、grafana"></a>7、grafana</h2><h4 id="grafana部署"><a href="#grafana部署" class="headerlink" title="grafana部署"></a>grafana部署</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">1. 下载grafana<br>wget https://dl.grafana.com/enterprise/release/grafana-enterprise_11.1.4_amd64.deb<br><br>2.安装grafana<br>[root@prometheus-server31 ~]# apt-get install -y adduser libfontconfig1 musl<br>[root@prometheus-server31 ~]# <br>[root@prometheus-server31 ~]# dpkg -i grafana-enterprise_11.1.4_amd64.deb<br><br>3.启动grafana <br>[root@prometheus-server31 ~]# systemctl <span class="hljs-built_in">enable</span> --now grafana-server<br>[root@prometheus-server31 ~]# <br>[root@prometheus-server31 ~]# ss -ntl | grep 3000<br>LISTEN 0      4096               *:3000            *:*    <br><br>4.访问grafana的WebUI<br>http://10.0.0.31:3000/login<br>- 1.初始化的用户名和密码均为: admin <br></code></pre></td></tr></table></figure>

<p><strong>配置Prometheus的数据源</strong></p>
<p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/781412229a9249699bcf56555933b72f.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/89dcebbc6a794cdd9ce03c819b5ff35c.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/45133fff7e4146bf9b3b4a7e6b975270.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p><strong>添加服务端地址</strong><br><img src="https://gitee.com/ljh00928/csdn/raw/master/img/69aff8fdd139453da62a7f029ce5fdb1.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br><img src="https://gitee.com/ljh00928/csdn/raw/master/img/96440f22bc744cf98ef6b9a796e7e8e6.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p><strong>导入样板</strong><br><img src="https://gitee.com/ljh00928/csdn/raw/master/img/849314b2241045a28049f184cabcafcd.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p><strong>选择样板id</strong><br><img src="https://gitee.com/ljh00928/csdn/raw/master/img/32037fdf1cc2467fa22574fc36677118.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p><strong>选择数据源</strong></p>
<p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/2218c681c0de4de39e80bc63a92c4ed0.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p><strong>配置grafana展示node-exporter数据</strong><br><img src="https://gitee.com/ljh00928/csdn/raw/master/img/2aee5db9f02445a4b4bbebe06cad4744.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h4 id="grafana自定义dashboard"><a href="#grafana自定义dashboard" class="headerlink" title="grafana自定义dashboard"></a>grafana自定义dashboard</h4><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/0af2d0c02ef44fbfab2c39a58387bd87.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h4 id="grafana实现备份和恢复"><a href="#grafana实现备份和恢复" class="headerlink" title="grafana实现备份和恢复"></a>grafana实现备份和恢复</h4><p>保存json文件，恢复的时候可粘贴内容或者导入文件</p>
<h2 id="8、联邦模式"><a href="#8、联邦模式" class="headerlink" title="8、联邦模式"></a>8、联邦模式</h2><p>默认情况下，prometheus采集的数据会存储到本地，这意味者prometheus在这种工作模式下，可能会存在单机存储的瓶颈。</p>
<ul>
<li><p>为了解决prometheus对于数据的采集压力，我们可以采用联邦模式来部署prometheus</p>
</li>
<li><p>所谓联邦模式就是部署多个server共同采集数据</p>
</li>
</ul>
<h4 id="联邦架构图"><a href="#联邦架构图" class="headerlink" title="联邦架构图"></a><strong>联邦架构图</strong></h4><p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/26cbfe2310e248c59a3e22826211db12.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h4 id="部署联邦模式"><a href="#部署联邦模式" class="headerlink" title="部署联邦模式"></a><strong>部署联邦模式</strong></h4><p>1.修改prometheus server32配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">修改prometheus server配置文件<br>[root@prometheus-server32 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>scrape_configs:<br>  ...<br><br>  - job_name: <span class="hljs-string">&#x27;file-service-discovery-32&#x27;</span><br>    static_configs:<br>    - targets:<br>      - <span class="hljs-string">&quot;10.0.0.41:9100&quot;</span><br><br>重载prometheus server<br>[root@prometheus-server32 ~]# curl -X POST http://10.0.0.32:9090/-/reload<br><br>验证数据是否采集成功<br>http://10.0.0.32:9090/targets<br></code></pre></td></tr></table></figure>

<p>2.修改prometheus server33配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">修改prometheus server的配置文件<br>[root@prometheus-server33 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br><br>...<br>scrape_configs:<br>  ...<br>  - job_name: <span class="hljs-string">&#x27;file-service-discovery-33&#x27;</span><br>    static_configs:<br>    - targets:<br>      - <span class="hljs-string">&quot;10.0.0.42:9100&quot;</span><br>	  - <span class="hljs-string">&quot;10.0.0.43:9100&quot;</span><br><br>重载prometheus server<br>[root@prometheus-server33 ~]# curl -X POST http://10.0.0.33:9090/-/reload<br><br>验证数据是否采集成功<br>http://10.0.0.33:9090/targets<br></code></pre></td></tr></table></figure>

<p>3.修改Prometheus server31配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">修改prometheus server的配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>scrape_configs:<br>  ...<br>  - job_name: <span class="hljs-string">&quot;prometheus-federate-32&quot;</span><br>    metrics_path: <span class="hljs-string">&quot;/federate&quot;</span><br>    <span class="hljs-comment"># 用于解决标签的冲突问题，有效值为: true和false，默认值为false</span><br>    <span class="hljs-comment"># 当设置为true时，将保留抓取的标签以忽略服务器自身的标签。说白了会覆盖原有标签。</span><br>    <span class="hljs-comment"># 当设置为false时，则不会覆盖原有标签，而是在标点前加了一个&quot;exported_&quot;前缀。</span><br>    honor_labels: <span class="hljs-literal">true</span><br>    params:<br>       <span class="hljs-string">&quot;match[]&quot;</span>:<br>       - <span class="hljs-string">&#x27;&#123;job=&quot;promethues&quot;&#125;&#x27;</span><br>       - <span class="hljs-string">&#x27;&#123;__name__=~&quot;job:.*&quot;&#125;&#x27;</span><br>       - <span class="hljs-string">&#x27;&#123;__name__=~&quot;node.*&quot;&#125;&#x27;</span><br>    static_configs:<br>    - targets:<br>        - <span class="hljs-string">&quot;10.0.0.32:9090&quot;</span><br><br>  - job_name: <span class="hljs-string">&quot;prometheus-federate-33&quot;</span><br>    metrics_path: <span class="hljs-string">&quot;/federate&quot;</span><br>    honor_labels: <span class="hljs-literal">true</span><br>    params:<br>       <span class="hljs-string">&quot;match[]&quot;</span>:<br>       - <span class="hljs-string">&#x27;&#123;job=&quot;promethues&quot;&#125;&#x27;</span><br>       - <span class="hljs-string">&#x27;&#123;__name__=~&quot;job:.*&quot;&#125;&#x27;</span><br>       - <span class="hljs-string">&#x27;&#123;__name__=~&quot;node.*&quot;&#125;&#x27;</span><br>    static_configs:<br>    - targets:<br>        - <span class="hljs-string">&quot;10.0.0.33:9090&quot;</span><br><br>检查配置文件语法<br>[root@prometheus-server31 ~]# check <br><br>重载prometheus server<br>[root@prometheus-server31 ~]# rr<br><br>验证数据是否采集成功<br>http://10.0.0.31:9090/targets<br><br></code></pre></td></tr></table></figure>



<h2 id="9、监控流程"><a href="#9、监控流程" class="headerlink" title="9、监控流程"></a>9、监控流程</h2><p>普罗米修斯监控可分为两类，云原生应用和非云原生应用。</p>
<p>云原生应用提供metrics，不需要安装exporters客户端，直接修改配置文件即可</p>
<p>非云原生应用需要安装exportes客户端，并启动客户端，服务端yaml文件加入客户端ip和端口</p>
<h2 id="10、监控zookeeper集群"><a href="#10、监控zookeeper集群" class="headerlink" title="10、监控zookeeper集群"></a>10、监控zookeeper集群</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash">修改zookeeper集群的配置文件<br>[root@elk91 ~]# vim /softwares/apache-zookeeper-3.8.4-bin/conf/zoo.cfg <br>...<br><span class="hljs-comment"># https://prometheus.io Metrics Exporter</span><br>metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider<br>metricsProvider.httpHost=0.0.0.0<br>metricsProvider.httpPort=7000<br>metricsProvider.exportJvmInfo=<span class="hljs-literal">true</span><br>...           <br>[root@elk91 ~]# systemctl restart zk<br><br>测试服务是否正常<br>[root@elk91 ~]# <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> `<span class="hljs-built_in">seq</span> 91 93`; <span class="hljs-keyword">do</span> <span class="hljs-built_in">echo</span> <span class="hljs-built_in">stat</span> | nc 10.0.0.<span class="hljs-variable">$i</span> 2181 | grep Mode;<span class="hljs-keyword">done</span><br>Mode: follower<br>Mode: leader<br>Mode: follower<br><br>访问webUI<br>http://10.0.0.91:7000/metrics<br><br>Prometheus server配置监控zookeeper集群<br>[root@prometheus-server31 ~]# <span class="hljs-built_in">tail</span> -6 /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>  - job_name: zookeeper<br>    static_configs:<br>    - targets:<br>      - 10.0.0.91:7000<br>      - 10.0.0.92:7000<br>      - 10.0.0.93:7000<br>[root@prometheus-server31 ~]# <br>[root@prometheus-server31 ~]# check<br>重载服务<br>[root@prometheus-server31 ~]# rr<br><br>访问Prometheus的WebUI进行验证<br>http://10.0.0.31:9090/targets<br><br>grafana导入模板<br>10465<br></code></pre></td></tr></table></figure>



<h2 id="11、客户端下载地址"><a href="#11、客户端下载地址" class="headerlink" title="11、客户端下载地址"></a>11、客户端下载地址</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">监控应用的流程Prometheus<br>https://prometheus.io/docs/instrumenting/exporters/<br></code></pre></td></tr></table></figure>



<h2 id="12、监控elasticsearch集群"><a href="#12、监控elasticsearch集群" class="headerlink" title="12、监控elasticsearch集群"></a>12、监控elasticsearch集群</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.下载elasticsearch exporter<br>https://github.com/prometheus-community/elasticsearch_exporter/releases/download/v1.7.0/elasticsearch_exporter-1.7.0.linux-amd64.tar.gz<br><br>2.解压软件包 <br>[root@elk91 ~]# tar xf elasticsearch_exporter-1.7.0.linux-amd64.tar.gz <br><br>3.启动测试<br>[root@elk91 elasticsearch_exporter-1.7.0.linux-amd64]# ./elasticsearch_exporter --es.uri=<span class="hljs-string">&quot;http://elastic:123456@10.0.0.93:9200&quot;</span> --web.listen-address=:9114 --web.telemetry-path=<span class="hljs-string">&quot;/metrics&quot;</span> <br><br>4.Prometheus server监控es的exporter<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br><br>  - job_name: elasticsearch<br>    static_configs:<br>    - targets:<br>      - 10.0.0.91:9114<br>      <br>[root@prometheus-server31 ~]# rr<br><br>5.查看Prometheus的WebUI是否监控到目标<br>http://10.0.0.31:9090/targets<br><br>6.grafana出图展示<br>14191<br></code></pre></td></tr></table></figure>



<h2 id="13、监控kafka集群"><a href="#13、监控kafka集群" class="headerlink" title="13、监控kafka集群"></a>13、监控kafka集群</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.启动kafka集群<br>[root@elk91 ~]# kafka-server-start.sh -daemon <span class="hljs-variable">$KAFKA_HOME</span>/config/server.properties <br><br>[root@elk92 ~]# kafka-server-start.sh -daemon <span class="hljs-variable">$KAFKA_HOME</span>/config/server.properties <br><br>[root@elk93 ~]# kafka-server-start.sh -daemon <span class="hljs-variable">$KAFKA_HOME</span>/config/server.properties <br><br>2.验证kafka服务是否正常<br>[root@elk91 ~]# zkCli.sh <span class="hljs-built_in">ls</span> /kafka371/brokers/ids  | grep <span class="hljs-string">&quot;^\[&quot;</span><br><br>3.下载kafka的exporter<br>wget https://github.com/danielqsj/kafka_exporter/releases/download/v1.7.0/kafka_exporter-1.7.0.linux-amd64.tar.gz<br><br>4.解压目录中指定文件kafka_exporter到指定路径<br>[root@elk91 ~]# tar xf  kafka_exporter-1.7.0.linux-amd64.tar.gz -C /usr/local/bin/ kafka_exporter-1.7.0.linux-amd64/kafka_exporter  --strip-components=1<br><br>5.启动 kafka_exporter<br>[root@elk91 ~]# kafka_exporter --web.listen-address=<span class="hljs-string">&quot;:9308&quot;</span> --web.telemetry-path=<span class="hljs-string">&quot;/metrics&quot;</span>  --kafka.version=<span class="hljs-string">&quot;3.7.1&quot;</span> --kafka.server=10.0.0.93:9092<br><br>6.访问测试kafka的exporter页面<br>http://10.0.0.91:9308/metrics<br><br>7.Prometheus配置监控kafka的exporter<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>  - job_name: kafka<br>    static_configs:<br>    - targets:<br>      - 10.0.0.91:9308<br>  <br>[root@prometheus-server31 ~]# rr<br><br>8.查看Prometheus的WebUI是否监控到目标<br>http://10.0.0.31:9090/targets<br><br>9.grafana出图展示<br>12460<br><br>9.测试验证准确信<br>		9.1 创建topic<br>[root@elk93 ~]# kafka-topics.sh --bootstrap-server 10.0.0.91:9092 --create --topic xixi --partitions 3 <br>Created topic xixi.<br>[root@elk93 ~]# <br><br>		<br>		9.2 启动消费者<br>[root@elk92 ~]# kafka-console-consumer.sh --bootstrap-server 10.0.0.91:9092  --topic xixi <br><br>		9.3 启动生产者<br>[root@elk93 ~]# kafka-console-producer.sh --bootstrap-server 10.0.0.91:9092  --topic xixi<br></code></pre></td></tr></table></figure>



<h2 id="14、监控Jenkins服务"><a href="#14、监控Jenkins服务" class="headerlink" title="14、监控Jenkins服务"></a>14、监控Jenkins服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.jenkins安装Prometheus插件<br>如果安装插件失败，可以直接导入tar包到/var/lib/jenkins/plugins目录并重启。<br>tar xf jenkins-plugins.tar.gz <br><br>2.验证Jenkins的metrics组件是否生效<br>[root@jenkins211 plugins]# systemctl restart jenkins<br>http://10.0.0.211:8080/prometheus/<br><br>3.验证Jenkins的metrics组件是否生效<br>http://10.0.0.211:8080/prometheus/<br><br>4.修改Prometheus的配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>  - job_name: jenkins<br>    metrics_path: /prometheus<br>    static_configs:<br>    - targets:<br>      - 10.0.0.211:8080<br>...<br><br>[root@prometheus-server31 ~]# rr<br><br>5.访问Prometheus的WebUI<br>http://10.0.0.31:9090/targets<br><br>6.导入Jenkins的相关模板<br>9964<br>9524<br>12646<br></code></pre></td></tr></table></figure>



<h2 id="15、监控mysql服务"><a href="#15、监控mysql服务" class="headerlink" title="15、监控mysql服务"></a>15、监控mysql服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.部署MySQL<br>[root@jenkins211 ~]# docker run --name mysql-server -d \<br>             -e MYSQL_USER=<span class="hljs-string">&quot;root&quot;</span> \<br>             -e MYSQL_PASSWORD=<span class="hljs-string">&quot;123456&quot;</span> \<br>             -e MYSQL_ALLOW_EMPTY_PASSWORD=<span class="hljs-string">&quot;yes&quot;</span> \<br>             --network=host \<br>			 --restart unless-stopped \<br>             mysql:8.4.2-oracle \<br>             --character-set-server=utf8mb4 --collation-server=utf8mb4_bin <br>             <br>[root@jenkins211 ~]# docker ps -l<br>CONTAINER ID   IMAGE                COMMAND                  CREATED          STATUS          PORTS     NAMES<br>5db1d0101b5c   mysql:8.3.0-oracle   <span class="hljs-string">&quot;docker-entrypoint.s…&quot;</span>   13 seconds ago   Up 13 seconds             mysql-server<br>[root@jenkins211 ~]# <br>[root@jenkins211 ~]# ss -ntl | grep 3306<br>LISTEN 0      151                *:3306             *:*          <br>LISTEN 0      70                 *:33060            *:*   <br><br><br>2.下载mysql exporter <br>wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.15.1/mysqld_exporter-0.15.1.linux-amd64.tar.gz<br><br>3.安装mysql exporters<br>[root@jenkins211 ~]# tar xf mysqld_exporter-0.15.1.linux-amd64.tar.gz -C /usr/local/bin/ mysqld_exporter-0.15.1.linux-amd64/mysqld_exporter  --strip-components=1<br><br>4.准备MySQL的链接认证文件，创建MySQL的配置，指定默认的用户名和密码<br>[root@jenkins211 ~]# <span class="hljs-built_in">cat</span>  ~/.my.cnf <br>[client]<br>user=root<br>password=123456<br><br>5.运行mysqld-exporter<br>[root@jenkins211 ~]# mysqld_exporter --mysqld.address=<span class="hljs-string">&quot;10.0.0.211:3306&quot;</span> --web.listen-address=:9104 --config.my-cnf=<span class="hljs-string">&quot;/root/.my.cnf&quot;</span><br><br>6.访问mysqld_exporter的webUI<br>http://10.0.0.211:9104/metrics<br><br>7.修改Prometheus的配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>  - job_name: mysql<br>    static_configs:<br>    - targets:<br>      - 10.0.0.211:9104<br>      <br>[root@prometheus-server31 ~]# rr<br><br>8.查看Prometheus是否监控到数据<br>http://10.0.0.31:9090/targets<br><br>9.grafana出图展示<br>18949<br>17320<br>14057<br></code></pre></td></tr></table></figure>



<h2 id="16、监控Redis服务"><a href="#16、监控Redis服务" class="headerlink" title="16、监控Redis服务"></a>16、监控Redis服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.部署Redis<br>[root@jenkins211 ~]# docker run -d --name redis-server --restart always --network host  redis:7.2.5<br><br>2.下载redis-exporter<br>wget https://github.com/oliver006/redis_exporter/releases/download/v1.52.0/redis_exporter-v1.52.0.linux-amd64.tar.gz<br><br>3.解压软件包到PATH路径<br>[root@jenkins211 ~]# tar xf redis_exporter-v1.61.0.linux-amd64.tar.gz -C /usr/local/bin/ redis_exporter-v1.61.0.linux-amd64/redis_exporter --strip-components=1<br>[root@jenkins211 ~]# ll /usr/local/bin/<br><br>4.运行redis-exporter<br>[root@jenkins211 ~]# redis_exporter -web.listen-address=:9121 -web.telemetry-path=/metrics  -redis.addr=redis://10.0.0.211:6379<br><br>5.访问redis-exporter的WebUI<br>http://10.0.0.211:9121/metrics<br><br>6.修改Prometheus的配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>  - job_name: redis<br>    static_configs:<br>    - targets:<br>      - 10.0.0.211:9121<br>[root@prometheus-server31 ~]# rr<br><br><br>7.访问Prometheus的WebUI<br>http://10.0.0.31:9090/targets<br>	<br>8.grafana出图展示<br>763<br>14091	<br></code></pre></td></tr></table></figure>



<h2 id="17、安装grafana插件"><a href="#17、安装grafana插件" class="headerlink" title="17、安装grafana插件"></a>17、安装grafana插件</h2><p><strong>在线安装</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">grafana的版本为9.5.21<br>软件包下载到/var/lib/grafana/plugins/目录<br><br>[root@prometheus-server31 grafana]# grafana-cli plugins install natel-discrete-panel<br></code></pre></td></tr></table></figure>

<p><strong>离线安装</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@grafana71 ~]# wget  https://grafana.com/api/plugins/natel-discrete-panel/versions/latest/download -O /opt/natel-discrete-panel.zip<br><br>[root@prometheus-server31 ~]# unzip natel-discrete-panel-0.1.1.zip -d /var/lib/grafana/plugins/<br><br>[root@prometheus-server31 ~]# systemctl restart grafana-server<br><br>[root@prometheus-server31 ~]# ss -ntl | grep 3000<br>LISTEN 0      4096               *:3000            *:*          <br></code></pre></td></tr></table></figure>



<h2 id="18、监控nginx服务"><a href="#18、监控nginx服务" class="headerlink" title="18、监控nginx服务"></a>18、监控nginx服务</h2><p><strong>编译安装nginx</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 安装编译工具<br>CentOS：<br>yum -y install git wget gcc make zlib-devel gcc-c++ libtool openssl openssl-devel<br><br>Ubuntu：<br>apt -y install git wget gcc make zlib1g-dev build-essential libtool openssl libssl-dev<br><br>2 克隆nginx-module-vts模块<br>git <span class="hljs-built_in">clone</span> git://github.com/vozlt/nginx-module-vts.git<br>或者<br>git <span class="hljs-built_in">clone</span> https://gitee.com/jasonyin2020/nginx-module-vts.git<br><br>3 下载nginx软件包<br>wget https://nginx.org/download/nginx-1.26.2.tar.gz<br><br>4 解压nginx<br>tar xf nginx-1.26.2.tar.gz<br><br><br>5 配置nginx<br><span class="hljs-built_in">cd</span> nginx-1.26.2<br>./configure --prefix=/softwares/nginx \<br>  --with-http_ssl_module \<br>  --with-http_v2_module \<br>  --with-http_realip_module \<br>  --without-http_rewrite_module \<br>  --with-http_stub_status_module \<br>  --without-http_gzip_module  \<br>  --with-file-aio \<br>  --with-stream \<br>  --with-stream_ssl_module \<br>  --with-stream_realip_module \<br>  --add-module=/root/nginx-module-vts<br><br>6 编译并安装nginx<br>make -j 2 &amp;&amp; make install<br><br>7 修改nginx的配置文件<br>vim /softwares/nginx/conf/nginx.conf<br>...<br>http &#123;<br>    <span class="hljs-comment">#加入编译的status模块，将请求代理到31:9090端口</span><br>    vhost_traffic_status_zone;<br>    upstream promethues &#123;<br>       server 10.0.0.31:9090;<br>    &#125;<br>    ...<br>    server &#123;<br>        ...<br>        location / &#123;<br>            root   html;<br>            <span class="hljs-comment"># index  index.html index.htm;</span><br>            proxy_pass http://promethues;<br>        &#125;<br><br>        location /status &#123;<br>            vhost_traffic_status_display;<br>            vhost_traffic_status_display_format html;<br>        &#125;<br>    &#125;<br>&#125;<br><br>8 检查配置文件语法<br>[root@jenkins211 ~]# /softwares/nginx/sbin/nginx -t<br><br>9 启动nginx<br>[root@jenkins211 ~]# /softwares/nginx/sbin/nginx<br>[root@jenkins211 ~]# <br>[root@jenkins211 ~]# ss -ntl | grep 80<br>LISTEN 0      511          0.0.0.0:80        0.0.0.0:*      <br><br>10 访问nginx的状态页面<br>http://10.0.0.211/status/format/prometheus<br>http://10.0.0.211/status<br></code></pre></td></tr></table></figure>

<p><strong>安装nginx-vtx-exporter</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.下载nginx-vtx-exporter,不建议下载最新版本<br>wget https://github.com/hnlq715/nginx-vts-exporter/releases/download/v0.10.3/nginx-vts-exporter-0.10.3.linux-amd64.tar.gz<br><br>2 解压软件包到path路径<br>tar xf nginx-vts-exporter-0.10.3.linux-amd64.tar.gz -C /usr/local/bin/ nginx-vts-exporter-0.10.3.linux-amd64/nginx-vts-exporter --strip-components=1<br><br>3 运行nginx-vtx-exporter<br>[root@jenkins211 ~]# nginx-vts-exporter -nginx.scrape_uri=http://10.0.0.211/status/format/json<br></code></pre></td></tr></table></figure>

<p><strong>配置prometheus采集nginx数据</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 修改配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br><br>...<br>scrape_configs:<br>  ...<br>  - job_name: <span class="hljs-string">&quot;nginx-exporter&quot;</span><br>    metrics_path: <span class="hljs-string">&quot;/status/format/prometheus&quot;</span><br>    static_configs:<br>      - targets:<br>          - <span class="hljs-string">&quot;10.0.0.211:80&quot;</span><br><br>  - job_name: <span class="hljs-string">&quot;nginx-vts-exporter&quot;</span><br>    static_configs:<br>      - targets:<br>          - <span class="hljs-string">&quot;10.0.0.211:9913&quot;</span><br>          <br>[root@prometheus-server31 ~]# rr<br><br>2 访问Prometheus的WebUI<br>http://10.0.0.31:9090/targets<br><br>3 导入grafana模板<br>2949<br></code></pre></td></tr></table></figure>



<h2 id="19、监控tomcat服务"><a href="#19、监控tomcat服务" class="headerlink" title="19、监控tomcat服务"></a>19、监控tomcat服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 基于Dockerfile构建tomcat-exporter<br>[root@jenkins211 ~]# git <span class="hljs-built_in">clone</span> https://gitee.com/jasonyin2020/tomcat-exporter.git<br><br>2.编译镜像<br>[root@jenkins211 ~]# <span class="hljs-built_in">cd</span> tomcat-exporter/<br>[root@jenkins211 tomcat-exporter]# <span class="hljs-built_in">chmod</span> +x build.sh <br>[root@jenkins211 tomcat-exporter]# ./build.sh <br><br>3 运行tomcat镜像<br>[root@jenkins211 ~]# docker run -dp 18080:8080 --name tomcat-server registry.cn-hangzhou.aliyuncs.com/yinzhengjie-k8s/tomcat9-app:v1<br><br>4.访问tomcat应用<br>http://10.0.0.211:18080/metrics/<br>http://10.0.0.211:18080/myapp/ <br><br>5.配置prometheus监控tomcat应用<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>scrape_configs:<br>  ...<br>  - job_name: <span class="hljs-string">&quot;tomcat-exporter&quot;</span><br>    static_configs:<br>      - targets: <br>          - <span class="hljs-string">&quot;10.0.0.211:18080&quot;</span><br>          <br>5.2 导入grafana模板 <br>https://github.com/nlighten/tomcat_exporter/blob/master/dashboard/example.json<br></code></pre></td></tr></table></figure>



<h2 id="20、监控容器cadvisor"><a href="#20、监控容器cadvisor" class="headerlink" title="20、监控容器cadvisor"></a>20、监控容器cadvisor</h2><p>它是一个正在运行的守护进程，用于收集、聚合、处理和导出有关正在运行的容器的信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs bash">官网地址：https://github.com/google/cadvisor<br><br>导入镜像<br>[root@jenkins211 ~]# docker load -i cadvisor-amd64-0.49.1.tar.gz <br><br>运行容器<br>[root@jenkins211 ~]# <br>VERSION=v0.49.1 <br>docker run \<br>  -v /:/rootfs:ro \<br>  -v /var/run:/var/run:ro \<br>  -v /sys:/sys:ro \<br>  -v /var/lib/docker/:/var/lib/docker:ro \<br>  -v /dev/disk/:/dev/disk:ro \<br>  -p 28080:8080 \<br>  -d \<br>  --name=cadvisor \<br>  --privileged \<br>  --device=/dev/kmsg \<br>  gcr.io/cadvisor/cadvisor-amd64:<span class="hljs-variable">$VERSION</span><br>54149a621e6bcd9a612fc0b3c755eea91d7466b52bf732a92816c22993b2d635<br><br>prometheus采集cAdvisor容器<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml<br>...<br>scrape_configs:<br>  ...<br>  - job_name: <span class="hljs-string">&quot;prometheus-cAdvisor&quot;</span><br>    static_configs:<br>    - targets:<br>        - <span class="hljs-string">&quot;10.0.0.211:28080&quot;</span><br>        <br>[root@prometheus-server31 ~]# rr<br>10.0.0.211:28080/metrics<br><br>访问WebUI验证配置是否生效<br>http://10.0.0.31:9090/targets<br><br>导入grafana模板<br>315  <br>10619<br><br><br>grafana的官方优化思路-对于容器出现小数的情况<br>针对10619模板，当容器数量增多时，如果容器出现小数点，微调即可。<br><br>Value options  ---&gt;  <span class="hljs-string">&quot;Last*&quot;</span><br></code></pre></td></tr></table></figure>

<h2 id="21、基于docker部署Prometheus相关组件"><a href="#21、基于docker部署Prometheus相关组件" class="headerlink" title="21、基于docker部署Prometheus相关组件"></a>21、基于docker部署Prometheus相关组件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.部署Prometheus -server <br>[root@jenkins211 ~]# docker run -d --network host --name prometheus-server prom/prometheus:v2.53.2 <br><br>2.部署node-exporter<br>[root@jenkins211 ~]# docker run  -d --name node-exporter --network host  prom/node-exporter:v1.8.2 <br><br>3.配置Prometheus server监控node-exporter<br>修改配置文件<br>[root@jenkins211 ~]# docker <span class="hljs-built_in">exec</span> -it prometheus-server sh<br>/prometheus $ <br>/prometheus $ vi /etc/prometheus/prometheus.yml <br>...<br>                                         <br>  - job_name: <span class="hljs-string">&quot;prometheus-node-exporter&quot;</span> <br>    static_configs:                     <br>    - targets:                          <br>      - 10.0.0.211:9100<br>      <br>重新加载配置<br>[root@jenkins211 ~]# docker restart prometheus-server <br>验证是否加载成功<br>http://10.0.0.211:9090/targets<br><br>4.部署grafana组件<br>部署 <br>[root@jenkins211 ~]# docker run -d --name grafana --network host grafana/grafana:9.5.21 <br>访问测试 <br>http://10.0.0.211:3000<br><br><br>5.部署pushgateway组件<br>部署 <br>[root@jenkins211 ~]# docker run -d --name pushgateway --network host prom/pushgateway:v1.9.0 <br>访问测试 <br>http://10.0.0.211:9091/<br><br>6.部署alertmanager组件<br>部署<br>[root@jenkins211 ~]# docker run -d --name alertmanager --network host prom/alertmanager:v0.27.0 <br>访问测试 <br>http://10.0.0.211:9093/#/alerts<br></code></pre></td></tr></table></figure>



<h2 id="22、文件发现服务"><a href="#22、文件发现服务" class="headerlink" title="22、文件发现服务"></a>22、文件发现服务</h2><p>静态配置：之前使用的都是静态分析，每次都要重启服务或者热加载文件</p>
<p>动态配置：可以动态发现服务，无需热加载文件</p>
<p>动态配置可分为json文件和yaml文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.修改prometheus的配置文件 <br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br><br>...<br>  - job_name: <span class="hljs-string">&#x27;file-service-discovery-json&#x27;</span><br>    <span class="hljs-comment"># 基于文件的服务发现为动态发现</span><br>    file_sd_configs:<br>        <span class="hljs-comment"># 指定文件路径</span><br>      - files:<br>          - /softwares/prometheus-2.53.2.linux-amd64/config/*.json<br><br>  - job_name: <span class="hljs-string">&#x27;file-service-discovery-yaml&#x27;</span><br>    file_sd_configs:<br>      - files:<br>          - /softwares/prometheus-2.53.2.linux-amd64/config/*.yaml<br>          <br>          <br>2.重新加载配置 <br>[root@prometheus-server31 ~]# rr<br><br>3.访问WebUI验证配置是否生效<br>http://10.0.0.31:9090/config<br><br>4.创建配置文件模拟基于动态的监控<br>创建目录 <br>[root@prometheus-server31 ~]# <span class="hljs-built_in">mkdir</span> -pv /softwares/prometheus-2.53.2.linux-amd64/config<br>创建json文件监控41节点<br>[root@prometheus-server31 ~]# <span class="hljs-built_in">cat</span> /softwares/prometheus-2.53.2.linux-amd64/config/linux.json<br>[<br>  &#123;<br>    <span class="hljs-string">&quot;targets&quot;</span>: [ <span class="hljs-string">&quot;10.0.0.41:9100&quot;</span> ],<br>    <span class="hljs-string">&quot;labels&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;school&quot;</span>: <span class="hljs-string">&quot;cherry&quot;</span>,<br>      <span class="hljs-string">&quot;class&quot;</span>: <span class="hljs-string">&quot;123456&quot;</span><br>    &#125;<br>  &#125;<br>]<br>创建yaml文件监控42和43节点<br>[root@prometheus-server31 ~]# <span class="hljs-built_in">cat</span> /softwares/prometheus-2.53.2.linux-amd64/config/haha.yaml <br>- targets:<br>    - <span class="hljs-string">&#x27;10.0.0.42:9100&#x27;</span><br>    - <span class="hljs-string">&#x27;10.0.0.43:9100&#x27;</span><br>  labels:<br>    apps: yaml<br>    address: shahe<br>    <br>再次查看Prometheus的WebUI<br>http://10.0.0.31:9090/targets<br><br>参考链接:	https://prometheus.io/docs/prometheus/2.53/configuration/configuration/#file_sd_config<br></code></pre></td></tr></table></figure>





<h2 id="23、consul服务发现"><a href="#23、consul服务发现" class="headerlink" title="23、consul服务发现"></a><strong>23、consul服务发现</strong></h2><p>普罗米修斯服务端不能直接发现node节点，由consul服务端将node节点告诉过普罗米修斯服务端，consul也属于动态发现服务</p>
<p><strong>node节点部署consul集群</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 下载consul<br>wget https://releases.hashicorp.com/consul/1.19.1/consul_1.19.1_freebsd_amd64.zip<br><br>2 快速部署consul集群<br>下载consul<br>wget https://releases.hashicorp.com/consul/1.19.1/consul_1.19.1_freebsd_amd64.zip<br><br>解压consul<br>unzip consul_1.19.1_linux_amd64.zip  -d /usr/local/bin/<br><br>运行consul 集群<br>leader43:<br>consul agent -server -bootstrap -<span class="hljs-built_in">bind</span>=10.0.0.43 -data-dir=/softwares/consul -client=10.0.0.43 -ui<br><br><br>follower42:<br>consul agent  -<span class="hljs-built_in">bind</span>=10.0.0.42 -data-dir=/softwares/consul -client=10.0.0.42 -ui -retry-join=10.0.0.43<br><br><br>follower41:<br>consul agent -server -<span class="hljs-built_in">bind</span>=10.0.0.41 -data-dir=/softwares/consul -client=10.0.0.41 -ui -retry-join=10.0.0.43<br><br>访问console服务的WebUI，查看node节点<br>http://10.0.0.43:8500/ui/dc1/nodes<br></code></pre></td></tr></table></figure>

<p><strong>配置自动发现</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 修改prometheus的配置文件<br>vim /softwares/prometheus/prometheus.yml<br>...<br>scrape_configs:<br>  ...<br>  - job_name: <span class="hljs-string">&quot;consul-seriver-discovery&quot;</span><br>    <span class="hljs-comment"># 配置基于consul的服务发现</span><br>    consul_sd_configs:<br>        <span class="hljs-comment"># 指定consul的服务器地址，若不指定，则默认值为&quot;localhost:8500&quot;.</span><br>      - server: 10.0.0.43:8500<br>      - server: 10.0.0.42:8500<br>      - server: 10.0.0.41:8500<br>    relabel_configs:<br>        <span class="hljs-comment"># 匹配consul的源标签字段，表示服务名称</span><br>      - source_labels: [__meta_consul_service]<br>        <span class="hljs-comment"># 指定源标签的正则表达式，若不定义，默认值为&quot;(.*)&quot;</span><br>        regex: consul<br>        <span class="hljs-comment"># 执行动作为删除，默认值为&quot;replace&quot;,有效值有多种</span><br>        <span class="hljs-comment">#   https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_action</span><br>        action: drop<br><br>2 检查配置文件是否正确并重新加载配置<br>[root@prometheus-server31 ~]# check <br>[root@prometheus-server31 ~]# rr<br><br>3.被监控节点注册到console集群<br>注册节点<br>[root@prometheus-server31 prometheus-2.53.2.linux-amd64]# curl -X PUT -d <span class="hljs-string">&#x27;&#123;&quot;id&quot;:&quot;prometheus-node42&quot;,&quot;name&quot;:&quot;prometheus-node42&quot;,&quot;address&quot;:&quot;10.0.0.42&quot;,&quot;port&quot;:9100,&quot;tags&quot;:[&quot;node-exporter&quot;],&quot;checks&quot;: [&#123;&quot;http&quot;:&quot;http://10.0.0.42:9100&quot;,&quot;interval&quot;:&quot;5m&quot;&#125;]&#125;&#x27;</span> http://10.0.0.42:8500/v1/agent/service/register<br><br>[root@prometheus-server31 prometheus-2.53.2.linux-amd64]# curl -X PUT -d <span class="hljs-string">&#x27;&#123;&quot;id&quot;:&quot;prometheus-node41&quot;,&quot;name&quot;:&quot;prometheus-node42&quot;,&quot;address&quot;:&quot;10.0.0.41&quot;,&quot;port&quot;:9100,&quot;tags&quot;:[&quot;node-exporter&quot;],&quot;checks&quot;: [&#123;&quot;http&quot;:&quot;http://10.0.0.41:9100&quot;,&quot;interval&quot;:&quot;5m&quot;&#125;]&#125;&#x27;</span> http://10.0.0.42:8500/v1/agent/service/register<br><br>[root@prometheus-server31 prometheus-2.53.2.linux-amd64]# curl -X PUT -d <span class="hljs-string">&#x27;&#123;&quot;id&quot;:&quot;prometheus-node43&quot;,&quot;name&quot;:&quot;prometheus-node42&quot;,&quot;address&quot;:&quot;10.0.0.43&quot;,&quot;port&quot;:9100,&quot;tags&quot;:[&quot;node-exporter&quot;],&quot;checks&quot;: [&#123;&quot;http&quot;:&quot;http://10.0.0.43:9100&quot;,&quot;interval&quot;:&quot;5m&quot;&#125;]&#125;&#x27;</span> http://10.0.0.42:8500/v1/agent/service/register<br><br>注销节点,在哪个节点注册就要在哪个节点注销<br>[root@prometheus-server31 prometheus-2.53.2.linux-amd64]# curl -X PUT http://10.0.0.42:8500/v1/agent/service/deregister/prometheus-node42<br><br>[root@prometheus-server31 prometheus-2.53.2.linux-amd64]# curl -X PUT http://10.0.0.42:8500/v1/agent/service/deregister/prometheus-node41<br><br>[root@prometheus-server31 prometheus-2.53.2.linux-amd64]# curl -X PUT http://10.0.0.42:8500/v1/agent/service/deregister/prometheus-node43<br><br><br></code></pre></td></tr></table></figure>



<h2 id="24、pushgateway自定义监控指标"><a href="#24、pushgateway自定义监控指标" class="headerlink" title="24、pushgateway自定义监控指标"></a>24、pushgateway自定义监控指标</h2><ul>
<li>Prometheus 采用 pull 模式，可能由于不在一个子网或者防火墙原因，导致 Prometheus 无法直接拉取各个 target 数据。</li>
<li>在监控业务数据的时候，需要将不同数据汇总, 由 Prometheus 统一收集。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.下载组件<br>wget https://github.com/prometheus/pushgateway/releases/download/v1.9.0/pushgateway-1.9.0.linux-amd64.tar.gz<br><br>2.解压软件包 <br>[root@prometheus-server32 ~]# tar xf pushgateway-1.9.0.linux-amd64.tar.gz  -C /softwares/<br><br>3.启动pushgateway组件 <br>[root@prometheus-server32 ~]# <span class="hljs-built_in">cd</span> /softwares/pushgateway-1.9.0.linux-amd64/<br>[root@prometheus-server32 pushgateway-1.9.0.linux-amd64]# ./pushgateway <br><br>4.访问pushgateway的WebUI<br>http://10.0.0.32:9091/#<br><br>5.Prometheus server监控pushgateway <br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>  - job_name: pushgateway<br>    <span class="hljs-comment"># 若不指定则默认值为false。</span><br>    <span class="hljs-comment"># 当设置为true时，若采集的指标包含中和内置的标签冲突时(比如job,instance)会覆盖。</span><br>    <span class="hljs-comment"># 当设置为false时，则不会覆盖，而是在标签前面加一个&quot;exported_*&quot;字段。</span><br>    honor_labels: <span class="hljs-literal">true</span><br>    static_configs:<br>    - targets:<br>      - 10.0.0.32:9091<br>      <br>[root@prometheus-server31 ~]# rr<br><br>7.推送数据到pushgateway组件<br>-------------------------<br>传递的数据是键值对，KEY一般是字符串类型，而value必须是一个数字类型。<br>[root@prometheus-server31 ~]# <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;student_online 97&quot;</span> | curl --data-binary @-  http://10.0.0.32:9091/metrics/job/student/instance/10.0.0.31<br><br>8.在Prometheus的WebUI验证数据是否推送成功<br>在Prometheus的WebUI中搜索“student_online”<br></code></pre></td></tr></table></figure>



<h2 id="25、prometheus监控tcp的12种状态案例"><a href="#25、prometheus监控tcp的12种状态案例" class="headerlink" title="25、prometheus监控tcp的12种状态案例"></a>25、prometheus监控tcp的12种状态案例</h2><p><strong>查看单个状态脚本</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@prometheus-server31 ~]# <span class="hljs-built_in">cat</span> /usr/local/bin/tcp_status.sh  <br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment"># auther: cherry</span><br><span class="hljs-comment"># school: 001</span><br><span class="hljs-comment"># class: 002</span><br><span class="hljs-comment"># office: www.cherry.com</span><br><br><br><span class="hljs-comment"># 定义TCP的12种状态</span><br>ESTABLISHED_COUNT=0<br>SYN_SENT_COUNT=0<br>SYN_RECV_COUNT=0<br>FIN_WAIT1_COUNT=0<br>FIN_WAIT2_COUNT=0<br>TIME_WAIT_COUNT=0<br>CLOSE_COUNT=0<br>CLOSE_WAIT_COUNT=0<br>LAST_ACK_COUNT=0<br>LISTEN_COUNT=0<br>CLOSING_COUNT=0<br>UNKNOWN_COUNT=0<br><br><span class="hljs-comment"># 定义任务名称</span><br>JOB_NAME=tcp_status<br><span class="hljs-comment"># 定义实例名称</span><br>INSTANCE_NAME=prometheus32<br><span class="hljs-comment"># 定义pushgateway主机</span><br>HOST=10.0.0.32<br><span class="hljs-comment"># 定义pushgateway端口</span><br>PORT=9091<br><br><span class="hljs-comment"># TCP的12种状态</span><br>ALL_STATUS=(ESTABLISHED SYN_SENT SYN_RECV FIN_WAIT1 FIN_WAIT2 TIME_WAIT CLOSE CLOSE_WAIT LAST_ACK LISTEN CLOSING UNKNOWN)<br><br><span class="hljs-comment"># 声明一个关联数组,类似于py的dict,go的map</span><br><span class="hljs-built_in">declare</span> -A tcp_status<br><br><span class="hljs-comment"># 统计TCP的12种状态</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;ALL_STATUS[@]&#125;</span><br><span class="hljs-keyword">do</span><br>  temp=`netstat -untalp | grep <span class="hljs-variable">$i</span>  | <span class="hljs-built_in">wc</span> -l`<br>  tcp_status[<span class="hljs-variable">$&#123;i&#125;</span>]=<span class="hljs-variable">$temp</span><br><span class="hljs-keyword">done</span><br><br><span class="hljs-comment"># 将统计后的结果发送到pushgateway</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-variable">$&#123;!tcp_status[@]&#125;</span><br><span class="hljs-keyword">do</span> <br>   data=<span class="hljs-string">&quot;<span class="hljs-variable">$i</span> <span class="hljs-variable">$&#123;tcp_status[$i]&#125;</span>&quot;</span><br>   <span class="hljs-comment"># TODO: shell如果想要设计成相同key不同标签的方式存在问题，只会有最后一种状态被发送</span><br>   <span class="hljs-comment"># 目前我怀疑是pushgateway组件不支持同一个metrics中key所对应的value不同的情况。</span><br>   <span class="hljs-comment">#data=&quot;tcp_all_status&#123;status=\&quot;$i\&quot;&#125; $&#123;tcp_status[$i]&#125;&quot;</span><br>   <span class="hljs-comment">#echo $data</span><br>   <span class="hljs-built_in">echo</span> <span class="hljs-variable">$data</span> | curl --data-binary @-  http://<span class="hljs-variable">$&#123;HOST&#125;</span>:<span class="hljs-variable">$&#123;PORT&#125;</span>/metrics/job/<span class="hljs-variable">$&#123;JOB_NAME&#125;</span>/instance/<span class="hljs-variable">$&#123;INSTANCE_NAME&#125;</span><br>   <span class="hljs-comment"># sleep 1</span><br><span class="hljs-keyword">done</span><br><br>查看pushgateway<br>http://10.0.0.32:9091/#<br><br>普罗米修斯查看是否监测<br>ESTABLISHED.........<br><br></code></pre></td></tr></table></figure>

<p><strong>查看多个状态值</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@prometheus-server31 ~]# <span class="hljs-built_in">cat</span> -A /usr/local/bin/tcp_status2.sh<br><span class="hljs-comment">#!/bin/bash$</span><br>$<br><span class="hljs-comment"># M-hM-.M-&gt;M-gM-=M-. Pushgateway M-gM-^ZM-^D URL$</span><br>pushgateway_url=<span class="hljs-string">&quot;http://10.0.0.42:9091/metrics/job/tcp_status&quot;</span>$<br><span class="hljs-keyword">time</span>=$(<span class="hljs-built_in">date</span> +%Y-%m-%d+%H:%M:%S)$<br>$<br>state=<span class="hljs-string">&quot;SYN-SENT SYN-RECV FIN-WAIT-1 FIN-WAIT-2 TIME-WAIT CLOSE CLOSE-WAIT LAST-ACK LISTEN CLOSING ESTAB&quot;</span>$<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span>  $state$<br> <span class="hljs-keyword">do</span>$<br> t=`ss -tan |grep <span class="hljs-variable">$i</span> |<span class="hljs-built_in">wc</span> -l`$<br> <span class="hljs-built_in">echo</span> tcp_connections&#123;state=\&quot;<span class="hljs-string">&quot;<span class="hljs-variable">$i</span>&quot;</span>\&quot;&#125; <span class="hljs-variable">$t</span> &gt;&gt;/tmp/tcp.txt$<br><span class="hljs-keyword">done</span>;$<br>$<br><span class="hljs-built_in">cat</span> /tmp/tcp.txt | curl --data-binary @- $pushgateway_url$<br><span class="hljs-built_in">rm</span> -rf  /tmp/tcp.txt$<br></code></pre></td></tr></table></figure>



<h2 id="26、黑盒监控服务"><a href="#26、黑盒监控服务" class="headerlink" title="26、黑盒监控服务"></a>26、黑盒监控服务</h2><p>黑盒监控服务也属于自定义的一种监控指标。</p>
<p>1.所谓的黑盒监控<br>黑盒监控指的是事故已经发生了，才监控到，表示的是从外部监控。举例例子: 网站挂了。</p>
<p>白盒监控指的是服务内部暴露出来的指标，可以更早的预判出问题可能发生的点。举例例子: 当前服务器的负载，队列等待处理的数量异常过高。</p>
<p>2.blackbox_exporter概述<br>blackbox exporter支持基于HTTP, HTTPS, DNS, TCP, ICMP, gRPC协议来对目标节点进行监控。</p>
<p>比如基于http协议我们可以探测一个网站的返回状态码为200判读服务是否正常。</p>
<p>比如基于TCP协议我们可以探测一个主机端口是否监听。</p>
<p>比如基于ICMP协议来ping一个主机的连通性。</p>
<p>比如基于gRPC协议来调用接口并验证服务是否正常工作。</p>
<p>比如基于DNS协议可以来检测域名解析。</p>
<p><strong>部署blackbox exporter</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">下载blackbox exporter<br>wget https://github.com/prometheus/blackbox_exporter/releases/download/v0.25.0/blackbox_exporter-0.25.0.linux-amd64.tar.gz<br><br>解压软件包<br>[root@prometheus-server32 ~]# tar xf blackbox_exporter-0.25.0.linux-amd64.tar.gz -C  /softwares/<br><br>启动服务<br>[root@prometheus-server32 ~]# <span class="hljs-built_in">cd</span> /softwares/blackbox_exporter-0.25.0.linux-amd64/<br>[root@prometheus-server32 blackbox_exporter-0.25.0.linux-amd64]# ./blackbox_exporter<br><br>访问blackbox的WebUI<br>http://10.0.0.32:9115/metrics<br></code></pre></td></tr></table></figure>



<h4 id="基于blackbox的http模块监控网站状态"><a href="#基于blackbox的http模块监控网站状态" class="headerlink" title="基于blackbox的http模块监控网站状态"></a>基于blackbox的http模块监控网站状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs bash">修改Prometheus配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br><br>...<br>scrape_configs:<br>  ...<br>    <span class="hljs-comment"># 指定作业的名称，生成环境中，通常是指一类业务的分组配置。</span><br>  - job_name: <span class="hljs-string">&#x27;blackbox-exporter-http&#x27;</span><br>    <span class="hljs-comment"># 修改访问路径，若不修改，默认值为&quot;/metrics&quot;</span><br>    metrics_path: /probe<br>    <span class="hljs-comment"># 配置URL的相关参数</span><br>    params:<br>      <span class="hljs-comment"># 此处表示使用的是blackbox的http模块，从而判断相应的返回状态码是否为200</span><br>      module: [http_2xx] <br>	  <span class="hljs-comment"># 下面这两个标签是我自定义的，便于大家理解</span><br>      school: [001]<br>      class: [<span class="hljs-string">&quot;002&quot;</span>]<br>    <span class="hljs-comment"># 静态配置，需要手动指定监控目标</span><br>    static_configs:<br>        <span class="hljs-comment"># 需要监控的目标</span><br>      - targets:<br>          <span class="hljs-comment"># 支持https协议</span><br>        - https://www.cherry.com/<br>          <span class="hljs-comment"># 支持http协议</span><br>        - http://10.0.0.41<br>          <span class="hljs-comment"># 支持http协议和自定义端口</span><br>        - http://10.0.0.31:9090<br>    <span class="hljs-comment"># 对目标节点进行重新打标签配置</span><br>    relabel_configs:<br>        <span class="hljs-comment"># 指定源标签，此处的&quot;__address__&quot;表示内置的标签，存储的是被监控目标的IP地址</span><br>      - source_labels: [__address__]<br>        <span class="hljs-comment"># 指定目标标签，其实就是在&quot;Endpoint&quot;中加了一个target字段(用于指定监控目标)，</span><br>        target_label: __param_target<br>        <span class="hljs-comment"># 指定需要执行的动作，默认值为&quot;replace&quot;，常用的动作有: replace, keep, and drop。</span><br>        <span class="hljs-comment"># 但官方支持十几种动作： https://prometheus.io/docs/prometheus/2.53/configuration/configuration/#relabel_action</span><br>        <span class="hljs-comment"># 将&quot;__address__&quot;传递给target字段。</span><br>        action: replace<br>      - source_labels: [__param_target]<br>        target_label: instance<br>        <span class="hljs-comment">#target_label: instance2024</span><br>        <br>        <span class="hljs-comment"># 上面的2个配置段也可以改写成如下的配置哟~</span><br>     <span class="hljs-comment"># - source_labels: [__address__]</span><br>     <span class="hljs-comment">#   target_label: instance</span><br>     <span class="hljs-comment">#   action: replace</span><br>     <span class="hljs-comment"># - source_labels: [instance]</span><br>     <span class="hljs-comment">#   target_label: __param_target</span><br>     <span class="hljs-comment">#   action: replace</span><br>      - target_label: __address__<br>        <span class="hljs-comment"># 指定要替换的值,此处我指定为blackbox exporter的主机地址</span><br>        replacement: 10.0.0.32:9115<br><br>检查配置文件是否正确并重新加载配置文件<br>[root@prometheus-server31 ~]# check <br>[root@prometheus-server31 ~]# rr<br><br>访问prometheus的WebUI<br>http://10.0.0.31:9090/targets<br><br>访问blackbox exporter的WebUI<br>http://10.0.0.41:9115/<br><br>grafana展示数据<br>7587<br>13659<br></code></pre></td></tr></table></figure>

<h4 id="基于blackbox的ICMP监控目标主机是否存活"><a href="#基于blackbox的ICMP监控目标主机是否存活" class="headerlink" title="基于blackbox的ICMP监控目标主机是否存活"></a>基于blackbox的ICMP监控目标主机是否存活</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 修改Prometheus配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>scrape_configs:<br>  ...<br>  - job_name: <span class="hljs-string">&#x27;blackbox-exporter-icmp&#x27;</span><br>    metrics_path: /probe<br>    params:<br>      <span class="hljs-comment"># 如果不指定模块，则默认类型为&quot;http_2xx&quot;，不能乱写!乱写监控不到服务啦!</span><br>      module: [icmp]<br>    static_configs:<br>      - targets:<br>          - 10.0.0.41<br>          - 10.0.0.42<br>    relabel_configs:<br>      - source_labels: [__address__]<br>        target_label: __param_target<br>      - source_labels: [__param_target]<br>        <span class="hljs-comment"># 指定注意的是，如果instance不修改，则instance和&quot;__address__&quot;的值相同</span><br>        <span class="hljs-comment"># target_label: ip</span><br>        target_label: instance<br>      - target_label: __address__<br>        replacement: 10.0.0.32:9115 <br>        <br>2 检查配置文件是否正确并重新加载配置<br>[root@prometheus-server31 ~]# rr<br><br>3 访问prometheus的WebUI<br>http://10.0.0.31:9090/targets<br><br>4.访问blackbox的WebUI<br>http://10.0.0.32:9115/<br><br>5.grafana过滤<span class="hljs-built_in">jobs</span>数据<br>基于<span class="hljs-string">&quot;blackbox-exporter-icmp&quot;</span>标签进行过滤。<br></code></pre></td></tr></table></figure>

<h4 id="基于blackbox的TCP案例监控服务存活"><a href="#基于blackbox的TCP案例监控服务存活" class="headerlink" title="基于blackbox的TCP案例监控服务存活"></a>基于blackbox的TCP案例监控服务存活</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">1 修改Prometheus配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br> <br>...<br>scrape_configs:<br>  ...<br>  - job_name: <span class="hljs-string">&#x27;blackox-exporter-tcp&#x27;</span><br>    metrics_path: /probe<br>    params:<br>      module: [tcp_connect]<br>    static_configs:<br>      - targets:<br>          - 10.0.0.41:80<br>          - 10.0.0.42:22<br>          - 10.0.0.31:9090<br>    relabel_configs:<br>      - source_labels: [__address__]<br>        target_label: __param_target<br>      - source_labels: [__param_target]<br>        target_label: instance<br>      - target_label: __address__<br>        replacement: 10.0.0.32:9115<br>        <br>2 检查配置文件是否正确并重新加载配置文件<br>[root@prometheus-server31 ~]# rr<br><br>3 访问prometheus的WebUI<br>http://10.0.0.31:9090/targets<br><br>4.访问blackbox exporter的WebUI<br>http://10.0.0.32:9115/<br><br>5.使用grafana查看数据<br>基于<span class="hljs-string">&quot;blackbox-exporter-tcp&quot;</span>标签进行过滤。<br></code></pre></td></tr></table></figure>



<h2 id="27、远端存储VictoriaMetrics"><a href="#27、远端存储VictoriaMetrics" class="headerlink" title="27、远端存储VictoriaMetrics"></a>27、远端存储VictoriaMetrics</h2><p>VictoriaMetrics是一个快速、经济高效且可扩展的监控解决方案和时间序列数据库。</p>
<p>普罗米修斯可以将数据远程存储到VictoriaMetrics。默认情况下，普罗米修斯数据存储于本地文件的 TSDB 中，不利于容灾和做数据管理，若用于生产一般需要搭配第三方的如 InfulxDB 进行使用。大数据量的场景下，指标的收集和管理性能存在一定的瓶颈。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash">下载victoriametrics<br>wget https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v1.93.16/victoria-metrics-linux-amd64-v1.93.16.tar.gz<br><br>解压软件包 <br>[root@prometheus-server32 ~]# tar xf victoria-metrics-linux-amd64-v1.93.16.tar.gz -C /usr/local/bin/<br><br>编写启动脚本<br><span class="hljs-built_in">cat</span> &gt; /etc/systemd/system/victoria-metrics.service &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">[Unit]</span><br><span class="hljs-string">Description= Linux VictoriaMetrics Server</span><br><span class="hljs-string">Documentation=https://docs.victoriametrics.com/</span><br><span class="hljs-string">After=network.target</span><br><span class="hljs-string"></span><br><span class="hljs-string">[Service]</span><br><span class="hljs-string">ExecStart=/usr/local/bin/victoria-metrics-prod  \</span><br><span class="hljs-string">   -httpListenAddr=0.0.0.0:8428 \</span><br><span class="hljs-string">   -storageDataPath=/data/victoria-metrics \</span><br><span class="hljs-string">   -retentionPeriod=6</span><br><span class="hljs-string"></span><br><span class="hljs-string">[Install]</span><br><span class="hljs-string">WantedBy=multi-user.target</span><br><span class="hljs-string">EOF</span><br><br>systemctl daemon-reload<br>systemctl <span class="hljs-built_in">enable</span> --now victoria-metrics.service<br>systemctl status victoria-metrics<br><br>检查端口是否存活<br>[root@prometheus-server32 ~]# ss -ntl | grep 8428<br>LISTEN 0      4096         0.0.0.0:8428      0.0.0.0:* <br><br>查看webUI<br>http://10.0.0.32:8428/<br></code></pre></td></tr></table></figure>

<p><strong>prometheus配置VictoriaMetrics远端存储</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">修改prometheus的配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br><br>...<br>  - job_name: node-exporters<br>    metrics_path: /metrics<br>    scheme: http<br>    static_configs:<br>    - targets:<br>      - 10.0.0.41:9100<br>      - 10.0.0.42:9100<br>      - 10.0.0.43:9100<br>    <br><span class="hljs-comment"># 在顶级字段中配置VictoriaMetrics地址</span><br>remote_write:<br>  - url: http://10.0.0.32:8428/api/v1/write<br><br><br>停止prometheus服务<br>[root@prometheus-server31 ~]# systemctl stop prometheus-server<br><br>手动启动prometheus服务，因为启动脚本定义了之前普罗米修斯的数据目录，这里是要将之后的数据写入到vtmetrics，所以需要手动起服务<br>[root@prometheus-server31 ~]# /softwares/prometheus-2.53.2.linux-amd64/prometheus    --config.file=/softwares/prometheus-2.53.2.linux-amd64/prometheus.yml<br></code></pre></td></tr></table></figure>

<p><strong>vtmetrics查看数据</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">node_cpu_seconds_total&#123;instance=<span class="hljs-string">&quot;10.0.0.41:9100&quot;</span>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/85bfa65bb4094b33b86d2302c22c293f.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p><strong>配置grafana数据源和url</strong></p>
<p>这里数据源更改为mtmstrics的地址</p>
<p><img src="https://gitee.com/ljh00928/csdn/raw/master/img/5bbee7effec2429ca77dd12340f75053.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p><strong>导入模板</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">1806<br></code></pre></td></tr></table></figure>

<h2 id="28、altermanager监控告警"><a href="#28、altermanager监控告警" class="headerlink" title="28、altermanager监控告警"></a>28、altermanager监控告警</h2><p>用于prometheus server的告警功能的组件，目前支持多种告警媒介，包括但不限于邮件告警，钉钉告警，企业微信告警等。</p>
<p><strong>部署altermanager组件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.下载软件包<br>wget https://github.com/prometheus/alertmanager/releases/download/v0.27.0/alertmanager-0.27.0.linux-amd64.tar.gz<br><br>2.解压软件包<br>[root@prometheus-server32 ~]# tar xf alertmanager-0.27.0.linux-amd64.tar.gz -C /softwares/<br><br>3 修改alermanager的配置文件<br>[root@prometheus-server32 ~]# <span class="hljs-built_in">cat</span> &gt; /softwares/alertmanager-0.27.0.linux-amd64/alertmanager.yml &lt;&lt;<span class="hljs-string">&#x27;EOF&#x27;</span><br>global:<br>  resolve_timeout: 5m<br>  smtp_from: <span class="hljs-string">&#x27;y10539035@qq.com&#x27;</span><br>  smtp_smarthost: <span class="hljs-string">&#x27;smtp.qq.com:465&#x27;</span><br>  smtp_auth_username: <span class="hljs-string">&#x27;y10534035@qq.com&#x27;</span><br>  smtp_auth_password: <span class="hljs-string">&#x27;nvkhwupusuxubefe&#x27;</span><br>  smtp_require_tls: <span class="hljs-literal">false</span><br>  smtp_hello: <span class="hljs-string">&#x27;qq.com&#x27;</span><br>route:<br>  group_by: [<span class="hljs-string">&#x27;alertname&#x27;</span>]<br>  group_wait: 5s<br>  group_interval: 5s<br>  repeat_interval: 5m<br>  receiver: <span class="hljs-string">&#x27;email&#x27;</span><br>receivers:<br>- name: <span class="hljs-string">&#x27;email&#x27;</span><br>  email_configs:<br>  - to: <span class="hljs-string">&#x27;y10534135@qq.com&#x27;</span><br>    send_resolved: <span class="hljs-literal">true</span><br>inhibit_rules:<br>  - source_match:<br>      severity: <span class="hljs-string">&#x27;critical&#x27;</span><br>    target_match:<br>      severity: <span class="hljs-string">&#x27;warning&#x27;</span><br>    equal: [<span class="hljs-string">&#x27;alertname&#x27;</span>, <span class="hljs-string">&#x27;dev&#x27;</span>, <span class="hljs-string">&#x27;instance&#x27;</span>]<br>EOF<br><br>启动alermanager并访问webUI<br>[root@prometheus-server32 ~]# <span class="hljs-built_in">cd</span> /softwares/alertmanager-0.27.0.linux-amd64/<br>[root@prometheus-server32 alertmanager-0.27.0.linux-amd64]# ./alertmanager <br><br>--------------------------------------------------------<br>相关参数说明:<br>global:<br>  resolve_timeout:<br>  	解析超时时间。<br>  smtp_from:<br>  	发件人邮箱地址。<br>  smtp_smarthost:<br>  	邮箱的服务器的地址及端口，例如:  <span class="hljs-string">&#x27;smtp.qq.com:465&#x27;</span>。<br>  smtp_auth_username:<br>  	发送人的邮箱用户名。<br>  smtp_auth_password:<br>  	发送人的邮箱授权码。<br>  smtp_require_tls:<br>  	是否基于tls加密。<br>  smtp_hello:<br>  	邮箱服务器，例如: <span class="hljs-string">&#x27;qq.com&#x27;</span>。<br>route:<br>  group_by: [<span class="hljs-string">&#x27;alertname&#x27;</span>]<br>  group_wait: 5s<br>  group_interval: 5s<br>  repeat_interval:<br>  	重复报警的间隔时间，如果没有解即报警问题，则会间隔指定时间一直触发报警，比如:5m。<br>  receiver: <br>  	采用什么方式接收报警，例如<span class="hljs-string">&#x27;email&#x27;</span>。<br>receivers:<br>- name: <br>	定义接收者的名称，注意这里的name要和上面的route对应，例如: <span class="hljs-string">&#x27;email&#x27;</span><br>  email_configs:<br>  - to: <br>  	邮箱发给谁。<br>    send_resolved: <span class="hljs-literal">true</span><br>inhibit_rules:<br>  - source_match:<br>      severity: <br>      	匹配报警级别，例如: <span class="hljs-string">&#x27;critical&#x27;</span>。<br>    target_match:<br>      severity: <span class="hljs-string">&#x27;warning&#x27;</span><br>    equal: [<span class="hljs-string">&#x27;alertname&#x27;</span>, <span class="hljs-string">&#x27;dev&#x27;</span>, <span class="hljs-string">&#x27;instance&#x27;</span>]<br>   <br>--------------------------------------------------------------------------<br>prometheus配置alermanager作为告警媒介<br>1 修改配置文件<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>alerting:<br>  alertmanagers:<br>    - static_configs:<br>        - targets:<br>            - 10.0.0.32:9093<br>rule_files:<br>  - <span class="hljs-string">&quot;/softwares/prometheus-2.53.2.linux-amd64/rules/linux92.yml&quot;</span><br><br><br>...<br>scrape_configs:<br>  ...<br>  - job_name: node-exporter<br>    static_configs:<br>    - targets:<br>      - 10.0.0.41:9100<br>      - 10.0.0.42:9100<br>      - 10.0.0.43:9100<br>...<br><br>2 修改告警规则<br>[root@prometheus-server31 ~]# <span class="hljs-built_in">mkdir</span> -pv /softwares/prometheus-2.53.2.linux-amd64/rules<br><br>[root@prometheus-server31 ~]# <span class="hljs-built_in">cat</span> &gt;  /softwares/prometheus-2.53.2.linux-amd64/rules/linux.yml &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">groups:</span><br><span class="hljs-string">- name: container-runtime</span><br><span class="hljs-string">  rules:</span><br><span class="hljs-string">  - alert: container-42节点挂掉啦</span><br><span class="hljs-string">    expr: up&#123;instance=&quot;10.0.0.42:9100&quot;&#125; == 0</span><br><span class="hljs-string">    for: 15s</span><br><span class="hljs-string">    labels:</span><br><span class="hljs-string">      school: 001</span><br><span class="hljs-string">      class: 002</span><br><span class="hljs-string">    annotations:</span><br><span class="hljs-string">      summary: &quot;&#123;&#123; $labels.instance &#125;&#125; 已停止运行超过 15s！&quot;</span><br><span class="hljs-string">  - alert: container-43节点挂掉啦</span><br><span class="hljs-string">    expr: up&#123;instance=&quot;10.0.0.43:9100&quot;&#125; == 0</span><br><span class="hljs-string">    for: 15s</span><br><span class="hljs-string">    labels:</span><br><span class="hljs-string">      school: 001</span><br><span class="hljs-string">      class: 002</span><br><span class="hljs-string">    annotations:</span><br><span class="hljs-string">      summary: &quot;&#123;&#123; $labels.instance &#125;&#125; 联邦模式已停止运行超过 15s！&quot;</span><br><span class="hljs-string">EOF</span><br><br>3 检查配置并重新加载prometheus的配置<br>[root@prometheus-server31 ~]# check <br>[root@prometheus-server31 ~]# rr<br><br>4 查看prometheus server的WebUI<br>http://10.0.0.31:9090/target<br><br>5 查看alermanager的WebUI<br>h/softwares/alertmanager-0.27.0.linux-amd64<br><br>[root@prometheus-server32 alertmanager-0.27.0.linux-amd64]# <span class="hljs-built_in">mkdir</span> tmpl<br><br>2 创建模板实例，工作中可以考虑嵌入公司的logo<br>[root@prometheus-server32 alertmanager-0.27.0.linux-amd64]# <span class="hljs-built_in">cat</span> &gt; tmpl/email.tmp1 &lt;&lt;<span class="hljs-string">&#x27;EOF&#x27;</span> <br>&#123;&#123; define <span class="hljs-string">&quot;001.html&quot;</span> &#125;&#125;<br>&lt;h1 style=<span class="hljs-string">&#x27;color: red;&#x27;</span>&gt;啦啦啦:  https://www.cherry.com/&lt;/h1&gt;<br>&lt;table border=<span class="hljs-string">&quot;1&quot;</span>&gt;<br>        &lt;<span class="hljs-built_in">tr</span>&gt;<br>                &lt;th&gt;报警项&lt;/th&gt;<br>                &lt;th&gt;实例&lt;/th&gt;<br>                &lt;th&gt;报警阀值&lt;/th&gt;<br>                &lt;th&gt;开始时间&lt;/th&gt;<br>        &lt;/tr&gt;<br>        &#123;&#123; range <span class="hljs-variable">$i</span>, <span class="hljs-variable">$alert</span> := .Alerts &#125;&#125;<br>                &lt;<span class="hljs-built_in">tr</span>&gt;<br>                        &lt;td&gt;&#123;&#123; index <span class="hljs-variable">$alert</span>.Labels <span class="hljs-string">&quot;alertname&quot;</span> &#125;&#125;&lt;/td&gt;<br>                        &lt;td&gt;&#123;&#123; index <span class="hljs-variable">$alert</span>.Labels <span class="hljs-string">&quot;instance&quot;</span> &#125;&#125;&lt;/td&gt;<br>                        &lt;td&gt;&#123;&#123; index <span class="hljs-variable">$alert</span>.Annotations <span class="hljs-string">&quot;value&quot;</span> &#125;&#125;&lt;/td&gt;<br>                        &lt;td&gt;&#123;&#123; <span class="hljs-variable">$alert</span>.StartsAt &#125;&#125;&lt;/td&gt;<br>                &lt;/tr&gt;<br>        &#123;&#123; end &#125;&#125;<br>&lt;/table&gt;<br><br>&lt;img src=<span class="hljs-string">&quot;https://www.cherry.com/static/images/header/logo.png&quot;</span>&gt;<br><br>&#123;&#123; end &#125;&#125;<br>EOF<br><br>3 alertmanager引用自定义模板文件<br>[root@prometheus-server32 alertmanager-0.27.0.linux-amd64]# <span class="hljs-built_in">cat</span> alertmanager.yml <br>global:<br>  resolve_timeout: 5m<br>  smtp_from: <span class="hljs-string">&#x27;31013067@qq.com&#x27;</span><br>  smtp_smarthost: <span class="hljs-string">&#x27;smtp.qq.com:465&#x27;</span><br>  smtp_auth_username: <span class="hljs-string">&#x27;31013067@qq.com&#x27;</span><br>  smtp_auth_password: <span class="hljs-string">&#x27;ysfkvbpjeddhbi&#x27;</span><br>  smtp_require_tls: <span class="hljs-literal">false</span><br>  smtp_hello: <span class="hljs-string">&#x27;qq.com&#x27;</span><br><br>route:<br>  group_by: [<span class="hljs-string">&#x27;alertname&#x27;</span>]<br>  group_wait: 5s<br>  group_interval: 5s<br>  repeat_interval: 5m<br>  receiver: <span class="hljs-string">&#x27;email&#x27;</span><br><br>templates:<br>  - <span class="hljs-string">&#x27;./tmp1/*.tmp1&#x27;</span><br><br>receivers:<br>- name: <span class="hljs-string">&#x27;email&#x27;</span><br>  email_configs:<br>  - to: <span class="hljs-string">&#x27;31013067@qq.com&#x27;</span><br>    send_resolved: <span class="hljs-literal">true</span><br>    headers: &#123; Subject: <span class="hljs-string">&quot;[WARN] 报警邮件&quot;</span> &#125;<br>    html: <span class="hljs-string">&#x27;&#123;&#123; template &quot;cherry.html&quot; . &#125;&#125;&#x27;</span><br><br>inhibit_rules:<br>  - source_match:<br>      severity: <span class="hljs-string">&#x27;critical&#x27;</span><br>    target_match:<br>      severity: <span class="hljs-string">&#x27;warning&#x27;</span><br>    equal: [<span class="hljs-string">&#x27;alertname&#x27;</span>, <span class="hljs-string">&#x27;dev&#x27;</span>, <span class="hljs-string">&#x27;instance&#x27;</span>]<br><br>4 alertmanager语法检查<br>[root@prometheus-server32 alertmanager-0.27.0.linux-amd64]# <span class="hljs-built_in">pwd</span><br>/softwares/alertmanager-0.27.0.linux-amd64<br><br>[root@prometheus-server32 alertmanager-0.27.0.linux-amd64]# ./amtool check-config ./alertmanager.yml <br><br>5 重新加载配置信息<br>[root@prometheus-server32 alertmanager-0.27.0.linux-amd64]# ./alertmanager <br><br>6 查看WebUi观察配置是否生效<br>http://10.0.0.32:9093/#/status<br><br>---------------------------------------------<br>prometheus需要修改以下规则文件<br>1 修改规则文件<br>[root@prometheus-server31 ~]# <span class="hljs-built_in">cat</span> /softwares/prometheus-2.53.2.linux-amd64/rules/linux92.yml <br><span class="hljs-built_in">groups</span>:<br>- name: linux92-container-runtime<br>  rules:<br>  - alert: container-42节点挂掉啦<br>    <span class="hljs-built_in">expr</span>: up&#123;instance=<span class="hljs-string">&quot;10.0.0.42:9100&quot;</span>&#125; == 0<br>    <span class="hljs-keyword">for</span>: 15s<br>    labels:<br>      school: 001<br>      class: 002<br>    annotations:<br>      summary: <span class="hljs-string">&quot;&#123;&#123; .instance &#125;&#125; 已停止运行超过 15s！&quot;</span><br>	  <span class="hljs-comment"># 添加此行用于获取阈值</span><br>      value: <span class="hljs-string">&quot;&#123;&#123; <span class="hljs-variable">$value</span> &#125;&#125;&quot;</span><br>  - alert: container-43节点的挂掉啦<br>    <span class="hljs-built_in">expr</span>: up&#123;instance=<span class="hljs-string">&quot;10.0.0.43:9100&quot;</span>&#125; == 0<br>    <span class="hljs-keyword">for</span>: 15s<br>    labels:<br>      school: 01<br>      class: 02<br>    annotations:<br>      summary: <span class="hljs-string">&quot;&#123;&#123; .instance &#125;&#125; 联邦模式已停止运行超过 15s！&quot;</span><br>	  <span class="hljs-comment"># 添加此行用于获取阈值</span><br>      value: <span class="hljs-string">&quot;&#123;&#123; <span class="hljs-variable">$value</span> &#125;&#125;&quot;</span><br>      <br>检查语法并重新加载配置文件<br>[root@prometheus-server31 ~]# check <br>[root@prometheus-server31 ~]# rr<br></code></pre></td></tr></table></figure>



<h2 id="29、监控K8S集群"><a href="#29、监控K8S集群" class="headerlink" title="29、监控K8S集群"></a>29、监控K8S集群</h2><p><strong>prometheus-operator</strong></p>
<p>prometheus-operator可以一键实现对K8S集群的监控</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">GitHub地址: https://github.com/prometheus-operator/kube-prometheus<br><br>基于K8S版本选择合适的prometheus-operator<br>https://github.com/prometheus-operator/kube-prometheus#compatibility<br></code></pre></td></tr></table></figure>



<h4 id="1-prometheus内部监控k8s集群"><a href="#1-prometheus内部监控k8s集群" class="headerlink" title="1.prometheus内部监控k8s集群"></a>1.prometheus内部监控k8s集群</h4><p>普罗米修斯可以部署在k8s内部，也可以部署在k8s外部，企业中一般都是部署在k8s内部</p>
<p><strong>在K8S集群部署prometheus</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs bash">下载软件包<br>wget https://github.com/prometheus-operator/kube-prometheus/archive/refs/tags/v0.11.0.tar.gz<br><br>解压软件包<br>[root@master231 ~]# tar xf kube-prometheus-0.11.0.tar.gz -C /softwares/<br><br>切换工作目录，进入到prometheus-operator主目录<br>[root@master231 ~]# <span class="hljs-built_in">cd</span> /softwares/kube-prometheus-0.11.0/<br><br>更改yaml文件，自定义资源<br>[root@master231 kube-prometheus-0.11.0]# vim manifests/prometheusAdapter-deployment.yaml<br>......<br>        <span class="hljs-comment"># image: k8s.gcr.io/prometheus-adapter/prometheus-adapter:v0.9.1</span><br>        image: registry.cn-hangzhou.aliyuncs.com/k8s/prometheus-adapter:v0.9.1<br>...<br><br>[root@master231 kube-prometheus-0.11.0]# vim manifests/kubeStateMetrics-deployment.yaml<br>...<br>        <span class="hljs-comment"># image: k8s.gcr.io/kube-state-metrics/kube-state-metrics:v2.5.0</span><br>        image: registry.cn-hangzhou.aliyuncs.com/k8s/kube-state-metrics:2.5.0<br>        <br>[root@master231 kube-prometheus-0.11.0]# vim manifests/grafana-service.yaml<br>....<br>spec:<br>  ...<br>  <span class="hljs-built_in">type</span>: NodePort<br>  ports:<br>  - name: http<br>    port: 3000<br>    targetPort: http<br>    nodePort: 30080<br>    <br>[root@master231 kube-prometheus-0.11.0]# vim manifests/prometheus-service.yaml<br>....<br>spec:<br>  <span class="hljs-built_in">type</span>: NodePort<br>  ports:<br>  - name: web<br>    port: 9090<br>    targetPort: web<br>    nodePort: 30090<br>    <br>部署服务<br>[root@master231 kube-prometheus-0.11.0]# kubectl apply --server-side -f manifests/setup<br>[root@master231 kube-prometheus-0.11.0]# kubectl <span class="hljs-built_in">wait</span> \<br>	--<span class="hljs-keyword">for</span> condition=Established \<br>	--all CustomResourceDefinition \<br>	--namespace=monitoring<br>[root@master231 kube-prometheus-0.11.0]# kubectl apply -f manifests/<br><br>查看对应的Pod运行列表 ------&gt;如果没运行起来，一般手动导入镜像到对应节点<br>[root@master231 kube-prometheus-0.11.0]# kubectl get pods -n monitoring  -o wide<br>删除镜像，重新拉取<br>[root@master231 kube-prometheus-0.11.0]# kubectl -n monitoring delete pod --all<br>查看pod事件信息<br>[root@master231 kube-prometheus-0.11.0]# kubectl -n monitoring describe prometheus-k8s-0<br>查看所有服务<br>[root@master231 kube-prometheus-0.11.0]# kubectl get svc -A<br>查看svc详情<br>[root@master231 kube-prometheus-0.11.0]# kubectl describe svc -n monitoring prometheus-k8s<br><br>修改收件人和发件人信息<br>[root@master231 kube-prometheus-0.11.0]# vim manifests/alertmanager-secret.yaml <br>	里面记录了alertmanager的收件人和发件人信息。<br>	<br>访问WebUI <br>grafana：账号密码admin<br>http://10.0.0.231:30080<br>------------------------------<br>普罗米修斯：<br>http://10.0.0.231:30090<br>------------------------------<br><br>查看内置的模板 <br>查看后再倒入1860模板对比测试。<br></code></pre></td></tr></table></figure>



<h4 id="2-prometheus外部监控k8s集群"><a href="#2-prometheus外部监控k8s集群" class="headerlink" title="2.prometheus外部监控k8s集群"></a>2.prometheus外部监控k8s集群</h4><h5 id="监控node-exporter节点"><a href="#监控node-exporter节点" class="headerlink" title="监控node-exporter节点"></a><strong>监控node-exporter节点</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.所有节点导入镜像<br>[root@master231 ~]# docker load -i node-exporter_v1.8.1.tar.gz<br><br>2.在k8smaster编写资源清单<br>[root@master231 ~]# <span class="hljs-built_in">cat</span> ds-node-exporter.yaml <br>apiVersion: apps/v1<br>kind: DaemonSet<br>metadata:<br>  name: ds-node-exporter<br>spec:<br>  selector:<br>    matchLabels:<br>      apps: node-exporter<br>  template:<br>    metadata:<br>      labels:<br>        apps: node-exporter<br>    spec:<br>      hostNetwork: <span class="hljs-literal">true</span><br>      tolerations:<br>      - key: node-role.kubernetes.io/master<br>        effect: NoSchedule<br>      containers:<br>      - name: node-exporter<br>        image: prom/node-exporter:v1.8.1<br>        <span class="hljs-built_in">command</span>:<br>        - /bin/node_exporter<br>        - --web.listen-address=:19100<br><br>3.查看pod ---&gt; 每个节点成功运行<br>[root@master231 ~]# kubectl get pods -o wide<br>NAME                     READY   STATUS        RESTARTS   AGE    IP           NODE      <br>ds-node-exporter-5b4gc   1/1     Running       0          35s    10.0.0.233   worker233 <br>ds-node-exporter-dmnnj   1/1     Running       0          35s    10.0.0.232   worker232 <br>ds-node-exporter-hpj9h   1/1     Running       0          35s    10.0.0.231   master231 <br><br>4.修改Prometheus的配置文件并重新加载<br>[root@prometheus-server31 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml <br>...<br>  - job_name: k8s-node-exporter<br>    static_configs:<br>    - targets:<br>      - 10.0.0.231:19100<br>      - 10.0.0.232:19100<br>      - 10.0.0.233:19100<br>      <br>4.访问Prometheus的WebUI<br>http://10.0.0.31:9090/targets<br><br>5.grafana采集普罗米修斯31数据源的信息，导入模板ID<br>1860<br><br></code></pre></td></tr></table></figure>

<h5 id="监控云原生应用etcd案例"><a href="#监控云原生应用etcd案例" class="headerlink" title="监控云原生应用etcd案例"></a><strong>监控云原生应用etcd案例</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><code class="hljs bash">1.查看etcd证书存储路径<br>[root@master231 ~]#  egrep <span class="hljs-string">&quot;\--key-file|--cert-file&quot;</span> /etc/kubernetes/manifests/etcd.yaml <br>    - --cert-file=/etc/kubernetes/pki/etcd/server.crt<br>    - --key-file=/etc/kubernetes/pki/etcd/server.key<br><br>2 测试etcd证书访问的metrics接口<br>[root@master231 ~]# curl -s --cert /etc/kubernetes/pki/etcd/server.crt  --key /etc/kubernetes/pki/etcd/server.key https://10.0.0.231:2379/metrics -k | <span class="hljs-built_in">tail</span><br><br>3. 创建etcd的service<br>[root@master231 ~]# <span class="hljs-built_in">cat</span> etcd-svc.yaml <br>apiVersion: v1<br>kind: Endpoints<br>metadata:<br>  name: etcd-k8s<br>  namespace:  kube-system<br>subsets:<br>- addresses:<br>  - ip: 10.0.0.231<br>  ports:<br>  - name: https-metrics<br>    port: 2379<br>    protocol: TCP<br><br>---<br><br>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: etcd-k8s<br>  namespace: kube-system<br>  labels:<br>    apps: etcd<br>spec:<br>  ports:<br>  - name: https-metrics<br>    port: 2379<br>    targetPort: 2379<br>  <span class="hljs-built_in">type</span>: ClusterIP<br>  <br>[root@master231 ~]# kubectl apply -f etcd-svc.yaml<br>[root@master231 ~]# kubectl get svc -n kube-system -l apps=etcd<br>NAME       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE<br>etcd-k8s   ClusterIP   10.200.33.157   &lt;none&gt;        2379/TCP   36m<br>[root@master231 ~]# <br>[root@master231 ~]# kubectl -n kube-system describe svc etcd-k8s  | grep Endpoints<br>Endpoints:         10.0.0.231:2379<br><br><br>3.基于创建的svc访问测试连通性<br>[root@master231 ~]# curl -s --cert /etc/kubernetes/pki/etcd/server.crt  --key /etc/kubernetes/pki/etcd/server.key https://10.200.33.157:2379/metrics -k | <span class="hljs-built_in">tail</span> -1 <br>promhttp_metric_handler_requests_total&#123;code=<span class="hljs-string">&quot;503&quot;</span>&#125; 0<br><br>4.创建etcd证书的secrets并挂载到Prometheus server<br>		4.1 查找需要挂载etcd的证书文件路径<br>[root@master231 ~]# egrep <span class="hljs-string">&quot;\--key-file|--cert-file|--trusted-ca-file&quot;</span> /etc/kubernetes/manifests/etcd.yaml   <br>    - --cert-file=/etc/kubernetes/pki/etcd/server.crt<br>    - --key-file=/etc/kubernetes/pki/etcd/server.key<br>    - --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt<br>[root@master231 ~]# <br>	<br>	<br>		4.2 根据etcd的实际存储路径创建secrets<br>[root@master231 ~]# kubectl create secret generic etcd-tls --from-file=/etc/kubernetes/pki/etcd/server.crt --from-file=/etc/kubernetes/pki/etcd/server.key  --from-file=/etc/kubernetes/pki/etcd/ca.crt -n monitoring <br>secret/etcd-tls created<br>[root@master231 ~]# <br>[root@master231 ~]# kubectl -n monitoring get secrets etcd-tls <br>NAME       TYPE     DATA   AGE<br>etcd-tls   Opaque   3      12s<br>[root@master231 ~]# <br><br><br>		4.3 修改Prometheus的资源，修改后会自动重启<br>[root@master231 ~]# kubectl -n monitoring edit prometheus k8s<br>...<br>spec:<br>  secrets:<br>  - etcd-tls<br>  ...  <br>[root@master231 ~]# kubectl -n monitoring get pods -l app.kubernetes.io/component=prometheus -o wide<br>NAME               READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES<br>prometheus-k8s-0   2/2     Running   0          74s   10.100.1.57   worker232   &lt;none&gt;           &lt;none&gt;<br>prometheus-k8s-1   2/2     Running   0          92s   10.100.2.28   worker233   &lt;none&gt;           &lt;none&gt;<br>[root@master231 ~]# <br><br><br>		4.4 查看证书是否挂载成功<br>[root@master231 ~]# kubectl -n monitoring <span class="hljs-built_in">exec</span> prometheus-k8s-0 -c prometheus -- <span class="hljs-built_in">ls</span> -l /etc/prometheus/secrets/etcd-tls<br>total 0<br>lrwxrwxrwx    1 root     2000            13 Jan 24 14:07 ca.crt -&gt; ..data/ca.crt<br>lrwxrwxrwx    1 root     2000            17 Jan 24 14:07 server.crt -&gt; ..data/server.crt<br>lrwxrwxrwx    1 root     2000            17 Jan 24 14:07 server.key -&gt; ..data/server.key<br>[root@master231 ~]# <br>[root@master231 ~]# kubectl -n monitoring <span class="hljs-built_in">exec</span> prometheus-k8s-1 -c prometheus -- <span class="hljs-built_in">ls</span> -l /etc/prometheus/secrets/etcd-tls<br>total 0<br>lrwxrwxrwx    1 root     2000            13 Jan 24 14:07 ca.crt -&gt; ..data/ca.crt<br>lrwxrwxrwx    1 root     2000            17 Jan 24 14:07 server.crt -&gt; ..data/server.crt<br>lrwxrwxrwx    1 root     2000            17 Jan 24 14:07 server.key -&gt; ..data/server.key<br>[root@master231 ~]# <br><br><br>5.创建ServerMonitor<br>		5.1 创建ServiceMonitor资源关联etcd的svc<br>[root@master231 ~]# <span class="hljs-built_in">cat</span>  etcd-smon.yaml <br>apiVersion: monitoring.coreos.com/v1<br>kind: ServiceMonitor<br>metadata:<br>  name: etcd-smon<br>  namespace: monitoring<br>spec:<br>  <span class="hljs-comment"># 指定job的标签，可以不设置。</span><br>  jobLabel: kubeadm-etcd-k8s<br>  <span class="hljs-comment"># 指定监控后端目标的策略</span><br>  endpoints:<br>    <span class="hljs-comment"># 监控数据抓取的时间间隔</span><br>  - interval: 30s<br>    <span class="hljs-comment"># 指定metrics端口，这个port对应Services.spec.ports.name</span><br>    port: https-metrics<br>    <span class="hljs-comment"># Metrics接口路径</span><br>    path: /metrics<br>    <span class="hljs-comment"># Metrics接口的协议</span><br>    scheme: https<br>    <span class="hljs-comment"># 指定用于连接etcd的证书文件</span><br>    tlsConfig:<br>      <span class="hljs-comment"># 指定etcd的CA的证书文件</span><br>      caFile:  /etc/prometheus/secrets/etcd-tls/ca.crt<br>      <span class="hljs-comment"># 指定etcd的证书文件</span><br>      certFile: /etc/prometheus/secrets/etcd-tls/server.crt<br>      <span class="hljs-comment"># 指定etcd的私钥文件</span><br>      keyFile: /etc/prometheus/secrets/etcd-tls/server.key<br>      <span class="hljs-comment"># 关闭证书校验，毕竟咱们是自建的证书，而非官方授权的证书文件。</span><br>      insecureSkipVerify: <span class="hljs-literal">true</span><br>  <span class="hljs-comment"># 监控目标Service所在的命名空间</span><br>  namespaceSelector:<br>    matchNames:<br>    - kube-system<br>  <span class="hljs-comment"># 监控目标Service目标的标签。</span><br>  selector:<br>    <span class="hljs-comment"># 注意，这个标签要和etcd的service的标签保持一致哟</span><br>    matchLabels:<br>      apps: etcd<br>[root@master231 ~]# <br>[root@master231 ~]# kubectl apply -f etcd-smon.yaml <br>servicemonitor.monitoring.coreos.com/etcd-smon created<br>[root@master231 ~]# <br>[root@master231 ~]# kubectl get smon -n monitoring yinzhengjie-etcd-smon <br>NAME                    AGE<br>yinzhengjie-etcd-smon   8s<br>[root@master231 ~]# <br><br><br>5.2.访问Prometheus的WebUI<br>http://10.0.0.233:30090/targets?search=<br><br>	<br>6.查看etcd的数据<br>etcd_cluster_version<br><br>7.使用grafana查看etcd数据<br>http://10.0.0.233:30080/?orgId=1<br>3070<br></code></pre></td></tr></table></figure>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E7%9B%91%E6%8E%A7%E7%AF%87/" class="category-chain-item">监控篇</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E7%9B%91%E6%8E%A7%E7%AF%87/" class="print-no-link">#监控篇</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>prometheus+Grafana+k8s全方位教学</div>
      <div>http://example.com/2025/04/16/prometheus-Grafana-k8s全方位教学/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>淡黄的cherry</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年4月16日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/04/16/%E4%B8%83%E5%B1%82%E5%92%8C%E5%9B%9B%E5%B1%82%E5%8C%BA%E5%88%AB%EF%BC%9F/" title="七层和四层区别？">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">七层和四层区别？</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/04/16/ELFK%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86%E5%AE%9E%E6%88%98/" title="ELFK日志采集实战">
                        <span class="hidden-mobile">ELFK日志采集实战</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  <div>
    <span id="timeDate">正在载入天数...</span>
    <span id="times">载入时分秒...</span>
    <script>
    var now = new Date();
    function createtime(){
        var grt= new Date("08/17/2020 00:00:00");
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24;
        dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum);
        hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){
            hnum = "0" + hnum;
        }
        minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes);
        if(String(mnum).length ==1 ){
                  mnum = "0" + mnum;
        }
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds);
        if(String(snum).length ==1 ){
                  snum = "0" + snum;
        }
        document.getElementById("timeDate").innerHTML = "🚀已持续航行&nbsp"+dnum+"&nbsp天";  
        document.getElementById("times").innerHTML = hnum + "&nbsp时&nbsp" + mnum + "&nbsp分&nbsp" + snum + "&nbsp秒";
    }
    setInterval("createtime()",250);
    </script>
  </div>
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/js/custom.js"></script>
<script src="/js/snow.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
